{% extends "layout.html" %} {% block title %}{% endblock %} {% block head %}

<script type="text/javascript" charset="utf-8">
	var data_dependencies = [
		'all_languages',
		'language',
		'exporter_list',
	];

	$(document).ready(function () {
		var heartbeatCounter = 0;

		// set admin flag
		rotorhazard.admin = true;
		rotorhazard.saveData();
		$('nav li').removeClass('admin-hide');

		socket.on('exporter_list', function (msg) {
			$('#exporter_list').empty();
			if ('exporters' in msg && msg.exporters.length) {
				msg.exporters.sort(function(a, b){return ('' + a.label).localeCompare(b.label)})
				for (idx in msg.exporters) {
					var ex = msg.exporters[idx];
					$('#exporter_list').append('<option value="' + ex.name + '">' + __(ex.label) + '</option>');
				}
				$('#exporter_list').prop('disabled', false);
				$('#export_database').prop('disabled', false);
			} else {
				$('#exporter_list').append('<option value="-">' + __('No Exporters') + '</option>');
				$('#exporter_list').prop('disabled', true);
				$('#export_database').prop('disabled', true);
			}
		});







		function calculateRoundPoints(raceResults){
		        var SLRounds = {};
		        var raceClasses = raceResults["classes"];
						for (var key in raceClasses) {
							var roundNumber = raceClasses[key];
							var pilotHeats = roundNumber['leaderboard']['by_race_time'];
							var points = pilotHeats.length;
							SLRounds[key] = [];
							for(var pilotHeatKey in pilotHeats){
								var pilotHeat = pilotHeats[pilotHeatKey];
								var callsign = pilotHeat['callsign'];
								var heatTime = pilotHeat['total_time_raw'];
								var laps = pilotHeat['laps'];
								var pilotID = pilotHeat['pilot_id'];
								SLRounds[key].push({"callsign":String(callsign),"points":String(points),"laps":String(laps),"heatTime":String(heatTime)});
								console.log(SLRounds[key][SLRounds[key].length-1]);
								points -= 1;
							}
						}
						console.log("SL Rounds");
						//CAN'T FIGURE OUT HOW TO DO JAVASCRIPT JSON SHIT....
						console.log(JSON.stringify(SLRounds, null, 4));
		        return SLRounds;
		}

		function getPilotPointsByRound(rounds){
			var pilotPoints = {}
	    //create a list of pilots containing the points they earned in each round
			for (var roundKey in rounds) {
				var round = rounds[roundKey];
				for (var i = 0; i < round.length; i++) {
					var pilotHeat = round[i];
					var callsign = pilotHeat['callsign'];
					var pilotRoundPoints = Number(pilotHeat['points']);
					if(callsign in pilotPoints){
						pilotPoints[callsign].push({'points':pilotRoundPoints});
					}else{
						pilotPoints[callsign] = [{'points':pilotRoundPoints}];
					}
				}
			}

			console.log("Pilot Round Points");
			console.log(pilotPoints);
			return pilotPoints;
		}

		function getPilotTotalsFromRounds(pilotPoints){
			//create a list of pilots and their total points
			var pilotTotalPoints = [];
			for (var callsign in pilotPoints) {
				var pilotPointsRounds = pilotPoints[callsign];
				var totalPoints = 0;
				for (var i = 0; i < pilotPointsRounds.length; i++) {
					totalPoints += pilotPointsRounds[i]['points'];
				}
				var pilotJSON = {'callsign': callsign, "points": Number(totalPoints)};
				pilotTotalPoints.push(pilotJSON);
			}

			//sort the list
			pilotTotalPoints.sort((a,b) => b.points - a.points);
			console.log("sorted pilot total points");
			console.log(pilotTotalPoints);
	    return pilotTotalPoints;
		}

		function slformat(raceResults){
		        var rounds = calculateRoundPoints(raceResults);
						var pilotPointsByRound = getPilotPointsByRound(rounds);
						var pilotTotalPoints = getPilotTotalsFromRounds(pilotPointsByRound);
						createSLTable(pilotPointsByRound, pilotTotalPoints);
		}

		function getPilotTotal(callsign, raceData){
			for (var i = 0; i < raceData.length; i++) {
				var pilotData = raceData[i];
				if(pilotData['callsign'].localeCompare(callsign)==0){
					return pilotData;
				}
			}
		}

		function createSLTable(roundData, raceData){
			console.log("createSLTable");
			console.log(roundData);
			var headers = ["Round 1", "Round 2", "Round 3", "Round 4", "Round 5", "Round 6"];
			var table = document.getElementsByClassName('scoreTable')[0];
			var headerRow = document.createElement("tr");
			for (var rowIndex = -2; rowIndex < roundData[raceData[0]['callsign']].length+1; rowIndex++) {
				if(rowIndex==-2){
					var cell = document.createElement("th");
					cell.innerHTML = "Rank";
					headerRow.appendChild(cell);
				}else if(rowIndex==-1){
					var cell = document.createElement("th");
					cell.innerHTML = "Pilot";
					headerRow.appendChild(cell);
				}else if(rowIndex==roundData[raceData[0]['callsign']].length){
					var cell = document.createElement("th");
					cell.innerHTML = "Total";
					headerRow.appendChild(cell);
				}else{
					var cell = document.createElement("th");
					cell.innerHTML = "Round "+(rowIndex+1);
					headerRow.appendChild(cell);
				}
			}
			table.appendChild(headerRow);
			var rank = 1;
			for(var callsign in roundData){
				var row = document.createElement("tr");
				console.log("callsign is "+callsign);
				for (var rowIndex = -2; rowIndex < roundData[callsign].length+1; rowIndex++) {
					var roundNumber = rowIndex;
					if(rowIndex==-2){
						cell = document.createElement("td");
						cell.innerHTML = "#"+rank;
						row.appendChild(cell);
						rank+=1;
					}else if(roundNumber<0){
						cell = document.createElement("td");
						console.log("callsign is "+callsign);
						cell.innerHTML = callsign;
						row.appendChild(cell);
					}else if(roundNumber==roundData[callsign].length){
						cell = document.createElement("td");
						console.log("total points");
						cell.innerHTML = getPilotTotal(callsign,raceData)['points'];
						row.appendChild(cell);
					}else{
						console.log("round number is "+roundNumber);
						cell = document.createElement("td");
						console.log(roundData[callsign][roundNumber]);
						cell.innerHTML = roundData[callsign][roundNumber]['points'];
						row.appendChild(cell);
					}
				}
				table.appendChild(row);

			}
		}

		socket.on('exported_data', function (msg) {
			var data = msg.data
			/*
			msgArray = atob(msg.file_data);  // decode Base64 string
			// convert decoded data to byte array
			var byteNumbers = new Array(msgArray.length);
			for (var i = 0; i < msgArray.length; i++) {
				byteNumbers[i] = msgArray.charCodeAt(i);
			}
			var byteArray = new Uint8Array(byteNumbers);
			*/
			// construct blob and initiate browser save-as
			//console.log(data);
			slFormatData = slformat(JSON.parse(data));
			//createSLTable(slFormatData);
			//saveAs(new Blob([data], {type: msg.encoding}), msg.filename);
		});

		var exportData = {exporter: 'json_complete_results'};
		socket.emit('export_database', exportData);

		$('button#export_database').click(function (event) {
			var data = {
				exporter: $('#exporter_list').val()
			};
			socket.emit('export_database', data);
			return false;
		});
	});

</script>
{% endblock %} {% block content %}
<table class="scoreTable" style="overflow: hidden;">

</table>
{% endblock %}
