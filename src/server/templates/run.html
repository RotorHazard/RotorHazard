{% extends "layout.html" %} {% block title %}{{ __('Run') }}{% endblock %}{% block head %}
<script type="text/javascript" src="./static/Blob.js"></script>
<script type="text/javascript" src="./static/FileSaver.min.js"></script>
<script type="text/javascript" src="{{ url_for('static', filename='showdown-1.9.1/showdown.min.js') }}"></script>

<script type="text/javascript" charset="utf-8">
	var data_dependencies = [
		'all_languages',
		'language',
		{
			'type': 'ui',
			'value': 'run'
		},
		'node_data',
		'frequency_data',
		'pilot_data',
		'heat_list',
		'class_data',
		'format_data',
		'node_tuning',
		'enter_and_exit_at_levels',
		'min_lap',
		'leaderboard',
		'current_laps',
		'race_status',
		'led_effects',
		'callouts',
		'environmental_data',
		'cluster_status',
		'vrx_list'
	];

	var volume_logsl = new LogSlider({maxpos: 100, minval: MIN_LOG_VOLUME, maxval: MAX_LOG_VOLUME});
	var brightness_logsl = new LogSlider({maxpos: 25, minval: 5, maxval: 255});

	var request_time;
	var request_pi_time;
	var resume_check = true;

	function race_kickoff(msg) {
		rotorhazard.timer.stopAll();

		var staging_start_pi = (msg.pi_staging_at_s * 1000); // convert seconds (pi) to millis (JS)
		var race_start_pi = (msg.pi_starts_at_s * 1000); // convert seconds (pi) to millis (JS)

		rotorhazard.timer.race.hidden_staging = Boolean(msg.hide_stage_timer);
		rotorhazard.timer.race.count_up = Boolean(msg.unlimited_time);
		rotorhazard.timer.race.duration_tenths = msg.race_time_sec * 10;

		rotorhazard.timer.race.staging_tones = msg.staging_tones;

		rotorhazard.timer.race.start(race_start_pi, staging_start_pi);

		rotorhazard.winner_declared_flag = false;
	}

	$(document).ready(function () {
		// get pi time
		rotorhazard.pi_time_request = window.performance.now();
		socket.emit('get_pi_time');

		$('#about>.popup-content').append('<p id="server-lag">Sync quality: [calculating]</p>');

		socket.on('pi_time', function (msg) {
			var max_samples = 10;
			var response_time = window.performance.now();
			var server_delay = response_time - rotorhazard.pi_time_request;
			var server_oneway = server_delay ? server_delay / 2 : server_delay;

			var server_time_differential = {
				'differential': (msg.pi_time_s * 1000) - response_time - server_oneway, // convert seconds (pi) to millis (JS)
				'response': parseFloat(server_delay)
			}

			// store sync sample
			rotorhazard.server_time_differential_samples.push(server_time_differential);

			// sort stored samples
			rotorhazard.server_time_differential_samples.sort(function(a, b){
				return a.response - b.response;
			})

			// remove unusable samples
			var diff_min = rotorhazard.server_time_differential_samples[0].differential - rotorhazard.server_time_differential_samples[0].response
			var diff_max = rotorhazard.server_time_differential_samples[0].differential + rotorhazard.server_time_differential_samples[0].response

			rotorhazard.server_time_differential_samples = rotorhazard.server_time_differential_samples.filter(function(value, index, array) {
				return value.differential >= diff_min && value.differential <= diff_max;
			});

			// get filtered value
			var a = [];
			for (var i in rotorhazard.server_time_differential_samples) {
				a.push(rotorhazard.server_time_differential_samples[i].differential);
			}
			rotorhazard.server_time_differential = median(a);

			// pass current sync to timers
			rotorhazard.timer.race.sync();
			rotorhazard.timer.deferred.sync();

			// continue sampling for sync to improve accuracy
			if (rotorhazard.server_time_differential_samples.length < max_samples) {
				setTimeout(function(){
					rotorhazard.pi_time_request = window.performance.now();
					socket.emit('get_pi_time');
				}, (Math.random() * 500) + 250); // 0.25 to 0.75s delay
			}

			// update server info
			var a = Infinity;
			for (var i in rotorhazard.server_time_differential_samples) {
				a = Math.min(a, rotorhazard.server_time_differential_samples[i].response);
			}
			rotorhazard.sync_within = Math.ceil(a);

			$('#server-lag').html('<p>Sync quality: within ' + rotorhazard.sync_within + 'ms (' + rotorhazard.server_time_differential_samples.length + '/' + max_samples + ' samples)</p>');

			if (
				(max_samples >= 10 && SYNC_WARNING_THRESHOLD_10 > rotorhazard.sync_within) ||
				(max_samples >= 3 && SYNC_WARNING_THRESHOLD_3 > rotorhazard.sync_within) ||
				SYNC_WARNING_THRESHOLD_1 > rotorhazard.sync_within) {
				rotorhazard.has_server_sync = true;
				if (!rotorhazard.timer.running()) {
					$('.timing-clock .warning').hide();
				}
			} else {
				$('.timing-clock .warning .value').text(rotorhazard.sync_within + 'ms');
			}
		});

		socket.on('language', function (msg) {
			$('#set_language').empty();
			$('#set_language').append('<option value="">English</option>')
			for (i = 0; i < msg.languages.length; i++) {
				$('#set_language').append('<option value="' + msg.languages[i].id +'">' + msg.languages[i].name + '</option>')
			}

			$('#set_voice_string_language').empty();
			$('#set_voice_string_language').append('<option value="match-timer">' + __('(Match Timer Language)') + '</option>')
			$('#set_voice_string_language').append('<option value="">English</option>')
			for (i = 0; i < msg.languages.length; i++) {
				$('#set_voice_string_language').append('<option value="' + msg.languages[i].id +'">' + msg.languages[i].name + '</option>')
			}
			$('#set_voice_string_language').val(rotorhazard.voice_string_language);

			if (msg.language) {
				rotorhazard.interface_language = msg.language;
				$('#set_language').val(msg.language);
			} else {
				$('#set_language').selectedIndex = 0;
			}
		});

		var heartbeatCounter = 0;
		var current_laps = {};
		var current_laps_reversed = false;

		// set admin flag
		rotorhazard.admin = true;
		rotorhazard.saveData();
		$('nav li').removeClass('admin-hide');

		// populate controls
		var populate_audio_settings = function() {
			$('#voice_callsign').val(rotorhazard.voice_callsign);
			$('#voice_lap_count').val(rotorhazard.voice_lap_count);
			$('#voice_team_lap_count').val(rotorhazard.voice_team_lap_count);
			$('#voice_lap_time').val(rotorhazard.voice_lap_time);
			$('#voice_race_timer').val(rotorhazard.voice_race_timer);
			$('#voice_race_winner').val(rotorhazard.voice_race_winner);
			$('#voice_if_node_finished').val(rotorhazard.voice_if_node_finished);
			$('#voice_split_timer').val(rotorhazard.voice_split_timer);
			$('#voice_race_leader').val(rotorhazard.voice_race_leader);
			$().articulate('volume', rotorhazard.voice_volume);
			$('#set_voice_volume').val(volume_logsl.position(rotorhazard.voice_volume));
			$('#voice_volume_value').html($('#set_voice_volume').val());
			$().articulate('rate', rotorhazard.voice_rate);
			$('#voice_rate_value').html(rotorhazard.voice_rate.toFixed(2));
			$('#set_voice_rate').val(rotorhazard.voice_rate);
			$().articulate('pitch', rotorhazard.voice_pitch);
			$('#voice_pitch_value').html(rotorhazard.voice_pitch.toFixed(2));
			$('#set_voice_pitch').val(rotorhazard.voice_pitch);
			$('#set_tone_volume').val(volume_logsl.position(rotorhazard.tone_volume));
			$('#tone_volume_value').html($('#set_tone_volume').val());
			$('#beep_crossing_entered').prop("checked", rotorhazard.beep_crossing_entered);
			$('#beep_crossing_exited').prop("checked", rotorhazard.beep_crossing_exited);
			$('#beep_manual_lap_button').prop("checked", rotorhazard.beep_manual_lap_button);
			$('#beep_race_leader_lap').prop("checked", rotorhazard.beep_race_leader_lap);
			$('#beep_race_winner_declared').prop("checked", rotorhazard.beep_race_winner_declared);
			$('#beep_cluster_connect').prop("checked", rotorhazard.beep_cluster_connect);
			$('#use_mp3_tones').prop("checked", rotorhazard.use_mp3_tones);
			$('#beep_on_first_pass_button').prop("checked", rotorhazard.beep_on_first_pass_button);
			$('#set_indicator_volume').val(volume_logsl.position(rotorhazard.indicator_beep_volume));
			$('#indicator_volume_value').html($('#set_indicator_volume').val());
			$('#set_voice_string_language').val(rotorhazard.voice_string_language);
			if (!rotorhazard.voice_language) {  // if no current default then select first English voice
				rotorhazard.voice_language = get_default_articulate_voice();
				rotorhazard.saveData();
				if ($('#set_voice_language').children('option').length > 0) {
					$('#set_voice_language').val(rotorhazard.voice_language);
				}
			} else {
				if ($('#set_voice_language').children('option').length > 0) {
					$('#set_voice_language').val(rotorhazard.voice_language);
					if (!($('#set_voice_language').val())) {  // if no match then select first English voice
						rotorhazard.voice_language = get_default_articulate_voice();
						rotorhazard.saveData();
						$('#set_voice_language').val(rotorhazard.voice_language);
					}
				}
			}
		};
		populate_audio_settings();

		$('#schedule_m').val(rotorhazard.schedule_m);
		$('#schedule_s').val(rotorhazard.schedule_s);
		$('#hide_graphs').prop("checked", !rotorhazard.hide_graphs);
		$('#display_lap_id').prop("checked", rotorhazard.display_lap_id);
		$('#display_time_start').prop("checked", rotorhazard.display_time_start);
		$('#display_time_first_pass').prop("checked", rotorhazard.display_time_first_pass);
		$('#display_laps_reversed').prop("checked", rotorhazard.display_laps_reversed);

		if ('{{ getConfig('LED', 'ledBrightness') }}' != 'False') {
			$('#set_led_brightness').val(brightness_logsl.position( {{ getConfig('LED', 'ledBrightness') }} ));
			$('#led_brightness_value').html($('#set_led_brightness').val());
		}

		// set up node local store
		for (i = 0; i < {{ num_nodes }}; i++) {
			rotorhazard.nodes[i] = new nodeModel();
			// start RSSI graphing
			var canvas = document.getElementById('rssi-graph-' + i);
			if (canvas) {
				rotorhazard.nodes[i].canvas = canvas;
				rotorhazard.nodes[i].setup(rotorhazard.nodes[i].canvas);
				if (rotorhazard.hide_graphs) {
					rotorhazard.nodes[i].graph.stop();
				}
			}
		}
		if (rotorhazard.hide_graphs) {
			$('.rssi-graph').prop('hidden', true);
		}

		// set up markdown converter
		var panel_converter = new showdown.Converter({
			ghCodeBlocks: true,
			ghCompatibleHeaderId: true,
			literalMidWordUnderscores: true,
			simpleLineBreaks: true,
			headerLevelStart: 3
		});

		socket.on('ui', function (msg) {
			if (msg.page == 'run') {
				$('#custom-ui').empty();

				for (var i in msg.panels) {
					var panel = msg.panels[i];

					var panel_el = $('<div class="panel collapsing active">');
					panel_el.attr('id', 'ui-custom-' + panel.panel.name);
					var panel_header_el = $('<div class="panel-header">');
					panel_header_el.append('<h2><button class="no-style">' + panel.panel.label + '</button></h2>');
					var panel_content_el = $('<div class="panel-content">');

					// panel open/close
					if (panel.panel.open) {
						panel_el.addClass('open');
						panel_content_el.show();
					} else {
						panel_el.removeClass('open');
						panel_content_el.hide();
					}

					// add markdown content
					for (var md_idx in panel.markdowns) {
						md_content = panel.markdowns[md_idx].desc;
						md_output = panel_converter.makeHtml(md_content);
						md_element = $('<div class="ui-md-el">').html(md_output);
						panel_content_el.append(md_element);
					}

					var form_el = $('<ol class="form">');

					for (var f_idx in panel.settings) {
						var settings = { ...panel.settings[f_idx] };

						settings.wrapperEl = 'li';
						settings.fieldClass = 'set_ui_option';
						settings.id = 'genericOption_' + settings.name;
						settings.data = {
							field: settings.name,
						}

						var field = rhui.buildField(settings);

						form_el.append(field);
					}
					panel_content_el.append(form_el);
					panel_content_el.append(rhui.buildQuickbuttons(panel.quickbuttons));

					panel_el.append(panel_header_el);
					panel_el.append(panel_content_el);

					$('#custom-ui').append(panel_el);
				}

				// load panel state
				for (var panel in rotorhazard.panelstates) {
					var panel_obj = $('#' + panel);
					var panelstate = rotorhazard.panelstates[panel];

					if (panelstate) {
						panel_obj.addClass('open');
						panel_obj.children('.panel-content').stop().slideDown();
					} else {
						panel_obj.removeClass('open');
						panel_obj.children('.panel-content').stop().slideUp();
					}
				}
			}
		});

		$(document).on('change', '.set_ui_option', function (event) {
			var field = $(this).data('field');
			var section = $(this).data('section');
			var value = rhui.getFieldVal(this);

			if (section) {
				var data = {
					section: section,
					key: field,
					value: value
				};
				socket.emit('set_config', data);
			} else {
				var data = {
					option: field,
					value: value
				};
				socket.emit('set_option', data);
			}
		});

		function any_laps_recorded() {
			if (current_laps && 'node_index' in current_laps) {
				for (var node_i in current_laps.node_index) {
					if ('laps' in current_laps.node_index[node_i] &&
							current_laps.node_index[node_i].laps.length > 0) {
						return true;
					}
				}
			}
			return false;
		}

		socket.on('race_scheduled', function (msg) {
			if (msg.scheduled) {
				var deferred_start = msg.scheduled_at * 1000;  // convert seconds (pi) to millis (JS)
				rotorhazard.timer.deferred.start(deferred_start, null);
			} else {
				rotorhazard.timer.deferred.stop();
			}
		});

		socket.on('race_status', function (msg) {
			rotorhazard.event.race_status = msg;

			rotorhazard.timer.race.count_up = Boolean(msg.unlimited_time);
			rotorhazard.timer.race.duration_tenths = msg.race_time_sec * 10;
			rotorhazard.timer.race.staging_tones = msg.staging_tones;

			$('#next-round').text(__("Round") + " " + msg.next_round);

			switch (msg.race_status) {
				case 1: // Race running
					rotorhazard.race_status_go_time = window.performance.now();
					$('#set_current_heat').prop('disabled', true);
					$('button#start_race').prop('disabled', true);
					$('button#stop_race').prop('disabled', false);
					$('button#save_laps').prop('disabled', false);
					$('button#discard_laps').prop('disabled', true);
					$('button.simulate_lap').prop('disabled', false);
					$('button#schedule_race').prop('disabled', true);
					$('body').addClass('race-running');
					$('body').removeClass('race-stopped');
					$('body').removeClass('race-new');
					$('.timing-clock').removeClass('staging');
					if (msg.show_init_time_flag) {
						rotorhazard.timer.deferred.initial_disp_tenths = null;
						rotorhazard.timer.race.initial_disp_tenths = null;
					}
					if (resume_check) {
						race_kickoff(msg);
					}
					break;
				case 2: // Race stopped, clear or save laps
					$('#set_current_heat').prop('disabled', true);
					if (any_laps_recorded()) {
						$('button#start_race').prop('disabled', true);
					}
					else {  // if no laps then allow restart (without save/discard)
						$('button#start_race').prop('disabled', false);
					}
					$('button#stop_race').prop('disabled', true);
					$('button#save_laps').prop('disabled', false);
					$('button#discard_laps').prop('disabled', false)
					$('button.simulate_lap').prop('disabled', true);
					$('button#schedule_race').prop('disabled', true);
					$('body').removeClass('race-running');
					$('body').addClass('race-stopped');
					$('body').removeClass('race-new');
					$('.timing-clock').removeClass('staging');
					break;
				case 3: // staging
					$('#set_current_heat').prop('disabled', true);
					$('button#start_race').prop('disabled', true);
					$('button#stop_race').prop('disabled', false);
					$('button#save_laps').prop('disabled', true);
					$('button#discard_laps').prop('disabled', true);
					$('button.simulate_lap').prop('disabled', true);
					$('button#schedule_race').prop('disabled', true);
					$('body').addClass('race-running');
					$('body').removeClass('race-stopped');
					$('body').removeClass('race-new');
					$('.timing-clock').addClass('staging');
					if (resume_check) {
						race_kickoff(msg);
					}
					break;
				default: // Waiting to start new race
					$('#set_current_heat').prop('disabled', false);
					$('button#start_race').prop('disabled', false);
					$('button#stop_race').prop('disabled', true);
					$('button#save_laps').prop('disabled', true);
					$('button#discard_laps').prop('disabled', true);
					$('button.simulate_lap').prop('disabled', true);
					$('button#schedule_race').prop('disabled', false);
					$('body').removeClass('race-running');
					$('body').removeClass('race-stopped');
					$('body').addClass('race-new');
					$('.timing-clock').removeClass('staging');
					rotorhazard.timer.race.stop();
					if (msg.show_init_time_flag) {
						if (!any_laps_recorded()) {
							rotorhazard.timer.deferred.initial_disp_tenths = rotorhazard.timer.race.duration_tenths;
							rotorhazard.timer.race.initial_disp_tenths = rotorhazard.timer.race.duration_tenths;
						}
					} else {
						rotorhazard.timer.deferred.initial_disp_tenths = null;
						rotorhazard.timer.race.initial_disp_tenths = null;
					}
					rotorhazard.timer.deferred.renderHTMLandUpdate();
					if (resume_check) {
						socket.emit('get_race_scheduled');
					}
					break;
			}

			resume_check = false;
			update_race_formats();
			show_current_laps();
		});

		socket.on('heartbeat', function (msg) {
			if (speakObjsQueue.length > 0) {
				var isSpeakingFlag = $().articulate('isSpeaking');
				if (checkSpeakQueueFlag) {
					if (!isSpeakingFlag) {
						var obj = speakObjsQueue.shift();
						if (speakObjsQueue.length > 0)    //if more items in queue then
							checkSpeakQueueFlag = false;  //don't check again until speaking begins
							checkSpeakQueueCntr = 10;     //set timeout counter to make sure the wait is not indefinite
						if (!doSpeak(obj)) {                  //if speaking not triggered then
							checkSpeakQueueFlag = true;       //don't wait for it
						}
					}
				}  //make sure previous speak has started before checking queue again (up to timeout)
				else if (isSpeakingFlag || --checkSpeakQueueCntr <= 0) {
					checkSpeakQueueFlag = true;
					checkSpeakQueueCntr = 0;
				}
			}

			if (++heartbeatCounter >= 2) {   //do these updates less often than speak-queue checks
				heartbeatCounter = 0;

				for (i = 0; i < msg.current_rssi.length; i++) {
					if(document.getElementById('node-' + i)) {
						var rssiValue = msg.current_rssi[i];

						if (rotorhazard.nodes[i].fObj.frequency == 0) {
							rssiValue = 0;
						}

						$('.current_rssi_' + i).html(rssiValue);

						if (msg.crossing_flag[i]) {
							$('.crossing_flag_' + i).addClass('is-crossing').html(__('Crossing'));
						}
						else {
							$('.crossing_flag_' + i).removeClass('is-crossing').html(__('Clear'));
						}

						rotorhazard.nodes[i].graph.options.maxValue = Math.max(
							rssiValue,
							rotorhazard.nodes[i].node_peak_rssi + 1,
							rotorhazard.nodes[i].enter_at_level + 10,
						);

						rotorhazard.nodes[i].graph.options.minValue = Math.max(0, Math.min(
							rssiValue,
							rotorhazard.nodes[i].node_nadir_rssi - 1,
							rotorhazard.nodes[i].exit_at_level - 10,
						));

						if (!rotorhazard.nodes[i].graphing && rssiValue) {
							rotorhazard.nodes[i].graphing = true;
							rotorhazard.nodes[i].graph.options.maxValue = rssiValue + 100;
							rotorhazard.nodes[i].graph.options.minValue = Math.max(0, rssiValue - 10);
						}

						if (rotorhazard.nodes[i].graphing) {
							rotorhazard.nodes[i].series.append(new Date().getTime(), rssiValue);
							if (msg.crossing_flag[i]) {
								rotorhazard.nodes[i].crossingSeries.append(new Date().getTime(), 500);
							} else{
								rotorhazard.nodes[i].crossingSeries.append(new Date().getTime(), -10);
							}
						}
					}
				}
			}
		});

		socket.on('frequency_data', function (msg) {
			if (msg.fdata.length) {
				for (var i in msg.fdata) {
					var fObj = freq.getFObjbyFData(msg.fdata[i]);
					rotorhazard.nodes[i].fObj = fObj;
					$('#s_channel_' + i).val(fObj.frequency);
					$('#f_table_' + i).val(fObj.fString);
					freq.updateBlock(fObj, i);
				}
			}
		});

		socket.on('heat_list', function (msg) {
			rotorhazard.event.heats = msg.heats;
			display_heats();
		});

		socket.on('heat_data', function (msg) {
			rotorhazard.event.heats = msg.heats;
			display_heats();
		});

		socket.on('class_data', function (msg) {
			rotorhazard.event.classes = msg.classes;
			display_heats();
		});

		function display_heats() {
			if (rotorhazard.event.heats && rotorhazard.event.classes) {
				$('#set_current_heat').empty();

				var opt = $('<option value="0">');
				opt.html(__('Practice Mode'));
				$('#set_current_heat').append(opt);

				// assemble heats by class
				var heats_by_class = {}
				var single_class = true;
				for (var h in rotorhazard.event.heats) {
					var heat = rotorhazard.event.heats[h];
					if (heat.active) {
						if (!(heat.class_id in heats_by_class)) {
							heats_by_class[heat.class_id] = [];
						}
						heats_by_class[heat.class_id].push(heat)
						if (heat.class_id != 0) {
							single_class = false;
						}
					}
				}

				// assemble optgroups
				if (single_class) {
					for (var h in rotorhazard.event.heats) {
						var heat = rotorhazard.event.heats[h];
						if (heat.active) {
							var opt = $('<option value="' + heat.id + '" data-class="' + heat.class_id + '">');
							opt.html(heat.displayname);
							$('#set_current_heat').append(opt);
						}
					}
				} else {
					for (var c in heats_by_class) {
						var heat_list = heats_by_class[c]
						var optgroup = $('<optgroup>');

						optgroup.attr('label', __('Unclassified'));
						optgroup.attr('data-id', 0);
						for (var rc in rotorhazard.event.classes) {
							if (c == rotorhazard.event.classes[rc].id) {
								var class_data = rotorhazard.event.classes[rc]
								optgroup.attr('label', class_data.displayname);
								optgroup.attr('data-id', class_data.id);
								break;
							}
						}

						for (var h in heat_list) {
							var heat = heat_list[h];

							var opt = $('<option value="' + heat.id + '" data-class="' + heat.class_id + '">');

							opt.html(heat.displayname);
							optgroup.append(opt)
						}
						$('#set_current_heat').append(optgroup);
					}

					// move unclassified to end of list
					$('#set_current_heat').append($('#set_current_heat optgroup[data-id="0"]'));
				}

				socket.emit('load_data', {'load_types': [
					'current_heat',
				]});
			}
		}

		socket.on('heat_plan_result', function (msg) {
			display_race_plan_result(msg);
			// TODO: store data locally; wait for rotorhazard.event.heats population
		});

		function display_race_plan_result(msg) {
			var plan_dialog_el = $('<div class="heat-plan-result popup">');
			plan_dialog_el.append('<h2>' + __('Heat Plan') + ': ' + msg.displayname + '</h2>');
			var message_content = $('<div class="popup-content dialog-content">');
			plan_dialog_el.append(message_content);

			if (msg.calc_result.calc_success == false) {
				var message_el = $('<div class="notice warning">');
				message_el.append('&#9888;&#xFE0E; ' + __("Heat plan is invalid"));
				message_content.append(message_el);
			} else if (msg.calc_result.unassigned_slots > 0) {
				var message_el = $('<div class="notice">');
				message_el.append('&#9888;&#xFE0E; ' + __("Heat contains empty slots"));
				message_content.append(message_el);
			}

			var heat_el = $('<div class="heat-plan">');
			var nodelist = $('<table>');
			for (idx in msg.slots) {
				var slot = msg.slots[idx];
				var slot_el = $('<tr>');

				if (slot.method == 0 && slot.pilot_id ||
					slot.method > 0 && slot.seed_id) {
					var method_text = get_method_descriptor(slot.method, slot.seed_id, slot.seed_rank)
					slot_el.append('<td class="method">' + method_text + '</td>');

					if (Number.isInteger(slot.node_index)) {
						if (slot.frequency_change) {
							slot_el.addClass('freq-change');
							slot_el.append('<td class="calc_to">&#x25c8;<span class="screen-reader-text">' + __('frequency change') + '</span></td>');
						} else {
							slot_el.append('<td class="calc_to">&#x2192;</td>');
						}

						slot_el.append('<td class="channel"><div class="channel-block" data-node="' + slot.node_index + '"><span class="ch"></span> <span class="fr"></span></div></td>');
					} else {
						slot_el.addClass('no-freq');
						slot_el.append('<td class="calc_to">&#x00D7;</td>');
						slot_el.append('<td class="channel"><div class="channel-block"><span class="ch">â€”</span> <span class="fr">None</span></div></td>');
					}

					if (slot.pilot_id) {
						/*
						// rotorhazard.event.pilots not currently requested
						var pilot = rotorhazard.event.pilots.find(obj => {return obj.pilot_id == slot.pilot_id});
						*/
						var pilot = slot.callsign;

						if (pilot) {
							// var callsign = pilot.callsign;
							var callsign = pilot;
						} else {
							var callsign = "(" + __("Pilot") + " " + slot.pilot_id + ")"
						}
						slot_el.append('<td class="pilot-name">' + callsign + '</td>');
					} else {
						slot_el.addClass('no-pilot');
						slot_el.append('<td class="pilot-name">' + __('(None)') + '</td>');
					}

					nodelist.append(slot_el);
				}
			}
			heat_el.append(nodelist);

			message_content.append(heat_el);

			var actions_el = $('<div class="dialog-actions">');
			actions_el.append('<a href="/format#classes_and_heats">' + __('Modify Plans') + '</a>');
			actions_el.append('<button class="cancel">' + __('Cancel') + '</button>');
			actions_el.append('<button class="btn-danger confirm-heat-plan" data-heat_id="' + msg.heat + '">' + __('Confirm') + '</button>');
			message_content.append(actions_el);

			$.magnificPopup.open({
				items: {
					src: plan_dialog_el,
					type: 'inline',
				},
				callbacks: {
					open: function(){
						$('#set_current_heat').val(rotorhazard.current_heat);
					}
				}
			});

			freq.updateBlocks();
		}

		$(document).on("click", '.confirm-heat-plan', function (event) {
			$.magnificPopup.close();
			var data = {
				heat_id: parseInt($(this).data('heat_id')),
			};
			socket.emit('confirm_heat_plan', data);
		});

		function get_method_descriptor (method, seed, rank) {
			if (method == 0) { // pilot
				return __("Pilot");
			} else if (method == 1) { // heat
				var heat = rotorhazard.event.heats.find(obj => {return obj.id == seed});

				if (heat) {
					if (rank) {
						return heat.displayname + " " + __('Rank') + " " + rank;
					} else {
						return heat.displayname + " -" + __('Undefined Rank') + "-";
					}
				} else {
					return '(' + __('Deleted Heat') + ')';
				}
			} else if (method == 2) { // class
				var race_class = rotorhazard.event.classes.find(obj => {return obj.id == seed});

				if (race_class) {
					if (rank) {
						return race_class.displayname + " " + __('Rank') + " " + rank;
					} else {
						return race_class.displayname + " -" + __('Undefined Rank') + "-";
					}
				} else {
					return '(' + __('Deleted Class') + ')';
				}
			}
			return '(' + __('Undefined') + ')';
		}

		socket.on('node_data', function (msg) {
			for (i = 0; i < msg.node_peak_rssi.length; i++) {
				$('.node_peak_rssi_' + i).html(msg.node_peak_rssi[i]);
				$('.node_nadir_rssi_' + i).html(msg.node_nadir_rssi[i]);
				$('.pass_peak_rssi_' + i).html(msg.pass_peak_rssi[i]);
				$('.pass_nadir_rssi_' + i).html(msg.pass_nadir_rssi[i]);
				$('.debug_pass_count_' + i).html(msg.debug_pass_count[i]);

				rotorhazard.nodes[i].node_peak_rssi = msg.node_peak_rssi[i];
				rotorhazard.nodes[i].node_nadir_rssi = msg.node_nadir_rssi[i];
				rotorhazard.nodes[i].pass_peak_rssi = msg.pass_peak_rssi[i];
				rotorhazard.nodes[i].pass_nadir_rssi = msg.pass_nadir_rssi[i];

				$('#node_notice_' + i).html(rotorhazard.nodes[i].checkValues());
				rotorhazard.nodes[i].updateThresholds();
			}
		});

		socket.on('enter_and_exit_at_levels', function (msg) {
			for (i = 0; i < msg.enter_at_levels.length; i++) {
				$('#set_enter_at_level_' + i).val(msg.enter_at_levels[i]);
				rotorhazard.nodes[i].enter_at_level = msg.enter_at_levels[i];
				$('#set_exit_at_level_' + i).val(msg.exit_at_levels[i]);
				rotorhazard.nodes[i].exit_at_level = msg.exit_at_levels[i];

				$('#node_notice_' + i).html(rotorhazard.nodes[i].checkValues());
				rotorhazard.nodes[i].updateThresholds();
			}
		});

		socket.on('node_enter_at_level', function (msg) {
			$('#set_enter_at_level_' + msg.node_index).val(msg.level);
			rotorhazard.nodes[msg.node_index].enter_at_level = msg.level;

			$('#node_notice_' + i).html(rotorhazard.nodes[msg.node_index].checkValues());
			rotorhazard.nodes[msg.node_index].updateThresholds();
		});

		socket.on('node_exit_at_level', function (msg) {
			$('#set_exit_at_level_' + msg.node_index).val(msg.level);
			rotorhazard.nodes[msg.node_index].exit_at_level = msg.level;

			$('#node_notice_' + i).html(rotorhazard.nodes[msg.node_index].checkValues());
			rotorhazard.nodes[msg.node_index].updateThresholds();
		});

		socket.on('current_laps', function (msg) {
			current_laps = msg.current;
			current_laps_reversed = false;
			show_current_laps();
		});

		function show_current_laps() {
			if (current_laps && rotorhazard.event.race_status) {
				$.each(current_laps.node_index, function (i, curnode_data) { // i is loop num, curnode_data is json object
					$('#current_laps_' + i + ' tbody > tr').remove();

					if(rotorhazard.display_laps_reversed) {
						if(!current_laps_reversed) {
							curnode_data.laps.reverse();
						}
					}
					else if(current_laps_reversed) {
						curnode_data.laps.reverse();
					}

					$.each(curnode_data.laps, function (j, lap) { // j is loop num, lap_id is json object
						if(lap.splits) {
							if(rotorhazard.display_laps_reversed) {
								if(!current_laps_reversed && lap.splits.length > 1) {
									lap.splits.reverse();
								}
								$.each(lap.splits, function(k, split) {
									if ((!curnode_data.finished_flag) || j > 0 ||
													(split.split_time && split.split_time != '-') ||
													split.split_speed) {  // don't show last split if empty and pilot finished
										var split_display = split.split_time + ' ';
										if (split.split_speed) {
											split_display += '(' + split.split_speed + ')';
										}
										var split_tr = $('<tr>');
										split_tr.addClass('lap_split');
										var split_id = 'split ';
										if (lap.splits.length > 1) {
											split_id += (split.split_id+1);
										}
										split_tr.append($('<td>').text(split_id));
										var split_time_td = $('<td colspan=1">').text(split_display);
										split_tr.append(split_time_td);
										split_tr.appendTo('#current_laps_' + i);
									}
								});
							}
							else if(current_laps_reversed && lap.splits.length > 1) {
								lap.splits.reverse();
							}
						}

						var tr = $('<tr>');
						var lap_num = lap.lap_number;
						if (lap_num == 0) {
							tr.addClass('lap_0');
						}

						var local_colspan = 2;
						if(rotorhazard.display_lap_id) {
							local_colspan = 1;
							if(lap_num < 0) {
								lap_num = ' ';
							}
							tr.append(
								$('<td class="display_lap_number">').text(lap_num)
							);
						}
						time_td = $('<td colspan="'+local_colspan+'">').text(' ' + lap.lap_time + ' ').append(
								$('<button class="delete_lap btn-danger" data-node="' + i + '" data-lap-index="' + lap.lap_index + '">&#215;</button>')
								);
						if(lap.late_lap) {
							tr.addClass('late-lap');
							time_td.prepend(
									$('<button class="restore_deleted_lap" data-node="' + i + '" data-lap-index="' + lap.lap_index + '">+</button>'));
						}
						local_prepend = $('<span class="from_start">');

						if(rotorhazard.display_time_first_pass) {
							if(rotorhazard.display_laps_reversed) {
								if(curnode_data.laps.length > 0) {
									ts_val = lap.lap_time_stamp - curnode_data.laps[curnode_data.laps.length-1].lap_time_stamp;
								}
								else {
									ts_val = 0;
								}
							}
							else {
								ts_val = lap.lap_time_stamp - curnode_data.laps[0].lap_time_stamp;
							}
							local_prepend.text(formatTimeMillis(ts_val, {{ getConfig('UI', 'timeFormat')|tojson }}));
							if(rotorhazard.display_time_start){
								local_prepend.append(" / ");
							}
						}

						if(rotorhazard.display_time_start) {
							local_prepend.append(formatTimeMillis(lap.lap_time_stamp, {{ getConfig('UI', 'timeFormat')|tojson }}));
						}

						time_td.prepend(local_prepend);
						tr.append(time_td);

						if (lap.lap_number && lap.lap_raw < (rotorhazard.min_lap * 1000)) {
							tr.addClass('min-lap-warning');
						}
						if (!rotorhazard.event.race_status.unlimited_time && lap.lap_time_stamp > (rotorhazard.event.race_status.race_time_sec * 1000)) {
							tr.addClass('after-time-expired');
						}
						tr.appendTo('#current_laps_' + i);

						if(!rotorhazard.display_laps_reversed) {
							$.each(lap.splits, function(k, split) {
								if ((!curnode_data.finished_flag) || j < curnode_data.laps.length-1 ||
														(split.split_time && split.split_time != '-') ||
														split.split_speed) {  // don't show last split if empty and pilot finished
									var split_display = split.split_time + ' ';
									if (split.split_speed) {
										split_display += '(' + split.split_speed + ')';
									}
									var split_tr = $('<tr>');
									split_tr.addClass('lap_split');
									var split_id = 'split ';
									if (lap.splits.length > 1) {
										split_id += (split.split_id+1);
									}
									split_tr.append($('<td>').text(split_id));
									var split_time_td = $('<td colspan=1">').text(split_display);
									split_tr.append(split_time_td);
									split_tr.appendTo('#current_laps_' + i);
								}
							});
						}
					});
				});
				current_laps_reversed = rotorhazard.display_laps_reversed;
			}
		}

		socket.on('leaderboard', function (msg) {
			var race = msg.current;

			heat = rotorhazard.event.heats.find(obj => {return obj.id == race.heat})
			if (heat) {
				$('.current_heat').html(heat.displayname);
			} else {
				$('.current_heat').html(__('Practice Mode'));
			}

			leaderboard_type = race.leaderboard.meta.primary_leaderboard;
			$('#leaderboard').empty();
			$('#leaderboard').append(build_leaderboard(race.leaderboard[leaderboard_type], 'current', race.leaderboard.meta));

			$('#team_leaderboard').empty();
			if (race.team_leaderboard && 'meta' in race.team_leaderboard) {
				leaderboard_type = race.team_leaderboard.meta.primary_leaderboard;
				$('#team_leaderboard').append(build_team_leaderboard(race.team_leaderboard[leaderboard_type], leaderboard_type, race.team_leaderboard.meta));
			}

			$('.race_status_message').html(race.status_msg);
		});

		function callout_current_leader(pilot_phonetic, separate_call_flag) {
			if (!rotorhazard.winner_declared_flag) {
				speak(('<div class="speech">' + pilot_phonetic + " " + __l('is leading') + '</div>'),
						separate_call_flag);
				// do 'speak()' for leader tone second because "priority=true" reverses order
				if (separate_call_flag && rotorhazard.beep_race_leader_lap) {
					speak(LEADER_FLAG_CHAR, separate_call_flag);
				}
			}
		}

		socket.on('phonetic_data', function (msg) {
			if (!msg.node_finished || rotorhazard.voice_if_node_finished) {
				if (rotorhazard.min_lap * 1000 < msg.raw_time) {
					var ttstext = '';
	
					if (rotorhazard.voice_callsign == 1 ||
								(rotorhazard.voice_callsign == 2 && (!msg.team_phonetic))) {
						if (msg.callsign)
							ttstext = msg.callsign;
						if (msg.pilot)
							ttstext = msg.pilot;
					}
	
					if (msg.lap && (rotorhazard.voice_lap_count == 1 ||
								(rotorhazard.voice_lap_count == 2 && (!msg.team_phonetic)))) {
						if (ttstext.length > 0)
							ttstext += ", ";
						ttstext += __l('Lap') + " " + msg.lap;
					}
	
					if (rotorhazard.voice_lap_time == 1 ||
								(rotorhazard.voice_lap_time == 2 && (!msg.team_phonetic))) {
						if (ttstext.length > 0)
							ttstext += ", ";
						ttstext += msg.phonetic;
					}
	
					if (msg.team_phonetic && rotorhazard.voice_team_lap_count != 0) {
						if (ttstext.length > 0)
							ttstext += ", ";
						if (rotorhazard.voice_team_lap_count == 2 && msg.team_short_phonetic) {
							ttstext += msg.team_short_phonetic;
						} else {
							ttstext += msg.team_phonetic;
						}
					}
	
					if (ttstext.length > 0) {
						if (msg.leader_flag) {
							if (rotorhazard.beep_race_leader_lap) {
								speak(LEADER_FLAG_CHAR);
							}
							if (rotorhazard.voice_race_leader && (!msg.team_phonetic)) {
								setTimeout(callout_current_leader, (rotorhazard.voice_race_leader * 1000), (msg.pilot ? msg.pilot : msg.callsign), false);
							}
						}
						speak('<div class="speech">' + ttstext + '</div>');
					}
				}
			}
		})

		socket.on('phonetic_leader', function (msg) {
			if (rotorhazard.voice_race_leader) {
				setTimeout(callout_current_leader, (rotorhazard.voice_race_leader * 1000), (msg.pilot ? msg.pilot : msg.callsign), true);
			}
		})

		socket.on('phonetic_split_call', function (msg) {
			var ttstext = '';
			if (rotorhazard.voice_split_timer) {
				if ((rotorhazard.voice_split_timer & SPLMSK_PILOT_NAME) && msg.pilot_name) {
					ttstext = msg.pilot_name;
				}
				var sepstr = ' ';
				if (((rotorhazard.voice_split_timer & SPLMSK_SPLIT_ID) && msg.split_id) ||
							((rotorhazard.voice_split_timer & SPLMSK_SPLIT_TIME) && msg.split_time)) {
					ttstext += ' ' + __l('split');
					if ((rotorhazard.voice_split_timer & SPLMSK_SPLIT_ID) && msg.split_id) {
						ttstext += ' ' + msg.split_id;
					}
					if ((rotorhazard.voice_split_timer & SPLMSK_SPLIT_TIME) && msg.split_time) {
						ttstext += ' ' + __l('time') + ' ' + msg.split_time;
						sepstr = ', ';
					}
				}
				if ((rotorhazard.voice_split_timer & SPLMSK_SPLIT_TIME) && msg.split_speed) {
					ttstext += sepstr + __l('speed') + ' ' + msg.split_speed;
				}
				if (ttstext.length > 0) {
					speak('<div class="speech">' + ttstext + '</div>');
				}
			}
		})

		socket.on('first_pass_registered', function (msg) {
			if (!rotorhazard.beep_crossing_exited && rotorhazard.beep_on_first_pass_button) {
				if (rotorhazard.use_mp3_tones) {
					play_mp3_beep(sound_beep, rotorhazard.indicator_beep_volume);
				}
				else {
					play_beep(35, node_tone[msg.node_index], rotorhazard.indicator_beep_volume, 'sawtooth', 0.02);
					setTimeout(function(tone){
						play_beep(35, node_tone[tone], rotorhazard.indicator_beep_volume, 'sawtooth');
					}, 70, msg.node_index);
				}
			}
		});

		socket.on('phonetic_text', function (msg) {
			if (msg.winner_flag) {
				if (rotorhazard.beep_race_winner_declared) {
					speak(WINNER_FLAG_CHAR);
				}
				rotorhazard.winner_declared_flag = true;
			}
			if (msg.text) {
				if (!msg.domain || rotorhazard['voice_' + msg.domain]) {
					speak('<div class="speech">' + __l(msg.text) + '</div>');
				}
			}
		})

		socket.on('current_heat', function (msg) {
			rotorhazard.current_heat = msg.current_heat;
			$('#set_current_heat').val(msg.current_heat);

			rotorhazard.current_heatNodes = msg.heatNodes;

			for (var idx in msg.heatNodes) {
				hn = msg.heatNodes[idx];
				cs = $('.callsign_' + idx)
				cs.html(hn.callsign ? hn.callsign : __('-None-'));

				color = colorvalToHex(hn.activeColor)
				cs
					.css('background-color', color)
					.css('color', contrastColor(color));
			}

			$('.set_heat_coop_best_time').val(msg.coop_best_time ? String(msg.coop_best_time) : '');
			$('.set_heat_coop_num_laps').val(msg.coop_num_laps ? String(msg.coop_num_laps) : '');

			if (msg.heat_format) {
				$('#set_race_format').val(msg.heat_format);
				$('#set_race_format').prop('disabled', true);
			} else {
				$('#set_race_format').prop('disabled', false);
			}

			if (msg.current_heat === 0) {
				$('#practice-warning').show();
				$('#next-round').hide();
			} else {
				$('#practice-warning').hide();
				$('#next-round').text(__("Round") + " " + msg.next_round).show();
			}
		});

		socket.on('stop_timer', function (msg) {
			rotorhazard.timer.stopAll();
		});

		socket.on('stage_ready', function (msg) {
			race_kickoff(msg);
		});

		$('button#start_race').click(function (event) {
			if(!$(this).prop('disabled')) {
				$('#set_current_heat').prop('disabled', true);
				$('button#start_race').prop('disabled', true);
				$('button#stop_race').prop('disabled', true);
				$('button#save_laps').prop('disabled', true);
				$('button#discard_laps').prop('disabled', true);
				rotorhazard.timer.stopAll();
				$('.time-display').html('--:--');
				socket.emit('stage_race');
			}
			initSpeak(event);
		});

		$('button#stop_race').click(function (event) {
			if(!$(this).prop('disabled')) {
				$('button#start_race').prop('disabled', true);
				$('button#stop_race').prop('disabled', true);
				$('button#save_laps').prop('disabled', true);
				$('button#discard_laps').prop('disabled', true);
				rotorhazard.timer.stopAll();
				socket.emit('stop_race');
			}
		});

		$('button#save_laps').click(function (event) {
			if(!$(this).prop('disabled')) {
				$('button#start_race').prop('disabled', true);
				$('button#stop_race').prop('disabled', true);
				$('button#save_laps').prop('disabled', true);
				$('button#discard_laps').prop('disabled', true);
				socket.emit('save_laps');
			}
		});

		$('button#discard_laps').click(function (event) {
			if(!$(this).prop('disabled')) {
				$('button#start_race').prop('disabled', true);
				$('button#stop_race').prop('disabled', true);
				$('button#save_laps').prop('disabled', true);
				$('button#discard_laps').prop('disabled', true);
				$('.time-display').html('--:--');
				socket.emit('discard_laps');
			}
		});

		$('.set_enter_at_level').change(function (event) {
			var data = {
				node: parseInt($(this).data('node')),
				enter_at_level: parseInt($(this).val()),
			};
			if (!Number.isNaN(data.enter_at_level)) {
				socket.emit('set_enter_at_level', data);
				rotorhazard.nodes[data.node].enter_at_level = data.enter_at_level;
				rotorhazard.nodes[data.node].updateThresholds();
			}
		});

		$('.set_exit_at_level').change(function (event) {
			var data = {
				node: parseInt($(this).data('node')),
				exit_at_level: parseInt($(this).val()),
			};
			if (!Number.isNaN(data.exit_at_level)) {
				socket.emit('set_exit_at_level', data);
				rotorhazard.nodes[data.node].exit_at_level = data.exit_at_level;
				rotorhazard.nodes[data.node].updateThresholds();
			}
		});

		$('button.cap_enter_at_btn').click(function (event) {
			var data = {
				node_index: parseInt($(this).data('node_index')),
			};
			$('#set_enter_at_level_' + data.node_index).val('');
			socket.emit('cap_enter_at_btn', data);
		});

		$('button.cap_exit_at_btn').click(function (event) {
			var data = {
				node_index: parseInt($(this).data('node_index')),
			};
			$('#set_exit_at_level_' + data.node_index).val('');
			socket.emit('cap_exit_at_btn', data);
		});

		$('button.pause_graph').click(function (event) {
			var btn = $(this);
			var node = rotorhazard.nodes[parseInt($(this).data('node'))]
			if (node.graphPaused) {
				node.graph.options.scaleSmoothing = 0.125;
				node.graph.removeTimeSeries(node.pauseSeries)
				node.graph.addTimeSeries(node.series, {lineWidth:1.7,
					strokeStyle:'hsl(214, 53%, 60%)',
					fillStyle:'hsla(214, 53%, 60%, 0.4)'
				});
				node.graph.start();
				btn.html(svg_asset.pause);
			} else {
				node.graph.stop();
				node.graphPausedTime = new Date().getTime();
				node.pauseSeries = node.series;
				node.graph.options.scaleSmoothing = 1;
				node.graph.removeTimeSeries(node.series)
				node.graph.addTimeSeries(node.pauseSeries, {lineWidth:1.7,
					strokeStyle:'hsl(214, 53%, 60%)',
					fillStyle:'hsla(214, 53%, 60%, 0.4)'
				});
				node.graph.render(node.canvas, node.graphPausedTime);
				btn.html(svg_asset.play);
			}
			node.graphPaused = !node.graphPaused;
		});

		$('button.simulate_lap').click(function (event) {
			// if(!$(this).prop('disabled')) {
				if (rotorhazard.beep_manual_lap_button) {
					if (rotorhazard.use_mp3_tones) {
						play_mp3_beep(sound_beep, rotorhazard.indicator_beep_volume);
					}
					else {
						play_beep(35, node_tone[$(this).data('node')], rotorhazard.indicator_beep_volume, 'sawtooth');
					}
				}

				var data = {
					node: parseInt($(this).data('node')),
				};
				socket.emit('simulate_lap', data);
			// }
		});

		$(document).on("click", ".delete_lap", function (event) { // Needed for buttons added after document load
			var data = {
				node: parseInt($(this).data('node')),
				lap_index: parseInt($(this).data('lap-index')),
			};
			socket.emit('delete_lap', data);
		});

		$(document).on("click", ".restore_deleted_lap", function (event) { // Needed for buttons added after document load
			var data = {
				node: parseInt($(this).data('node')),
				lap_index: parseInt($(this).data('lap-index')),
			};
			socket.emit('restore_deleted_lap', data);
		});

		$('#set_current_heat').change(function (event) {
			var data = {
				heat: parseInt($(this).val()),
			};
			socket.emit('set_current_heat', data);
		});

		$(document).on("click", '.retry_secondary', function (event) {
			var data = {
				secondary_id: parseInt($(this).data('secondary_id'))
			};
			socket.emit('retry_secondary', data);
		});

		/* Voice */
		$('#beep_on_first_pass_button').prop('disabled', rotorhazard.beep_crossing_exited);

		$(document).on('change', '#set_voice_language', function (event) {
			rotorhazard.voice_language = $(this).val();
			rotorhazard.saveData();
		});

		// construct language selection
		$('#voice_select').after('<select id="set_voice_language">');
		var voices = $().articulate('getVoices');

		for (var i in voices) {
			$('#set_voice_language').append('<option>'+ voices[i].name + '</option>');
		}
		$('#set_voice_language').val(rotorhazard.voice_language);
		if (!($('#set_voice_language').val())) {  // if no match then select first English voice
			rotorhazard.voice_language = get_default_articulate_voice();
			rotorhazard.saveData();
			$('#set_voice_language').val(rotorhazard.voice_language);
		}

		$('#set_voice_string_language').change(function (event) {
			rotorhazard.voice_string_language = $(this).val();
			rotorhazard.saveData();
		});

		$('#voice_callsign').change(function (event) {
			rotorhazard.voice_callsign = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_lap_count').change(function (event) {
			rotorhazard.voice_lap_count = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_team_lap_count').change(function (event) {
			rotorhazard.voice_team_lap_count = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_lap_time').change(function (event) {
			rotorhazard.voice_lap_time = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_race_timer').change(function (event) {
			rotorhazard.voice_race_timer = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_race_winner').change(function (event) {
			rotorhazard.voice_race_winner = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_if_node_finished').change(function (event) {
			rotorhazard.voice_if_node_finished = parseInt($(this).val());
			rotorhazard.saveData();
		});
		
		$('#voice_split_timer').change(function (event) {
			rotorhazard.voice_split_timer = parseInt($(this).val());
			rotorhazard.saveData();
		});
		
		$('#voice_race_leader').change(function (event) {
			rotorhazard.voice_race_leader = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#set_voice_volume').on('input', function (event) {
			var val = volume_logsl.value($(this).val());
			$().articulate('volume', val);
			$('#voice_volume_value').html($(this).val());
		});

		$('#set_voice_volume').change(function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.voice_volume = val;
			rotorhazard.saveData();
		});

		$('#set_voice_rate').on('input', function (event) {
			val = parseFloat($(this).val())
			$().articulate('rate', val);
			$('#voice_rate_value').html(val.toFixed(2));
		});

		$('#set_voice_rate').on('change', function (event) {
			rotorhazard.voice_rate = parseFloat($(this).val());
			rotorhazard.saveData();
		});

		$('#set_voice_pitch').on('input', function (event) {
			val = parseFloat($(this).val())
			$().articulate('pitch', val);
			$('#voice_pitch_value').html(val.toFixed(2));
		});

		$('#set_voice_pitch').on('change', function (event) {
			rotorhazard.voice_pitch = parseFloat($(this).val());
			rotorhazard.saveData();
		});

		$('#set_tone_volume').on('input', function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.tone_volume = val;
			$('#tone_volume_value').html($(this).val());
		});

		$('#set_tone_volume').change(function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.tone_volume = val;
			rotorhazard.saveData();
		});

		$('#beep_crossing_entered').change(function (event) {
			rotorhazard.beep_crossing_entered = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_crossing_exited').change(function (event) {
			rotorhazard.beep_crossing_exited = $(this).prop('checked');
			$('#beep_on_first_pass_button').prop('disabled', rotorhazard.beep_crossing_exited);
			rotorhazard.saveData();
		});

		$('#beep_manual_lap_button').change(function (event) {
			rotorhazard.beep_manual_lap_button = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_race_leader_lap').change(function (event) {
			rotorhazard.beep_race_leader_lap = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_race_winner_declared').change(function (event) {
			rotorhazard.beep_race_winner_declared = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_cluster_connect').change(function (event) {
			rotorhazard.beep_cluster_connect = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#use_mp3_tones').change(function (event) {
			rotorhazard.use_mp3_tones = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_on_first_pass_button').change(function (event) {
			rotorhazard.beep_on_first_pass_button = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#schedule_m').change(function (event) {
			rotorhazard.schedule_m = $(this).val();
			rotorhazard.saveData();
		});

		$('#schedule_s').change(function (event) {
			rotorhazard.schedule_s = $(this).val();
			rotorhazard.saveData();
		});

		$('#set_indicator_volume').on('input', function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.indicator_beep_volume = val;
			$('#indicator_volume_value').html($(this).val());
		});

		$('#set_indicator_volume').change(function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.indicator_beep_volume = val;
			rotorhazard.saveData();
		});

		$('button#export_audio_settings').click(function (event) {
			var date = new Date();
			var outData = rotorhazard.getAudioSettingsStr(date)
			saveAs(new Blob([outData], {type: "text/plain;charset=utf-8"}),
					"rhAudioSettings_" + rotorhazard.getCurDateTimeNumStr(date) + ".cfg");
		});

		$('button#default_audio_settings').click(function (event) {
			$.magnificPopup.close();
			if (rotorhazard.loadDefaultAudioSettings()) {
				populate_audio_settings();
			}
		});

		$('#select_audio_import_file').change(function(){
			if ($(this).prop('files')[0]) {
				$('#import_audio_settings').prop('disabled', false);
			}
		});

		$('button#import_audio_settings').click(function (event) {
			if ($('#select_audio_import_file').prop('files')[0]) {
				$('#import_audio_settings').prop('disabled', true);
				rotorhazard.importAudioSettingsFile(
							$('#select_audio_import_file').prop('files')[0], populate_audio_settings);
				$('#select_audio_import_file').val('');
			}
		});

		$('#hide_graphs').change(function (event) {
			rotorhazard.hide_graphs = !$(this).prop('checked');
			rotorhazard.saveData();
			for (var i in rotorhazard.nodes) {
				var node = rotorhazard.nodes[i];
				if (node.canvas) {
					if (rotorhazard.hide_graphs) {
						node.graph.stop();
					} else {
						node.graph.start();
					}
				}
			}
			$('.rssi-graph').prop('hidden', rotorhazard.hide_graphs);
		});

		$('#display_lap_id').change(function (event) {
			rotorhazard.display_lap_id = $(this).prop('checked');
			rotorhazard.saveData();
			show_current_laps();
		});

		$('#display_time_start').change(function (event) {
			rotorhazard.display_time_start = $(this).prop('checked');
			rotorhazard.saveData();
			show_current_laps();
		});

		$('#display_time_first_pass').change(function (event) {
			rotorhazard.display_time_first_pass = $(this).prop('checked');
			rotorhazard.saveData();
			show_current_laps();
		});

		$('#display_laps_reversed').change(function (event) {
			rotorhazard.display_laps_reversed = $(this).prop('checked');
			rotorhazard.saveData();
			show_current_laps();
		});

		/* Race Format */

		$('#schedule_race').click(function (event) {
			var m = parseInt($('#schedule_m').val() || 0);
			var s = parseInt($('#schedule_s').val() || 0);
			if (m || s) {
				var data = {
					m: m,
					s: s
				};
				request_time = new Date();
				socket.emit('schedule_race', data);
			}
			initSpeak(event);
		})

		$('#cancel_schedule_race').click(function (event) {
			socket.emit('cancel_schedule_race');
		})

		socket.on('min_lap', function (msg) {
			$('#set_min_lap').val(msg.min_lap);
			$('#set_min_lap_behavior').val(msg.min_lap_behavior);
			rotorhazard.min_lap = parseIntDefault(msg.min_lap);
		});

		$('#set_min_lap').change(function (event) {
			var min_lap_val = parseIntDefault($(this).val());
			rotorhazard.min_lap = min_lap_val;
			var data = {
				min_lap: min_lap_val
			};
			socket.emit('set_min_lap', data);
		})

		$('#set_min_lap_behavior').change(function (event) {
			var data = {
				min_lap_behavior: parseInt($(this).val())
			};
			socket.emit('set_min_lap_behavior', data);
		})

		socket.on('format_data', function (msg) {
			rotorhazard.event.race_formats = msg.formats;
			update_race_formats();
		});

		function update_race_formats() {
			if (rotorhazard.event.race_formats && rotorhazard.event.race_status) {
				$('#set_race_format').empty();
				for (var i = 0; i < rotorhazard.event.race_formats.length; i++) {
					$('#set_race_format').append('<option value="' + rotorhazard.event.race_formats[i].id +'">' + rotorhazard.event.race_formats[i].name + '</option>')
				}
				$('#set_race_format').val(rotorhazard.event.race_status.race_format_id);

				var format = rotorhazard.event.race_formats.find(obj => {return obj.id == rotorhazard.event.race_status.race_format_id})

				if (rotorhazard.event.race_status.race_heat_id && format.team_racing_mode == RACING_MODE_COOP) {
					if (format.win_condition == 2) {
						// if First to X Laps
						$('#coop-time-control').prop('hidden', false);
						$('#coop-laps-control').prop('hidden', true);
					} else if (format.win_condition == 1 || format.win_condition == 5 || format.win_condition == 6) {
						// if Most Laps in Fastest Time | Most Laps Only | Most Laps Only with Overtime
						$('#coop-time-control').prop('hidden', true);
						$('#coop-laps-control').prop('hidden', false);
					} else {
						$('#coop-time-control').prop('hidden', true);
						$('#coop-laps-control').prop('hidden', true);
					}
				} else {
					$('#coop-time-control').prop('hidden', true);
					$('#coop-laps-control').prop('hidden', true);
				}
			}
		}

		$('#set_race_format').change(function (event) {
			var data = {
				race_format: parseInt($(this).val())
			};
			if ($(this).find('option').length > 1)
				socket.emit('set_race_format', data);
		});

		$(document).on("change", '.set_heat_coop_best_time', function (event) {
			var data = {
				heat: rotorhazard.event.race_status.race_heat_id,
				coop_best_time: $(this).val(),
				coop_data_flag: true  // set flag to indicate only co-op data was modified
			};
			socket.emit('alter_heat', data);
		});

		$(document).on("change", '.set_heat_coop_num_laps', function (event) {
			var data = {
				heat: rotorhazard.event.race_status.race_heat_id,
				coop_num_laps: parseInt($(this).val()),
				coop_data_flag: true  // set flag to indicate only co-op data was modified
			};
			socket.emit('alter_heat', data);
		});

		/* Send Message */
		$('button#send_message').click(function (event) {
			var data = {
				message: $('#message_body').val(),
				interrupt: $('#message_interrupt').prop('checked')
			};
			socket.emit('broadcast_message', data);

			$('#message_body').val('');
			$('#message_interrupt').prop('checked', false);
		});

		/* Calibration Profiles */
		socket.on('node_tuning', function (msg) {
			$('#set_profile').empty();
			for (i = 0; i < msg.profile_ids.length; i++) {
				$('#set_profile').append('<option value="' + msg.profile_ids[i] +'">' + msg.profile_names[i] + '</option>')
			}
			$('#set_profile').val(msg.current_profile);
		});

		socket.on('node_crossing_change', function (msg) {
			if (msg.crossing_flag) {
				if (rotorhazard.beep_crossing_entered)
					if (rotorhazard.use_mp3_tones) {
						play_mp3_beep(sound_enter, rotorhazard.indicator_beep_volume);
					}
					else {
						play_beep(25, node_tone[msg.node_index], rotorhazard.indicator_beep_volume, 'square');
					}
			}
			else {
				if (rotorhazard.beep_crossing_exited) {
						if (rotorhazard.use_mp3_tones) {
							play_mp3_beep(sound_exit, rotorhazard.indicator_beep_volume);
						}
						else {
							play_beep(35, node_tone[msg.node_index], rotorhazard.indicator_beep_volume, 'sawtooth', 0.02);
							setTimeout(function(tone){
								play_beep(35, node_tone[tone], rotorhazard.indicator_beep_volume, 'sawtooth');
							}, 70, msg.node_index);
						}
				}
			}
		});

		socket.on('cluster_connect_change', function (msg) {
			if (rotorhazard.beep_cluster_connect) {
				if (msg.connect_flag) {
					if (rotorhazard.use_mp3_tones) {
						play_mp3_beep(sound_cconnect, rotorhazard.indicator_beep_volume);
					}
					else {
						play_beep(120, 225, rotorhazard.indicator_beep_volume, 'square');
						setTimeout(function(tone){
							play_beep(110, 250, rotorhazard.indicator_beep_volume, 'square');
						}, 120, 0);
					}
				}
				else {
					if (rotorhazard.use_mp3_tones) {
						play_mp3_beep(sound_cdisconnect, rotorhazard.indicator_beep_volume);
					}
					else {
						play_beep(80, 200, rotorhazard.indicator_beep_volume, 'square');
						setTimeout(function(tone){
							play_beep(220, 100, rotorhazard.indicator_beep_volume, 'square');
						}, 80, 0);
					}
				}
			}
		});

		socket.on('play_beep_tone', function (msg) {
			var volume = msg.volume;
			if (volume) {
				volume = volume / 100.0
			} else {
				volume = rotorhazard.voice_volume;
			}
			var toneType = msg.toneType;
			if (!toneType) {
				toneType = 'sine';
			}
			play_beep(msg.duration, msg.frequency, volume, toneType);
		});

		$('#set_profile').change(function (event) {
			var data = {
				profile: $(this).val()
			};
			socket.emit('set_profile', data);
		});

		socket.on('environmental_data', function (msg) {
			var env_table_html = '';
			for (i=0; i<msg.length; i++) {
				var sensor = msg[i];
				var name = Object.keys(sensor)[0];
				var data = sensor[name];
				var values = '';
				var br = '';
				for (var reading in data) {
					var value = data[reading].value;
					var units = data[reading].units;
					values += br;
					if (reading == 'voltage') {
						values += __('Voltage: ') + Number(value).toFixed(2)+units;
					} else if(reading == 'current') {
						values += __('Current: ') + Number(value).toFixed(0)+units;
					} else if(reading == 'power') {
						values += __('Power: ') + Number(value).toFixed(0)+units;
					} else if(reading == 'temperature') {
						values += __('Temperature: ') + Number(value).toFixed(1)+units;
					} else if(reading == 'humidity') {
						values += __('Humidity: ') + Number(value).toFixed(1)+units;
					} else if(reading == 'pressure') {
						values += __('Pressure: ') + Number(value).toFixed(1)+units;
					} else if(reading == 'capacity') {
						values += __('Capacity: ') + Number(value).toFixed(0)+units;
					} else {
						values += __('Unknown: ') + value;
					}
					br = '<br/>';
				}
				env_table_html += '<tr>';
				env_table_html += '<td>' + name + '</td>';
				env_table_html += '<td>' + values + '</td>';
				env_table_html += '</tr>';
			}
			if (env_table_html) {
				$('#env-data-table').html('<table><tr><th>'+__('Sensor')+'</th><th>'+__('Readings')+'</th></tr>' + env_table_html + '</table><br />');
			}
		});

		socket.on('cluster_status', function (msg) {
			$('#cluster-status').empty();

			if (msg.secondaries && msg.secondaries.length > 0) {
				var cluster_body = $('<ul>');

				for (i=0; i < msg.secondaries.length; i++) {
					var item = $('<li>');
					var properties = $('<ul class="cluster tinytable">');

					var property = $('<li>');
					property.append('<div class="label">' + __('Address') + ' / ' + __('Type') + '</div>');
					property.append('<div class="data"><a href="' + msg.secondaries[i].address + '">' + msg.secondaries[i].address + '</a> / ' + msg.secondaries[i].modeIndicator + '</div>');
					properties.append(property);

					property = $('<li>');
					property.append('<div class="label">' + __('Latency') + ': ' + __('last') + ' / ' + __('min') + ' / ' + __('avg') + ' / ' + __('max') + '</div>');
					property.append('<div class="data">' + msg.secondaries[i].lastLatencyMs + ' / ' + msg.secondaries[i].minLatencyMs + ' / ' + msg.secondaries[i].avgLatencyMs + ' / ' + msg.secondaries[i].maxLatencyMs + ' ' + __('ms') + '</div>');
					properties.append(property);

					property = $('<li>');
					property.append('<div class="label">' + __('Disconnects') + ' / ' + __('Contacts') + ' / ' + __('Time Diff') + '</div>');
					property.append('<div class="data">' + msg.secondaries[i].numDisconnects + ' / ' + msg.secondaries[i].numContacts + ' / ' + msg.secondaries[i].timeDiffMs + ' ' + __('ms') + '</div>');
					properties.append(property);

					property = $('<li>');
					property.append('<div class="label">' + __('Up') + ' / ' + __('Down') + ' / ' + __('Availability') + '</div>');
					property.append('<div class="data">' + msg.secondaries[i].upTimeSecs + __('s') + ' / ' + msg.secondaries[i].downTimeSecs + __('s') + ' / ' + msg.secondaries[i].availability + '%</div>');
					properties.append(property);

					property = $('<li>');
					property.append('<div class="label">' + __('Last Contact') + '</div>');
					property.append('<div class="data">' + msg.secondaries[i].last_contact + '</div>');
					properties.append(property);

					item.append(properties);
					cluster_body.append(item);
				}

				$('#cluster-status').append(cluster_body);
			}
		});

		/* LED Controls */

		socket.on('led_effects', function (msg) {
			var led_html = $('<div class="control-set">');

			var led_select = $('<select id="led-effects-select"></select>');

			const effects = msg.effects.slice().sort((a, b) => (a.label > b.label) ? 1 : -1);

			for (var i in effects) {
				var effect = effects[i];

				var led_select_option = $('<option value="' + effect.name + '">' + effect.label + '</option>')

				led_select.append(led_select_option);
			}

			led_html.append($('<label for="led-effects">' + __('Effect') + '</label>'));
			led_html.append(' ');
			led_html.append(led_select);
			led_html.append(' ');
			led_html.append('<label for="set_led_color" class="screen-reader-text">' + __('LED Color') + '</label>');
			led_html.append('<button id="set_led_color" class="color-picker" style="background-color: #ff6a00"/>');
			led_html.append(' ');
			led_html.append($('<button id="use-led-effect">' + __('Go') + '</button>'));

			$('#LED-effects').html(led_html);
		});

		$(document).on('click', '#use-led-effect', function (event) {
			var data = {
				effect: $('#led-effects-select').val(),
				color: rgbtoHex($('#set_led_color').css('background-color'))
			};
			socket.emit('use_led_effect', data);
		});

		$('button.LED-color').click(function (event) {
				var colors = convertColor($(this).data('rgb'));
				var data = {
					red: colors.r,
					green: colors.g,
					blue: colors.b,
				};
				socket.emit('LED_solid', data);
		});

		$('button.LED-off').click(function (event) {
				var data = {
					off: true
				};
				socket.emit('LED_solid', data);
		});

		$('#set_led_color').change(function (event) {
				var colors = convertColor($(this).val());
				var data = {
					red: colors.r,
					green: colors.g,
					blue: colors.b,
				};
				socket.emit('LED_solid', data);
		});

		$(document).on("click", '#set_led_color', function (event) {
			src_hexcolor = rgbtoHex($(event.target).css('background-color'));

			color_picker(src_hexcolor, function(hexcolor){
				$(event.target).css('background-color', hexcolor);
			})
		})

		$('#set_led_brightness').on('input', function (event) {
			var val = brightness_logsl.value($(this).val());
			$('#led_brightness_value').html($(this).val());
		});

		$('#set_led_brightness').change(function (event) {
			var val = brightness_logsl.value($(this).val());
			// emit data
			var data = {
				brightness: Math.round(val),
			};
			socket.emit('LED_brightness', data);
		});

		/* VRx */
		socket.on('vrx_list', function (msg) {
			if (msg.enabled) {
				devices_by_node = {}

				for (var device_id in msg.devices) {
					var device = msg.devices[device_id]
					if (device.ready) {
						if (!devices_by_node[device.map_seat]) {
							devices_by_node[device.map_seat] = [];
						}
						devices_by_node[device.map_seat].push(device_id)
					}
				}

				for (i = 0; i < {{ num_nodes }}; i++) {
					var header = $('#node-' + i + ' .vrx-header');
					header.empty();

					var locks = 0;
					if (i in devices_by_node) {
						for (j in devices_by_node[i]) {
							var device_id = devices_by_node[i][j];
							var device = msg.devices[device_id];
							if (device.video_lock) {
								locks++;
							}
						}

						if (locks == devices_by_node[i].length) {
							header.removeClass('has-unlocked')
						} else {
							header.addClass('has-unlocked')
						}

						header.append(__('VRx locks') + ': ' + locks + '/' + devices_by_node[i].length);
					} else {
						header.removeClass('has-unlocked')
						header.append(__('VRx locks') + ': 0/0');
					}
				}
			} else {
				for (i = 0; i < {{ num_nodes }}; i++) {
					var header = $('#node-' + i + ' .vrx-header');
					header.empty();
				}
			}
		});

		/* Pilots */
		socket.on('pilot_data', function (msg) {
			rotorhazard.pilot_data = msg.pilots;
		});

		/* Callouts */
		function add_callout(content='') {
			id = $('.callout-items>li').length + 1;

			new_callout = $('<li>');
			new_callout_label = $('<div class="label-block">');

			label = '<label for="callout_text_'+ id +'">' + __('Callout') + ' ' + id + '</label>';
			if (id <= 9) {
				label += '<p class="desc">' + __('Ctrl') + '+' + __('Alt') + '+' + id + '</p>';
			}

			new_callout_label.html(label)

			new_callout_control = $('<div class="control-block">');
			new_callout_control.append('<input type="text" id="callout_text_' + id + '" class="callout_text" value="' + content + '">');
			new_callout_control.append('<button class="button play_callout" id="play_callout_' + id + '" title="' + __('Play Callout') + '">&#9658;&#65038; <span class="screen-reader-text">' + __('Play') + '</span></button>');
			new_callout_control.append('<button class="button del-callout-action btn-danger" id="del-callout-action_' + id + '" title="' + __('Delete Callout') + '"> x </button>');

			new_callout.append(new_callout_label);
			new_callout.append(new_callout_control);

			$('.callout-items').append(new_callout)
		}

		$('#add_callout').click(function (event) {
			add_callout();
		});

		$(document).on('click', '.play_callout', function (event) {
			var text = $(this).siblings('.callout_text').val();
			socket.emit('play_callout_text', {
				'callout': text
			});
		});

		$(document).on('click', '.del-callout-action', function (event) {
			$(this).parent().parent().remove();
			do_save_callouts();
			socket.emit('reload_callouts');  // reload to update hotkey assignments
		});

		// make 'Enter' key on input field trigger button
		$(document).on('keyup', '.callout_text', function(event) {
			if (event.keyCode === 13) {
				//
				$(this).siblings(".play_callout").click();
			}
		});

		// load callouts
		socket.on('callouts', function(msg) {
			clear_callout_items();
			for (i in msg) {
				add_callout(msg[i]);
			}
		})

		// save callouts
		function do_save_callouts() {
			var data = [];

			$('.callout-items>li').each(function(index){
				text = $(this).find('.callout_text').val().trim();
				if (text)
					data.push(text);
			})

			socket.emit('save_callouts', {
				'callouts': data
			});
		}

		$(document).on('change', '.callout_text', function (event) {
			do_save_callouts();
		});

		function clear_callout_items() {
			$('.callout-items>li').each(function(index){
				$(this).remove();
			})
		}

		/* Other */
		$('.open-mfp-popup-tuning').magnificPopup({
			type:'inline',
			midClick: true,
			callbacks: {
				open: function(){
					var node = $.magnificPopup.instance.st.el.data('node');
					var graph = $('#rssi-graph-' + node);
					$(this.content).find('.rssi-graph').append(graph);
				},
				close: function(){
					var node = $.magnificPopup.instance.st.el.data('node');
					var graph = $('#rssi-graph-' + node);
					$('.rssi-graph.page[data-node="' + node + '"]').prepend(graph);

					if (rotorhazard.nodes[node].graphPaused) {
						$('button.pause_graph[data-node=' + node + ']').click();
					}
				}
			}
		});

		/* positional RSSI adjustment */
		var canDrag = false;
		var isDragging = false;
		var startingEnter = false;
		var startingExit = false;
		var startingY = false;
		var adjustEnter = true;
		var isTouchEvent = false;

		function mapRange(val, start, end){
			return val * (end - start) / 1 + start;
		}

		function handleGraphInteractionStart(evt, node) {
			var offset = $(evt.target).offset()
			if (evt.targetTouches) {
				var y = (evt.targetTouches[0].pageY - offset.top) / evt.target.offsetHeight;
			} else {
				var y = (evt.pageY - offset.top) / evt.target.offsetHeight;
			}

			var rssi = parseInt(mapRange(y, rotorhazard.nodes[node].graph.options.maxValue, rotorhazard.nodes[node].graph.options.minValue));

			startingEnter = parseInt($('#set_enter_at_level_' + node).val());
			startingExit = parseInt($('#set_exit_at_level_' + node).val());
			startingY = y;

			var midPoint = (startingEnter + startingExit) >> 1;
			adjustEnter = (rssi >= midPoint);
		}

		function handleGraphInteractionMove(evt, node) {
			// user drags on graph
			var offset = $(evt.target).offset()
			if (evt.targetTouches) {
				var y = (evt.targetTouches[0].pageY - offset.top) / evt.target.offsetHeight;
			} else {
				var y = (evt.pageY - offset.top) / evt.target.offsetHeight;
			}

			if (Math.abs(y - startingY) > 0.01 || isDragging) { // prevent accidental drag
				isDragging = true;

				var rssi = parseInt(mapRange(y, rotorhazard.nodes[node].graph.options.maxValue, rotorhazard.nodes[node].graph.options.minValue));

				var enter_control = $('#set_enter_at_level_' + node);
				var exit_control = $('#set_exit_at_level_' + node);

				if (adjustEnter) {
					enter_control.val(rssi);
					enter_control.trigger('change');
					if (rssi < parseInt(exit_control.val()) + 2)  {
						exit_control.val(rssi - 2);
						exit_control.trigger('change');
					}
				} else {
					exit_control.val(rssi);
					exit_control.trigger('change');
					if (rssi > parseInt(enter_control.val()) - 2)  {
						enter_control.val(rssi + 2);
						enter_control.trigger('change');
					}
				}
			}
		}

		// mouse handlers
		$('.tuning-detail .rssi-graph').on('mousedown', function(evt){
			node = $(this).data('node')
			if (!isTouchEvent) {
				canDrag = true;
				handleGraphInteractionStart(evt, node);
			}
		})
		$('.tuning-detail .rssi-graph').on('mousemove', function(evt){
			node = $(this).data('node')
			if (!isTouchEvent) {
				if (canDrag) {
					handleGraphInteractionMove(evt, node);
					$('#recalc').trigger('click');
				}
			}
		})
		$('.tuning-detail .rssi-graph').on('mouseup', function(evt){
			node = $(this).data('node')
			if (!isTouchEvent) {
				canDrag = false;
				isDragging = false;
			}
			isTouchEvent = false;
		})
		$('.tuning-detail .rssi-graph').on('mouseout', function(evt){
			node = $(this).data('node')
			if (!isTouchEvent) {
				if (isDragging) {
					$('#set_enter_at_level_' + node).val(startingEnter);
					$('#set_enter_at_level_' + node).trigger('change');
					$('#set_exit_at_level_' + node).val(startingExit);
					$('#set_exit_at_level_' + node).trigger('change');
				}
			}
			isTouchEvent = false;
		});
		$(document).on('mouseup', function(){
			if (!isTouchEvent) {
				canDrag = false;
				isDragging = false;
			}
			isTouchEvent = false;
		});

		// touch handlers
		$('.tuning-detail .rssi-graph').on('touchstart', function(evt) {
			evt.preventDefault();
			node = $(this).data('node')
			if (evt.targetTouches.length == 1) { // pause if multi-touch detected
				handleGraphInteractionStart(evt, node);
				handleGraphInteractionMove(evt, node);
			}
			isTouchEvent = true;
		})
		$('.tuning-detail .rssi-graph').on('touchmove', function(evt) {
			evt.preventDefault();
			node = $(this).data('node')
			if (evt.targetTouches.length == 1) { // pause if multi-touch detected
				handleGraphInteractionMove(evt, node);
			}
		})
		$('.tuning-detail .rssi-graph').on('touchend', function(evt){
			evt.preventDefault();
			node = $(this).data('node')
			if (evt.targetTouches && evt.targetTouches.length == 0) { // end only when all touches end
			}
		})
		$('.tuning-detail .rssi-graph').on('touchCancel', function(evt) {
			evt.preventDefault();
			$('#set_enter_at_level_' + node).val(startingEnter);
			$('#set_enter_at_level_' + node).trigger('change');
			$('#set_exit_at_level_' + node).val(startingExit);
			$('#set_exit_at_level_' + node).trigger('change');
			isTouchEvent = true;
		});

		$(document).on('keyup', function(e) {
			// keyboard shortcuts
			switch (e.which) {
				case 83:  // S
					if ( this !== event.target && event.target.id !== "set_current_heat"
						&& event.target.id !== "set_race_format"
						&& ( /textarea|select/i.test( event.target.nodeName )
						 || event.target.type === "text") ) {
						return;
					}
					if (!e.ctrlKey && !e.altKey && !e.metaKey) {
						// race schedule: s
						$('#schedule_race').trigger('click');
					}
					break;
				case 90:  // Z
					if ( this !== event.target && event.target.id !== "set_current_heat"
						&& event.target.id !== "set_race_format"
						&& ( /textarea|select/i.test( event.target.nodeName )
						 || event.target.type === "text") ) {
						return;
					}
					if (!e.ctrlKey && !e.altKey && !e.metaKey) {
						// race start: z
						$('#start_race').trigger('click');
					}
					break;
				case 88:  // X
					if ( this !== event.target
						&& ( /textarea|select/i.test( event.target.nodeName )
						 || event.target.type === "text") ) {
						return;
					}
					if (!e.ctrlKey && !e.altKey && !e.metaKey) {
						// race stop: x
						$('#stop_race').trigger('click');
					}
					break;
				case 67:  // C
					if ( this !== event.target
						&& ( /textarea|select/i.test( event.target.nodeName )
						 || event.target.type === "text") ) {
						return;
					}
					if (!e.ctrlKey && !e.altKey && !e.metaKey) {
						// save laps: c
						$('#save_laps').trigger('click');
					}
					break;
				case 86:  // V
					if ( this !== event.target
						&& ( /textarea|select/i.test( event.target.nodeName )
						 || event.target.type === "text") ) {
						return;
					}
					if (!e.ctrlKey && !e.altKey && !e.metaKey) {
						// discard laps: v
						$('#discard_laps').trigger('click');
					}
					break;
				case 49:  // 1
					if (!e.ctrlKey && e.altKey && !e.metaKey) {
						// manual lap node 1: alt+1
						$('#manual_lap_0').trigger('click');
					} else if (e.ctrlKey && e.altKey && !e.metaKey) {
						// play callout 1: ctrl+alt+1
						if ($('#play_callout_1').length)
							$('#play_callout_1').trigger('click');
					}
					break;
				case 50:  // 2
					if (!e.ctrlKey && e.altKey && !e.metaKey) {
						// manual lap node 2: alt+2
						$('#manual_lap_1').trigger('click');
					} else if (e.ctrlKey && e.altKey && !e.metaKey) {
						// play callout 1: ctrl+alt+2
						if ($('#play_callout_2').length)
							$('#play_callout_2').trigger('click');
					}
					break;
				case 51:  // 3
					if (!e.ctrlKey && e.altKey && !e.metaKey) {
						// manual lap node 3: alt+3
						$('#manual_lap_2').trigger('click');
					} else if (e.ctrlKey && e.altKey && !e.metaKey) {
						// play callout 1: ctrl+alt+3
						if ($('#play_callout_3').length)
							$('#play_callout_3').trigger('click');
					}
					break;
				case 52:  // 4
					if (!e.ctrlKey && e.altKey && !e.metaKey) {
						// manual lap node 4: alt+4
						$('#manual_lap_3').trigger('click');
					} else if (e.ctrlKey && e.altKey && !e.metaKey) {
						// play callout 1: ctrl+alt+4
						if ($('#play_callout_4').length)
							$('#play_callout_4').trigger('click');
					}
					break;
				case 53:  // 5
					if (!e.ctrlKey && e.altKey && !e.metaKey) {
						// manual lap node 5: alt+5
						$('#manual_lap_4').trigger('click');
					} else if (e.ctrlKey && e.altKey && !e.metaKey) {
						// play callout 1: ctrl+alt+5
						if ($('#play_callout_5').length)
							$('#play_callout_5').trigger('click');
					}
					break;
				case 54:  // 6
					if (!e.ctrlKey && e.altKey && !e.metaKey) {
						// manual lap node 6: alt+6
						$('#manual_lap_5').trigger('click');
					} else if (e.ctrlKey && e.altKey && !e.metaKey) {
						// play callout 1: ctrl+alt+6
						if ($('#play_callout_6').length)
							$('#play_callout_6').trigger('click');
					}
					break;
				case 55:  // 7
					if (!e.ctrlKey && e.altKey && !e.metaKey) {
						// manual lap node 7: alt+7
						$('#manual_lap_6').trigger('click');
					} else if (e.ctrlKey && e.altKey && !e.metaKey) {
						// play callout 1: ctrl+alt+7
						if ($('#play_callout_7').length)
							$('#play_callout_7').trigger('click');
					}
					break;
				case 56:  // 8
					if (!e.ctrlKey && e.altKey && !e.metaKey) {
						// manual lap node 8: alt+8
						$('#manual_lap_7').trigger('click');
					} else if (e.ctrlKey && e.altKey && !e.metaKey) {
						// play callout 1: ctrl+alt+8
						if ($('#play_callout_8').length)
							$('#play_callout_8').trigger('click');
					}
					break;
				case 57:  // 9
					if (e.ctrlKey && e.altKey && !e.metaKey) {
						// play callout 1: ctrl+alt+9
						if ($('#play_callout_9').length)
							$('#play_callout_9').trigger('click');
					}
					break;
			}
		});

		$(document).on('keydown', function(e) {
			switch (e.which) {
				case 32:  // space bar
					if ( this !== event.target && event.target.id !== "set_current_heat"
						&& event.target.id !== "set_race_format"
						&& ( /textarea|select/i.test( event.target.nodeName )
						 || event.target.type === "text") ) {
						return;
					}
					if (!e.ctrlKey && !e.altKey && !e.metaKey) {
						if (!($('#start_race').prop('disabled'))) {
							$('#start_race').trigger('click');
						}
						else if (!($('#stop_race').prop('disabled'))) {
							$('#stop_race').trigger('click');
						}
						else if (!($('#save_laps').prop('disabled'))) {
							$('#save_laps').trigger('click');
						}
					}
					e.preventDefault();  // consume key event
					break;
			}
		});
	});

</script>
{% endblock %} {% block content %}
<main class="page-race">

<div id="main_panel" class="panel">
	<div class="panel-content full-width">
		<div class="timer">
			<div class="timing-clock">
				<div class="warning">
					<div class="symbol">&#9888;&#xFE0E; {{ __('Sync') }}</div>
					<div class="value">{{ __('Acquiring') }}</div>
				</div>
				<div class="time-display">--:--</div>
			</div>
		</div>

		<!--Buttons for controlling the race-->
		<div class="control-set">
			<label for="set_current_heat" class="screen-reader-text">{{ __('Current Heat') }}</label>
			<select id="set_current_heat">
				<option value="">{{ __('Loading...') }}</option>
			</select>
			<button id="start_race"><span class="narrow">{{ __('Start') }}</span><span class="wide">{{ __('Start Race') }}</span></button>
			<button id="stop_race" disabled="disabled"><span class="narrow">{{ __('Stop') }}</span><span class="wide">{{ __('Stop Race') }}</span></button>
			<button id="save_laps" disabled="disabled"><span class="narrow">{{ __('Save') }}</span><span class="wide">{{ __('Save and Clear') }}</span></button>
			<button id="discard_laps" disabled="disabled"><span class="narrow">{{ __('Discard') }}</span><span class="wide">{{ __('Discard Laps') }}</span></button>

			<label for="set_race_format" class="screen-reader-text">{{ __('Race Format') }}</label>
			<select id="set_race_format">
				<option>{{ __('Loading...') }}</option>
			</select>

			<span id="next-round"></span>
		</div>

		<div id="practice-warning" style="display:none">{{ __('Practice mode: Races will not be saved until a heat is selected') }}</div>

		<!--Display the race leaderboard-->
		<div id="leaderboard"></div>

		<div id="team_leaderboard"></div>

		<div class="race_status_message"></div>

		<!--Display the current laps-->
		<div class="race-results">
			{% for node in nodes %}
			<div class="node" id="node-{{ node.index }}">
				{% if vrx_enabled %}
					<div class="vrx-header">

					</div>
				{% endif %}
				<div class="race-header">
					<div class="channel-block" data-node="{{ node.index }}"><span class="ch"></span> <span class="fr">{{ node.freq }}</span></div>
					<button class="simulate_lap" id="manual_lap_{{ node.index }}" data-node="{{ node.index }}" title="{{ __('Manual') }}">+ {{ __('Lap') }}</button>
				</div>
				<a href="#tuning-detail-{{node.index}}" data-node="{{ node.index }}" class="open-mfp-popup-tuning" title="{{ __('Tune this node') }}">
					<div class="rssi-graph page" data-node="{{ node.index }}"><canvas id="rssi-graph-{{ node.index }}"></div>
				</a>
				<h4 class="callsign_{{ node.index }}">
					{{ __('Loading...') }}
				</h4>
				<div class="crossing crossing_flag_{{ node.index }}"><span>{{ __('Clear') }}</span></div>
				<table class="laps" id="current_laps_{{ node.index }}">
					<thead>
					</thead>
					<tbody>
					</tbody>
				</table>

				<div id="tuning-detail-{{node.index}}" class="tuning-detail mfp-hide popup">
					<h2>{{ __('Tuning: Node') }} {{ node.index + 1 }}</h2>
					<div class="popup-content">

						<div class="rssi-graph in-popup" data-node="{{ node.index }}">
							<button class="pause_graph" data-node="{{ node.index }}"><svg height="1em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><title>Pause</title><circle cx="8" cy="8" r="7.6" opacity=".8"/><path fill="#fff" d="M3.7 3.7H7v8.7H3.7z"/><path fill="#fff" d="M9 3.7h3.3v8.7H9z"/></svg></button>
						</div>
						<div class="crossing crossing_flag_{{ node.index }}"><span>{{ __('Clear') }}</span></div>

						<div class="node-controls">
							<div class="enter-exit-control">
								<label for="set_enter_at_level_{{ node.index }}">{{ __('EnterAt') }}</label>
								<input type="number" id="set_enter_at_level_{{ node.index }}" class="set_enter_at_level" data-node="{{ node.index }}" min="0" max="999">
								<button class="cap_enter_at_btn" data-node_index="{{ node.index }}">{{ __('Capture') }}</button>
							</div>

							<div class="enter-exit-control">
								<label for="set_exit_at_level_{{ node.index }}">{{ __('ExitAt') }}</label>
								<input type="number" id="set_exit_at_level_{{ node.index }}" class="set_exit_at_level" data-node="{{ node.index }}" min="0" max="999">
								<button class="cap_exit_at_btn" data-node_index="{{ node.index }}">{{ __('Capture') }}</button>
							</div>
						</div>
						<table>
							<tr class="datarow">
								<td>{{ __('RSSI') }}</td>
								<td>
									<span class="current_rssi_{{ node.index }}"></span>
								</td>
							</tr>
							<tr class="datarow">
								<td>{{ __('NodePeak') }}</td>
								<td>
									<span class="node_peak_rssi_{{ node.index }}"></span>
								</td>
							</tr>
							<tr class="datarow">
								<td>{{ __('NodeNadir') }}</td>
								<td>
									<span class="node_nadir_rssi_{{ node.index }}"></span>
								</td>
							</tr>
							<tr class="datarow">
								<td>{{ __('PassPeak') }}</td>
								<td>
									<span class="pass_peak_rssi_{{ node.index }}"></span>
								</td>
							</tr>
							<tr class="datarow">
								<td>{{ __('PassNadir') }}</td>
								<td>
									<span class="pass_nadir_rssi_{{ node.index }}"></span>
								</td>
							</tr>
							<tr class="datarow">
								<td>{{ __('PassCount') }}</td>
								<td>
									<span class="debug_pass_count_{{ node.index }}"></span>
								</td>
							</tr>
						</table>
						<div id="node_notice_{{ node.index }}"></div>
					</div>
				</div>
			</div>
			{% endfor %}
		</div>
	</div>
</div>

<!--Format and Sensor-->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Race Management') }}</h2>
	</div>
	<div class="panel-content">
		<ol class="form">
			<li>
				<div class="label-block">
					<label for="schedule_race_time">{{ __('Time Until Race Start') }}</label>
				</div>
				<div>
					<label for="schedule_m" class="screen-reader-text">{{ __('Minutes') }}</label><input type="number" id="schedule_m" min="0" max="999" placeholder="mm">:<label for="schedule_s" class="screen-reader-text">{{ __('Seconds') }}</label><input type="number" id="schedule_s" min="0" max="59" placeholder="ss"> <button id="schedule_race">{{ __('Schedule Race') }}</button> <button id="cancel_schedule_race">{{ __('Cancel') }}</button>
				</div>
			</li>
			<li>
				<div class="label-block">
					<label for="set_profile">{{ __('Profile') }}</label>
				</div>
				<select id="set_profile">
					<option>{{ __('Loading...') }}</option>
				</select>
			</li>
			<li>
				<div class="label-block">
					<label for="set_min_lap">{{ __('Minimum Lap Time') }}</label>
					<p class="desc">{{ __('In seconds') }}</p>
				</div>
				<input type="number" id="set_min_lap" min="0" max="999" value="{{ getOption('MinLapSec') }}">
			</li>
			<li>
				<div class="label-block">
					<label for="set_min_lap_behavior">{{ __('Minimum Lap Behavior') }}</label>
				</div>
				<select id="set_min_lap_behavior">
					<option value="0">{{ __('Highlight Short Laps') }}</option>
					<option value="1">{{ __('Discard New Short Laps') }}</option>
				</select>
			</li>
			<li id="coop-laps-control" hidden="hidden">
				<div class="label-block">
					<label for="heat_coop_num_laps_id">{{ __('Co-op Best # of Laps') }}</label>
				</div>
				<input id="heat_coop_num_laps_id" class="set_heat_coop_num_laps" type="number" step="1" min="0" />
			</li>
			<li id="coop-time-control" hidden="hidden">
				<div class="label-block">
					<label for="heat_coop_best_time_id">{{ __('Co-op Best Time') }}</label>
				</div>
				<input id="heat_coop_best_time_id" class="set_heat_coop_best_time" type="text" />
			</li>
		</ol>
	</div>
</div>

<!--Client Messaging-->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Send Message') }}</h2>
	</div>
	<div class="panel-content">
		<p><label for="message_body" class="screen-reader-text">{{ __('Message Body') }}</label>
		<input type="text" id="message_body" maxlength="256" placeholder="Message"></p>
		<p><label><input type="checkbox" id="message_interrupt"> {{ __('Pop-up Alert') }}{% if vrx_enabled %} {{ __('and Send to VRx') }}{% endif %}</label></p>
		<p><button id="send_message">{{ __('Send Message') }}</button></p>
	</div>
</div>

<!--Voice Settings-->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Audio Control') }}</h2>
	</div>
	<div class="panel-content">
		<p class="form-note">{{ __('Voice settings apply to this device only.') }}</p>
		<ol class="form">
			<li>
				<div class="label-block">
					<label for="set_voice_language">{{ __('Voice Select') }}</label>
				</div>
				<div id="voice_select"></div>
			</li>
			<li>
				<div class="label-block">
					<label for="set_voice_string_language">{{ __('Voice Language') }}</label>
				</div>
				<select id="set_voice_string_language">
					<option>{{ __('Loading...') }}</option>
				</select>
			</li>
			<li>
				<div class="label-block">
					{{ __('Announcements') }}
				</div>
				<li>
					<div class="label-block">
						<label for="voice_callsign">{{ __('Pilot Callsign') }}</label>
					</div>
					<select id="voice_callsign">
						<option value="0">{{ __('Never') }}</option>
						<option value="2">{{ __('Only on Non-Team/Non-Co-op Races') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_lap_count">{{ __('Pilot Lap Number') }}</label>
					</div>
					<select id="voice_lap_count">
						<option value="0">{{ __('Never') }}</option>
						<option value="2">{{ __('Only on Non-Team/Non-Co-op Races') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_lap_time">{{ __('Pilot Lap Time') }}</label>
					</div>
					<select id="voice_lap_time">
						<option value="0">{{ __('Never') }}</option>
						<option value="2">{{ __('Only on Non-Team/Non-Co-op Races') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_race_timer">{{ __('Race Clock') }}</label>
					</div>
					<select id="voice_race_timer">
						<option value="0">{{ __('Never') }}</option>
						<option value="2">{{ __('Only on Fixed-time Races') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_team_lap_count">{{ __('Team/Co-op Lap Total') }}</label>
					</div>
					<select id="voice_team_lap_count">
						<option value="0">{{ __('Never') }}</option>
						<option value="1">{{ __('On Team/Co-op Races') }}</option>
						<option value="2">{{ __('On Team/Co-op Races (short call)') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_race_winner">{{ __('Race Winner') }}</label>
					</div>
					<select id="voice_race_winner">
						<option value="0">{{ __('Never') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_if_node_finished">{{ __('Laps After Pilot Done') }}</label>
					</div>
					<select id="voice_if_node_finished">
						<option value="0">{{ __('Never') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				{% if cluster_has_secondaries %}
				<li>
					<div class="label-block">
						<label for="voice_split_timer">{{ __('Secondary/Split Timer') }}</label>
					</div>
					<select id="voice_split_timer">
						<option value="0">{{ __('None') }}</option>
						<option value="1">{{ __('Pilot Name') }}</option>
						<option value="5">{{ __('Pilot Name, Split Value') }}</option>
						<option value="3">{{ __('Pilot Name, Split ID') }}</option>
						<option value="7">{{ __('Pilot Name, Split ID, Split Value') }}</option>
						<option value="2">{{ __('Split ID') }}</option>
						<option value="4">{{ __('Split Time') }}</option>
						<option value="6">{{ __('Split ID, Split Time') }}</option>
					</select>
				</li>
				{% endif %}
				<li>
					<div class="label-block">
						<label for="voice_race_leader">{{ __('Race Leader Pilot') }}</label>
					</div>
					<select id="voice_race_leader">
						<option value="0">{{ __('None') }}</option>
						<option value="1">{{ __('After 1 Second') }}</option>
						<option value="2">{{ __('After 2 Seconds') }}</option>
						<option value="3">{{ __('After 3 Seconds') }}</option>
						<option value="4">{{ __('After 4 Seconds') }}</option>
						<option value="5">{{ __('After 5 Seconds') }}</option>
						<option value="6">{{ __('After 6 Seconds') }}</option>
						<option value="7">{{ __('After 7 Seconds') }}</option>
						<option value="8">{{ __('After 8 Seconds') }}</option>
						<option value="9">{{ __('After 9 Seconds') }}</option>
						<option value="10">{{ __('After 10 Seconds') }}</option>
						<option value="11">{{ __('After 11 Seconds') }}</option>
						<option value="12">{{ __('After 12 Seconds') }}</option>
						<option value="13">{{ __('After 13 Seconds') }}</option>
						<option value="14">{{ __('After 14 Seconds') }}</option>
						<option value="15">{{ __('After 15 Seconds') }}</option>
						<option value="16">{{ __('After 16 Seconds') }}</option>
						<option value="17">{{ __('After 17 Seconds') }}</option>
						<option value="18">{{ __('After 18 Seconds') }}</option>
						<option value="19">{{ __('After 19 Seconds') }}</option>
					</select>
				</li>
			</li>
			<li>
				<div class="label-block">
					<label for="set_voice_volume">{{ __('Voice Volume') }}</label>
					<p class="desc">{{ __('Volume') }}: <span id="voice_volume_value"></span></p>
				</div>
				<input type="range" id="set_voice_volume" min="0" max="100">
			</li>
			<li>
				<div class="label-block">
					<label for="set_voice_rate">{{ __('Voice Rate') }}</label>
					<p class="desc">{{ __('Rate') }}: <span id="voice_rate_value"></span></p>
				</div>
				<input type="range" id="set_voice_rate" min="0" max="2.0" step="0.01">
			</li>
			<li>
				<div class="label-block">
					<label for="set_voice_pitch">{{ __('Voice Pitch') }}</label>
					<p class="desc">{{ __('Pitch') }}: <span id="voice_pitch_value"></span></p>
				</div>
				<input type="range" id="set_voice_pitch" min="0" max="2.0" step="0.01">
			</li>
			<li>
				<div class="label-block">
					<label for="set_tone_volume">{{ __('Tone Volume') }}</label>
					<p class="desc">{{ __('Volume') }}: <span id="tone_volume_value"></span></p>
				</div>
				<input type="range" id="set_tone_volume" min="0" max="100">
			</li>
			<li>
				<div class="label-block">
					{{ __('Indicator Beeps') }}
				</div>
				<ul>
					<li><label><input type="checkbox" id="beep_on_first_pass_button"> {{ __('On First Pass') }}</label></li>
					<li><label><input type="checkbox" id="beep_crossing_entered"> {{ __('Crossing Entered') }}</label></li>
					<li><label><input type="checkbox" id="beep_crossing_exited"> {{ __('Crossing Exited') }}</label></li>
					<li><label><input type="checkbox" id="beep_manual_lap_button"> {{ __('Manual Lap Button') }}</label></li>
					<li><label><input type="checkbox" id="beep_race_leader_lap"> {{ __('Race Leader Lap') }}</label></li>
					<li><label><input type="checkbox" id="beep_race_winner_declared"> {{ __('Race Winner Declared') }}</label></li>
					{% if cluster_has_secondaries %}
					<li><label><input type="checkbox" id="beep_cluster_connect"> {{ __('Secondary Timer Connect / Disconnect') }}</label></li>
					{% endif %}
					<li><label><input type="checkbox" id="use_mp3_tones"> {{ __('Use MP3 Tones instead of synthetic tones') }}</label></li>
				</ul>
			</li>
			<li>
				<div class="label-block">
					<label for="set_indicator_volume">{{ __('Indicator Beeps Volume') }}</label>
					<p class="desc">{{ __('Volume') }}: <span id="indicator_volume_value"></span></p>
				</div>
				<input type="range" id="set_indicator_volume" min="0" max="100">
			</li>
		</ol>
		<br>
		<div class="control-set">
			<div>
				<button class="button" id="export_audio_settings">{{ __('Export Audio Settings') }}</button> &nbsp;
				<button data-mfp-src="#audio_settings_defaults_confirm" class="open-mfp-popup">{{ __('Set Audio Settings to Defaults') }}</button>
			</div>
			<div>
				<label for="select_audio_import_file"><span style="font-weight:bold">{{ __('Select File to Import') }}: </span></label>
				<input type="file" id="select_audio_import_file" accept=".cfg" />
				<button id="import_audio_settings" class="btn-danger" disabled="disabled">{{ __('Import Audio Settings') }}</button>
			</div>
		</div>
		<div id="audio_settings_defaults_confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Confirm') }}</h2>
			<div class="popup-content">
				<p>{{ __('This will overwrite all audio settings. Are you sure?') }}</p>
				<p><button class="btn-danger" id="default_audio_settings">{{ __('Set Defaults') }}</button>
					<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>
	</div>
</div>

<!--Display Settings-->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Display Settings') }}</h2>
	</div>
	<div class="panel-content">
		<p class="form-note">{{ __('Display settings apply to this device only.') }}</p>
		<ol class="form">
			<li>
				<div class="label-block">
					{{ __('Lap Information') }}
				</div>
				<ul>
					<li><label><input type="checkbox" id="display_lap_id"> {{ __('Lap number') }}</label></li>
					<li><label><input type="checkbox" id="display_time_start"> {{ __('Time since start') }}</label></li>
					<li><label><input type="checkbox" id="display_time_first_pass"> {{ __('Time since first pass') }}</label></li>
					<li><label><input type="checkbox" id="display_laps_reversed"> {{ __('Lap order reversed') }}</label></li>
				</ul>
			</li>
			<li>
				<div class="label-block">
					{{ __('Performance') }}
				</div>
				<ul>
					<li><label><input type="checkbox" id="hide_graphs"> {{ __('RSSI Graphs') }}</label></li>
				</ul>
			</li>
		</ol>
	</div>
</div>

<!--LED Controls-->
{% if led_enabled %}
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('LED Control') }}</h2>
	</div>
	<div class="panel-content">
		<div class="control-set">
			<button class="LED-off">{{ __('Turn Off') }}</button>
		</div>

		<div class="control-set">
			<button class="LED-color color-picker" data-rgb="#0022ff" style="background-color:#0022ff"></button>
			<button class="LED-color color-picker" data-rgb="#ff5500" style="background-color:#ff5500"></button>
			<button class="LED-color color-picker" data-rgb="#00ff22" style="background-color:#00ff22"></button>
			<button class="LED-color color-picker" data-rgb="#ff0055" style="background-color:#ff0055"></button>
			<button class="LED-color color-picker" data-rgb="#ddff00" style="background-color:#ddff00"></button>
			<button class="LED-color color-picker" data-rgb="#7700ff" style="background-color:#7700ff"></button>
			<button class="LED-color color-picker" data-rgb="#00ffdd" style="background-color:#00ffdd"></button>
			<button class="LED-color color-picker" data-rgb="#aaaaaa" style="background-color:#aaaaaa"></button>
		</div>

		<ol class="form">
			<li>
				<div class="label-block">
					<label for="set_led_brightness">{{ __('LED Brightness') }}</label>
					<p class="desc">{{ __('Level') }}: <span id="led_brightness_value"></span></p>
				</div>
				<input type="range" id="set_led_brightness" min="1" max="25">
			</li>
		</ol>

		<div id="LED-effects"></div>
	</div>
</div>
{% endif %}

<!--Voice Callouts-->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Callouts') }}</h2>
	</div>
	<div class="panel-content">
		<ol class="form callout-items">
		</ol>

		<div class="control-set">
			<button class="button" id="add_callout">{{ __('Add Callout') }}</button>
		</div>

		<p class="form-note">
			%HEAT% : {{ __('Current heat name') }}<br />
			%PILOTS% : {{ __('Current pilot names') }}<br />
			%LINEUP% : {{ __('Current pilot names') }} ({{ __('faster') }}) <br />
			%FREQS% : {{ __('Frequencies with current pilot assignments') }}
		</p>
	</div>
</div>

<!-- Status -->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Status') }}</h2>
	</div>
	<div class="panel-content">
		<h3>{{ __('Cluster Status') }}</h3>
		<div id="cluster-status" class="control-set">
			<p>{{ __('No cluster status available.') }}</p>
		</div>
		<h3>{{ __('Environment Status') }}</h3>
		<div id="env-data-table" class="control-set">
			<p>{{ __('No environment status available.') }}</p>
		</div>
	</div>
</div>

<!-- Custom UI -->
<div id="custom-ui"></div>

<button id="audio-unlock">{{ __('Enable Audio') }}</button>
</main>
{% endblock %}
