{% extends "layout-basic.html" %} {% block title %}{{ __('Stream') }}: {{ __('Seat') }}{% endblock %}{% block head %}
<link rel="stylesheet" href="/static/streamnode.css?{{ serverInfo['release_version'] | urlencode }}"></link>

<script type="text/javascript" charset="utf-8">
	var data_dependencies = [
		'all_languages',
		'language',
		'race_format',
		'leaderboard',
		'current_laps',
		'current_heat'
	];

	rotorhazard.show_messages = false;
	var streamnode = 1;
	var heatScheduleMinute = 5;
	var heatScheduleSecond = 5;
	var lastHeat = null;
	var currentScene = "";
	var launchDelay = 7;
	var raceFeedSceneName = "Race - Mixed";
	var eventResultsSceneName = "Event - Results";
	var raceResultsSceneName = "Race - Results";
	var pilotCardsSceneName = "Pilot Intro";
	var launchSceneName = "Race - Launch";
	var commentatorSceneName = "Event - Commentators";
	var FPVSourceNames = "Node{N}-{analog,HD0,DJI}"
	var obsURL = "ws://localhost:4444";

	var obsSocket = new WebSocket(obsURL);
	var obsRecvListeners = [];
	$(document).ready(function () {
		rotorhazard.show_messages = false;


		(function () {
			var old = console.log;
			var logger = document.getElementById('log');
			var date = new Date();
			var logTime = date.toLocaleString('en-US', { hour12: false });
			console.log = function (message) {
				if (typeof message == 'object') {
					logger.innerHTML += '['+logTime+'] '+(JSON && JSON.stringify ? JSON.stringify(message) : message) + '<br />';
				} else {
					logger.innerHTML += '['+logTime+'] '+message + '<br />';
				}
			}
		})();

		console.log("Heat Schedule (Minutes): "+heatScheduleMinute);
		console.log("Heat Schedule (Seconds): "+heatScheduleSecond);
		console.log("Launch Delay: "+launchDelay);
		console.log("FPV feed source names: "+FPVSourceNames);
		console.log("Race feed scene name: "+raceFeedSceneName);
		console.log("Results scene name: "+eventResultsSceneName);
		console.log("Race Results scene name: "+raceResultsSceneName);
		console.log("Launch scene name: "+launchSceneName);
		console.log("Commentator scene name: "+commentatorSceneName);
		console.log("Next heat pilot cards scene name: "+pilotCardsSceneName);
		console.log("URL to the remote (or local) OBS instance: "+obsURL);
		console.log("");

		$('#heatScheduleFieldMinute').val(heatScheduleMinute);
		$('#heatScheduleFieldSecond').val(heatScheduleSecond);
		$('#launchDelayField').val(launchDelay);
		$('#raceFeedField').val(raceFeedSceneName);
		$('#commentatorField').val(commentatorSceneName);
		$('#heatResultsField').val(eventResultsSceneName);
		$('#raceResultsField').val(raceResultsSceneName);
		$('#launchField').val(launchSceneName);

		//let the user update the scene names we are switching to
		const launchDelayInput = document.querySelector('#launchDelayField');
		launchDelayInput.addEventListener('input', updateLaunchDelayValue);
		function updateLaunchDelayValue(e) {
		  launchDelay = e.target.value;
			console.log("updating launch delay: "+launchDelay);
		}

		const commentatorInput = document.querySelector('#commentatorField');
		commentatorInput.addEventListener('input', updateCommentatorSceneValue);
		function updateCommentatorSceneValue(e) {
		  commentatorSceneName = e.target.value;
			console.log("updating launch commentator scene name: "+commentatorSceneName);
		}

		const heatResultsInput = document.querySelector('#heatResultsField');
		heatResultsInput.addEventListener('input', updateHeatResultsValue);
		function updateHeatResultsValue(e) {
		  eventResultsSceneName = e.target.value;
			console.log("updating heat results scene name: "+eventResultsSceneName);
		}

		const raceResultsInput = document.querySelector('#raceResultsField');
		raceResultsInput.addEventListener('input', updateRaceResultsValue);
		function updateRaceResultsValue(e) {
		  raceResultsSceneName = e.target.value;
			console.log("updating race results scene name: "+raceResultsSceneName);
		}

		const launchInput = document.querySelector('#launchField');
		launchInput.addEventListener('input', updateValue);
		function updateValue(e) {
		  launchSceneName = e.target.value;
			console.log("updating launch cam scene name: "+launchSceneName);
		}

		socket.on('language', function (msg) {
			if (msg.language) {
				rotorhazard.interface_language = msg.language;
			}
		});

		function sleep(milliseconds){
			const date = Date.now();
			let currentDate = null;
			do {
				currentDate = Date.now();
			}while(currentDate-date < milliseconds);
		}

		socket.on('race_status', function(msg) {
			var raceStatus = msg['race_status'];
			if(raceStatus==3){ //race is counting down, lets double check were on the right scene and have the right feeds
				if (lastHeat!=null){
					setScene(launchSceneName);
					setTimeout(() => {setScene(raceFeedSceneName);}, (launchDelay*1000));
			    setTimeout(() => {applyHeatToOBS(lastHeat);}, (launchDelay*1000)+100);
				}
			}
			if(raceStatus==0){ //Race Director hit save or discard, lets switch back to FPV feeds in 10 seconds and update
				if (lastHeat!=null){
					setTimeout(() => { if(currentScene!=raceFeedSceneName && currentScene!=launchSceneName){setScene(eventResultsSceneName);} }, 10000);
					setTimeout(() => { if(currentScene!=raceFeedSceneName && currentScene!=launchSceneName){setScene(pilotCardsSceneName);} }, 20000);
					setTimeout(() => { if(currentScene!=raceFeedSceneName && currentScene!=launchSceneName){setScene(commentatorSceneName);} }, 30000);
				}
				socket.emit("schedule_race",{"m": parseInt($('#heatScheduleFieldMinute').val()), "s": parseInt($('#heatScheduleFieldSecond').val())});

			}
			if(msg['race_status']==2){ //race just stopped
				setScene(raceResultsSceneName);
			}
		});

		//the race director has selected a new heat
		socket.on('current_heat', function(msg) {
			lastHeat = msg;
			applyHeatToOBS(msg);
		});

		function applyHeatToOBS(msg){
			console.log("updating video systems");
			var videoSystems = ["analog","HD0","DJI"];
			var nodeVideoSystems = [];
			var heatNodes = msg.heatNodes;
			for (var key in heatNodes){
				var callsign = heatNodes[key].callsign;
				var videoSystem = heatNodes[key].videoSystem;
				console.log("-pilot: "+callsign);
				//nodeVideoSystems.append({"callsign":callsign, "videoSystem":videoSystem});
			      	console.log("--enabling "+videoSystem);
				enableStreamItem("Node"+(parseInt(key)+1)+"-"+videoSystem);
			      	var itemsToDisable = videoSystems.filter(e => e !== videoSystem);
				for (var j = 0; j < itemsToDisable.length; j++){
			      		var itemToDisable = itemsToDisable[j];
					console.log("--disabling "+itemToDisable);
			      		disableStreamItem("Node"+(parseInt(key)+1)+"-"+itemToDisable);
				}
			}
		};

		function setScene(sceneName){
			console.log("changing scene: "+sceneName);
			sendOBSCommand("SetCurrentScene",{"scene-name":sceneName});
			currentScene = sceneName;
		}

		function enableStreamItem(itemName){
			//console.log("sending obs command");
			var requestType = "SetSceneItemProperties";
			var requestData = {"item":itemName, "visible":true};
			//console.log("sending "+requestType+", "+JSON.stringify(requestData,null,2));
			sendOBSCommand(requestType,requestData);
		};

		function disableStreamItem(itemName){
			//console.log("sending obs command");
			var requestType = "SetSceneItemProperties";
			var requestData = {"item":itemName, "visible":false};
			//console.log("sending "+requestType+", "+JSON.stringify(requestData,null,2));
			sendOBSCommand(requestType,requestData);
		};

		async function sha256(message) {
			const msgBuffer = new TextEncoder().encode(message);
			const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
			const hashArray = Array.from(new Uint8Array(hashBuffer));
			const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
			return hashHex;
		}

		function sendIdentity(password, msg, params){
			var salt = msg['authentication']['salt'];
			var challange = msg['authentication']['challenge'];
			var secret = window.btoa(unescape(encodeURIComponent(sha256(encodeURI(password+salt)))));
			var encodedAuthString = window.btoa(unescape(encodeURIComponent(secret+encodeURI(challange))));
			var decodedAuthString = window.btoa(unescape(encodeURIComponent(encodedAuthString)));
			console.log("sending identity message");
			obsSocket.send(decodedAuthString);
		}

		function sendOBSCommand(requestType, data){
			var payload = data;
			//var payload = {"message-id":crypto.randomUUID(), "request-type":"GetVersion"};
			data["message-id"] = new Date().getTime();
			data["request-type"] = requestType;
			try {
				obsSocket.send(JSON.stringify(data));
			}catch(err){
				console.error(err, err.stack);
			}

		}

		obsSocket.onmessage = function(msg) {
			obsSocket.onopen = function(){
			      	var incoming_payload = msg;
			      	var op_code = incoming_payload['op'];
			      	var data_payload = incoming_payload['d'];
			      	if ((op_code == 7) || (op_code == 9)){
			      		var payload_request_id = data_payload['requestId'];
			      		//if (payload_request_id.startswith('emit_')){
			      		//	continue;
			      		//}
					obsRecvListeners[payload_request_id]();
			      	}
				if (op_code == 5){
			      		console.log("event");
			      	}
			      	if (op_code == 0){
					console.log("identifying");
			      		console.log(data_payload);
			      		var obsPassword = "";
			      		var obsParams = "";
			      		sendIdentity(obsPassword, data_payload, obsParams);
			      	}
			      	if (op_code == 2){
			      		console.log("identity confirmed");
			      	}
				var msgContent = {"update-type":"SetSceneItemProperties", "item":"Node1-"+videoSystem, "visible":true};
				obsSocket.send(msgContent);
			};

		};
		/*socket.on('leaderboard', function (msg) {
			var race = msg.current.leaderboard;

			primary_leaderboard = race.meta.primary_leaderboard;
			leaderboard = race[primary_leaderboard];

			found_streamnode = false;

			videoSystemData = leaderboard;
		});*/

		socket.on('race_format', function (msg) {
			rotorhazard.race_formats = msg;
		});
	});


</script>
{% endblock %} {% block content %}
<p>
	<label for="heatScheduleFieldMinute">Heat Schedule</label>
	<input type="number" id="heatScheduleFieldMinute" name="heatScheduleFieldMinute" min="1" max="60">
	<input type="number" id="heatScheduleFieldSecond" name="heatScheduleFieldSecond" min="0" max="59">
</p>
<p>
	<label for="launchDelayField">Launch Cam Delay</label>
	<input type="number" id="launchDelayField" name="launchDelayField" min="1" max="15">
</p>
<p>
	<label for="raceFeedField">Race Feed Scene</label>
	<input type="text" id="raceFeedField" name="raceFeedField">
</p>
<p>
	<label for="commentatorField">Commentator Scene</label>
	<input type="text" id="commentatorField" name="commentatorField">
</p>
<p>
	<label for="heatResultsField">Heat Results Scene</label>
	<input type="text" id="heatResultsField" name="heatResultsField">
</p>
<p>
	<label for="raceResultsField">Race Results Scene</label>
	<input type="text" id="raceResultsField" name="raceResultsField">
</p>
<p>
	<label for="launchField">Launch Cam Scene</label>
	<input type="text" id="launchField" name="launchField">
</p>
<div id="pilot-info" style="left: auto;">
	<div id="callsign"></div>
</div>
<div id="log" style="font-family: lucida console; font-size: 0.9rem;"></div>
{% endblock %}
