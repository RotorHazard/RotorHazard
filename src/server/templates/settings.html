{% extends "layout.html" %} {% block title %}{{ __('Settings') }}{% endblock %} {% block head %}
<script type="text/javascript" src="./static/Blob.js"></script>
<script type="text/javascript" src="./static/FileSaver.min.js"></script>
<script type="text/javascript" src="{{ url_for('static', filename='showdown-1.9.1/showdown.min.js') }}"></script>

<script type="text/javascript" charset="utf-8">
	var data_dependencies = [
		'all_languages',
		'language',
		{
			'type': 'ui',
			'value': 'settings'
		},
		'node_data',
		'environmental_data',
		'frequency_data',
		'node_tuning',
		'enter_and_exit_at_levels',
		'start_thresh_lower_amount',
		'start_thresh_lower_duration',
		'action_setup',
		'event_actions',
		'led_effects',
		'led_effect_setup',
		'cluster_status',
		'vrx_list',
		'upd_cfg_files_list',
		'exporter_list',
		'plugin_list',
		{
			'type': 'config',
			'value': {
				'GENERAL': ['SECONDARIES'],
				'SENSORS': [],
			}
		}
	];

	var volume_logsl = new LogSlider({maxpos: 100, minval: MIN_LOG_VOLUME, maxval: MAX_LOG_VOLUME});
	var brightness_logsl = new LogSlider({maxpos: 25, minval: 5, maxval: 255});
	var heat_to_unlock = null;
	var class_to_unlock = null;

	$(document).ready(function () {
		socket.on('language', function (msg) {
			$('#set_language').empty();
			$('#set_language').append('<option value="">English</option>')
			for (var i = 0; i < msg.languages.length; i++) {
				$('#set_language').append('<option value="' + msg.languages[i].id +'">' + msg.languages[i].name + '</option>')
			}

			$('#set_voice_string_language').empty();
			$('#set_voice_string_language').append('<option value="match-timer">' + __('(Match Timer Language)') + '</option>')
			$('#set_voice_string_language').append('<option value="">English</option>')
			for (var i = 0; i < msg.languages.length; i++) {
				$('#set_voice_string_language').append('<option value="' + msg.languages[i].id +'">' + msg.languages[i].name + '</option>')
			}
			$('#set_voice_string_language').val(rotorhazard.voice_string_language);

			if (msg.language) {
				rotorhazard.interface_language = msg.language;
				$('#set_language').val(msg.language);
			} else {
				$('#set_language').selectedIndex = 0;
			}
		});

		var heartbeatCounter = 0;

		// set admin flag
		rotorhazard.admin = true;
		rotorhazard.saveData();
		$('nav li').removeClass('admin-hide');

		// populate voice controls
		var populate_audio_settings = function() {
			$('#voice_callsign').val(rotorhazard.voice_callsign);
			$('#voice_lap_count').val(rotorhazard.voice_lap_count);
			$('#voice_team_lap_count').val(rotorhazard.voice_team_lap_count);
			$('#voice_lap_time').val(rotorhazard.voice_lap_time);
			$('#voice_race_timer').val(rotorhazard.voice_race_timer);
			$('#voice_race_winner').val(rotorhazard.voice_race_winner);
			$('#voice_if_node_finished').val(rotorhazard.voice_if_node_finished);
			$('#voice_split_timer').val(rotorhazard.voice_split_timer);
			$('#voice_race_leader').val(rotorhazard.voice_race_leader);
			$().articulate('volume', rotorhazard.voice_volume);
			$('#set_voice_volume').val(volume_logsl.position(rotorhazard.voice_volume));
			$('#voice_volume_value').html($('#set_voice_volume').val());
			$().articulate('rate', rotorhazard.voice_rate);
			$('#voice_rate_value').html(rotorhazard.voice_rate.toFixed(2));
			$('#set_voice_rate').val(rotorhazard.voice_rate);
			$().articulate('pitch', rotorhazard.voice_pitch);
			$('#voice_pitch_value').html(rotorhazard.voice_pitch.toFixed(2));
			$('#set_voice_pitch').val(rotorhazard.voice_pitch);
			$('#set_tone_volume').val(volume_logsl.position(rotorhazard.tone_volume));
			$('#tone_volume_value').html($('#set_tone_volume').val());
			$('#beep_crossing_entered').prop("checked", rotorhazard.beep_crossing_entered);
			$('#beep_crossing_exited').prop("checked", rotorhazard.beep_crossing_exited);
			$('#beep_manual_lap_button').prop("checked", rotorhazard.beep_manual_lap_button);
			$('#beep_race_leader_lap').prop("checked", rotorhazard.beep_race_leader_lap);
			$('#beep_race_winner_declared').prop("checked", rotorhazard.beep_race_winner_declared);
			$('#beep_cluster_connect').prop("checked", rotorhazard.beep_cluster_connect);
			$('#use_mp3_tones').prop("checked", rotorhazard.use_mp3_tones);
			$('#beep_on_first_pass_button').prop("checked", rotorhazard.beep_on_first_pass_button);
			$('#set_indicator_volume').val(volume_logsl.position(rotorhazard.indicator_beep_volume));
			$('#indicator_volume_value').html($('#set_indicator_volume').val());
			$('#set_voice_string_language').val(rotorhazard.voice_string_language);
			if (!rotorhazard.voice_language) {  // if no current default then select first English voice
				rotorhazard.voice_language = get_default_articulate_voice();
				rotorhazard.saveData();
				if ($('#set_voice_language').children('option').length > 0) {
					$('#set_voice_language').val(rotorhazard.voice_language);
				}
			} else {
				if ($('#set_voice_language').children('option').length > 0) {
					$('#set_voice_language').val(rotorhazard.voice_language);
					if (!($('#set_voice_language').val())) {  // if no match then select first English voice
						rotorhazard.voice_language = get_default_articulate_voice();
						rotorhazard.saveData();
						$('#set_voice_language').val(rotorhazard.voice_language);
					}
				}
			}
		};
		populate_audio_settings();

		if ('{{ getConfig('LED', 'ledBrightness') }}' != 'False') {
			$('#set_led_brightness').val(brightness_logsl.position( {{ getConfig('LED', 'ledBrightness') }} ));
			$('#led_brightness_value').html($('#set_led_brightness').val());
		}

		if ('{{ getConfig('TIMING', 'calibrationMode') }}' == '1') {
			$('#set_calibrationMode').val(1);
		}

		if ('{{ getOption('pilotSort') }}' == 'callsign') {
			$('#set_pilotSort').val('callsign');
		}

		$('#unlock_race_format_button').html(svg_asset.lock);

		// populate frequency selects
		$('.frequency_table').each(function(){
			$(this).html(freq.buildSelect());
		});

		// set up node local store
		for (var i = 0; i < {{ num_nodes }}; i++) {
			rotorhazard.nodes[i] = new nodeModel();
			// start RSSI graphing
			rotorhazard.nodes[i].canvas = document.getElementById('rssi-graph-' + i);
			rotorhazard.nodes[i].setup(rotorhazard.nodes[i].canvas);
		}

		// set up markdown converter
		var panel_converter = new showdown.Converter({
			ghCodeBlocks: true,
			ghCompatibleHeaderId: true,
			literalMidWordUnderscores: true,
			simpleLineBreaks: true,
			headerLevelStart: 3
		});

		socket.on('update_server_messages', function (str) {
			$('#server_messages').html(str);
		});

		socket.on('ui', function (msg) {
			if (msg.page == 'settings') {
				$('#custom-ui').empty();

				for (var i in msg.panels) {
					var panel = msg.panels[i];

					var panel_el = $('<div class="panel collapsing active">');
					panel_el.attr('id', 'ui-custom-' + panel.panel.name);
					var panel_header_el = $('<div class="panel-header">');
					panel_header_el.append('<h2><button class="no-style">' + panel.panel.label + '</button></h2>');
					var panel_content_el = $('<div class="panel-content">');

					// panel open/close
					if (panel.panel.open) {
						panel_el.addClass('open');
						panel_content_el.show();
					} else {
						panel_el.removeClass('open');
						panel_content_el.hide();
					}

					// add markdown content
					for (var md_idx in panel.markdowns) {
						md_content = panel.markdowns[md_idx].desc;
						md_output = panel_converter.makeHtml(md_content);
						md_element = $('<div class="ui-md-el">').html(md_output);
						panel_content_el.append(md_element);
					}

					var form_el = $('<ol class="form">');

					for (var f_idx in panel.settings) {
						var settings = { ...panel.settings[f_idx] };

						settings.wrapperEl = 'li';
						settings.fieldClass = 'set_ui_option';
						settings.data = {
							field: settings.name,
							section: settings.section
						}

						var field = rhui.buildField(settings);

						form_el.append(field);
					}
					panel_content_el.append(form_el);
					panel_content_el.append(rhui.buildQuickbuttons(panel.quickbuttons));

					panel_el.append(panel_header_el);
					panel_el.append(panel_content_el);

					$('#custom-ui').append(panel_el);
				}

				// load panel state
				for (var panel in rotorhazard.panelstates) {
					var panel_obj = $('#' + panel);
					var panelstate = rotorhazard.panelstates[panel];

					if (panelstate) {
						panel_obj.addClass('open');
						panel_obj.children('.panel-content').stop().slideDown();
					} else {
						panel_obj.removeClass('open');
						panel_obj.children('.panel-content').stop().slideUp();
					}
				}
			}
		});

		$(document).on('change', '.set_ui_option', function (event) {
			var field = $(this).data('field');
			var section = $(this).data('section');
			var value = rhui.getFieldVal(this);

			if (section) {
				var data = {
					section: section,
					key: field,
					value: value
				};
				socket.emit('set_config', data);
			} else {
				var data = {
					option: field,
					value: value
				};
				socket.emit('set_option', data);
			}
		});

		socket.on('heartbeat', function (msg) {
			if (++heartbeatCounter >= 2) {   //do these updates less often than speak-queue checks
				heartbeatCounter = 0;
				for (var i = 0; i < msg.current_rssi.length; i++) {
					var rssiValue = msg.current_rssi[i];

					if (rotorhazard.nodes[i].fObj.frequency == 0) {
						rssiValue = 0;
					}

					$('.current_rssi_' + i).html(rssiValue);

					if (msg.crossing_flag[i]) {
						$('.crossing_flag_' + i).addClass('is-crossing').html(__('Crossing'));
					}
					else {
						$('.crossing_flag_' + i).removeClass('is-crossing').html(__('Clear'));
					}

					rotorhazard.nodes[i].graph.options.maxValue = Math.max(
						rssiValue,
						rotorhazard.nodes[i].node_peak_rssi + 1,
						rotorhazard.nodes[i].enter_at_level + 10,
					);

					rotorhazard.nodes[i].graph.options.minValue = Math.max(0, Math.min(
						rssiValue,
						rotorhazard.nodes[i].node_nadir_rssi - 1,
						rotorhazard.nodes[i].exit_at_level - 10,
					));

					if (!rotorhazard.nodes[i].graphing && rssiValue) {
						rotorhazard.nodes[i].graphing = true;
						rotorhazard.nodes[i].graph.options.maxValue = rssiValue + 100;
						rotorhazard.nodes[i].graph.options.minValue = Math.max(0, rssiValue - 10);
					}

					if (rotorhazard.nodes[i].graphing) {
						rotorhazard.nodes[i].series.append(new Date().getTime(), rssiValue);
						if (msg.crossing_flag[i]) {
							rotorhazard.nodes[i].crossingSeries.append(new Date().getTime(), 500);
						} else{
							rotorhazard.nodes[i].crossingSeries.append(new Date().getTime(), -10);
						}
					}
				}
			}
		});

		socket.on('environmental_data', function (msg) {
			var env_table_html = '';
			for (i=0; i<msg.length; i++) {
				var sensor = msg[i];
				var name = Object.keys(sensor)[0];
				var data = sensor[name];
				var values = '';
				var br = '';
				for (var reading in data) {
					var value = data[reading].value;
					var units = data[reading].units;
					values += br;
					if (reading == 'voltage') {
						values += __('Voltage: ') + Number(value).toFixed(2)+units;
					} else if(reading == 'current') {
						values += __('Current: ') + Number(value).toFixed(0)+units;
					} else if(reading == 'power') {
						values += __('Power: ') + Number(value).toFixed(0)+units;
					} else if(reading == 'temperature') {
						values += __('Temperature: ') + Number(value).toFixed(1)+units;
					} else if(reading == 'humidity') {
						values += __('Humidity: ') + Number(value).toFixed(1)+units;
					} else if(reading == 'pressure') {
						values += __('Pressure: ') + Number(value).toFixed(1)+units;
					} else if(reading == 'capacity') {
						values += __('Capacity: ') + Number(value).toFixed(0)+units;
					} else {
						values += __('Unknown: ') + value;
					}
					br = '<br/>';
				}
				env_table_html += '<tr>';
				env_table_html += '<td>' + name + '</td>';
				env_table_html += '<td>' + values + '</td>';
				env_table_html += '</tr>';
			}
			if (env_table_html) {
				$('#env-data-table').html('<table><tr><th>'+__('Sensor')+'</th><th>'+__('Readings')+'</th></tr>' + env_table_html + '</table><br />');
			}
		});

		socket.on('cluster_status', function (msg) {
			$('#cluster-status').empty();

			if (msg.secondaries && msg.secondaries.length > 0) {
				var cluster_body = $('<ul>');

				for (i=0; i < msg.secondaries.length; i++) {
					var item = $('<li>');
					var properties = $('<ul class="cluster tinytable">');

					var property = $('<li>');
					property.append('<div class="label">' + __('Address') + ' / ' + __('Type') + '</div>');
					property.append('<div class="data"><a href="' + msg.secondaries[i].address + '">' + msg.secondaries[i].address + '</a> / ' + msg.secondaries[i].modeIndicator + '</div>');
					properties.append(property);

					property = $('<li>');
					property.append('<div class="label">' + __('Latency') + ': ' + __('last') + ' / ' + __('min') + ' / ' + __('avg') + ' / ' + __('max') + '</div>');
					property.append('<div class="data">' + msg.secondaries[i].lastLatencyMs + ' / ' + msg.secondaries[i].minLatencyMs + ' / ' + msg.secondaries[i].avgLatencyMs + ' / ' + msg.secondaries[i].maxLatencyMs + ' ' + __('ms') + '</div>');
					properties.append(property);

					property = $('<li>');
					property.append('<div class="label">' + __('Disconnects') + ' / ' + __('Contacts') + ' / ' + __('Time Diff') + '</div>');
					property.append('<div class="data">' + msg.secondaries[i].numDisconnects + ' / ' + msg.secondaries[i].numContacts + ' / ' + msg.secondaries[i].timeDiffMs + ' ' + __('ms') + '</div>');
					properties.append(property);

					property = $('<li>');
					property.append('<div class="label">' + __('Up') + ' / ' + __('Down') + ' / ' + __('Availability') + '</div>');
					property.append('<div class="data">' + msg.secondaries[i].upTimeSecs + __('s') + ' / ' + msg.secondaries[i].downTimeSecs + __('s') + ' / ' + msg.secondaries[i].availability + '%</div>');
					properties.append(property);

					property = $('<li>');
					property.append('<div class="label">' + __('Last Contact') + '</div>');
					property.append('<div class="data">' + msg.secondaries[i].last_contact + '</div>');
					properties.append(property);

					item.append(properties);
					cluster_body.append(item);
				}

				$('#cluster-status').append(cluster_body);
			}
		});

		/* Profiles */
		socket.on('node_tuning', function (msg) {
			$('#set_profile').empty();
			for (var i = 0; i < msg.profile_ids.length; i++) {
				$('#set_profile').append('<option value="' + msg.profile_ids[i] +'">' + msg.profile_names[i] + '</option>')
			}
			$('#set_profile').val(msg.current_profile);
			$('#set_profile_name').val( msg.profile_name);
			if (msg.profile_ids.length > 1) {
				$('#delete_profile').show();
			} else {
				$('#delete_profile').hide();
			}
		});

		$('#set_profile').change(function (event) {
			var data = {
				profile: parseInt($(this).val())
			};
			socket.emit('set_profile', data);
		});

		$('button#add_profile').click(function (event) {
			socket.emit('add_profile');
		});

		$('button#delete_profile').click(function (event) {
			socket.emit('delete_profile');
		});

		$('#set_profile_name').change(function (event) {
			var data = {
				profile_name: $(this).val()
			};
			socket.emit('alter_profile', data);
		})

		/* Frequency Setup */
		socket.on('frequency_data', function (msg) {
			if (msg.fdata.length) {
				for (var i in msg.fdata) {
					var fObj = freq.getFObjbyFData(msg.fdata[i]);
					rotorhazard.nodes[i].fObj = fObj;
					$('#s_channel_' + i).val(fObj.frequency);
					$('#f_table_' + i).val(fObj.fString);
					freq.updateBlock(fObj, i);
				}
			}
		});

		function show_imd_rating(val) {
			$('#imd_rating_label').html(__('Frequency set IMD rating (100=best)') +
				  ': ' + val + ' &nbsp; <a href="/imdtabler">{{ __("View with IMDTabler") }}</a>');
		};

		function show_imd_rating_dashes() {
			if ($.trim($('#imd_rating_label').html()) != '') {
				show_imd_rating('---');
			}
		};

		socket.on('imdtabler_rating', function (msg) {
			if (msg.imd_rating) {
				show_imd_rating(msg.imd_rating);
			}
			else {
				$('#imd_rating_label').empty();
			}
		});

		$('button.set_frequency_preset').click(function (event) {
			show_imd_rating_dashes();
			var data = {
				preset: $(this).data('preset')
			};
			socket.emit('set_frequency_preset', data);
		});

		socket.on('vrx_list', function (msg) {
			if (msg.enabled) {
				devices_by_node = {}

				// Frequency panel
				if (Object.keys(msg.devices).length) {
					$('.vrx-warning').html(__("WARNING: Video receivers connected.") + " " + __("Changes may cause pilots to lose video."));

					// Devices by node
					for (var device_id in msg.devices) {
						var device = msg.devices[device_id]
						if (device.ready) {
							if (!devices_by_node[device.map.seat]) {
								devices_by_node[device.map.seat] = [];
							}
							devices_by_node[device.map.seat].push(device_id)
						}
					}

					for (i = 0; i < {{ num_nodes }}; i++) {
						var header = $('.node[data-node=' + i + '] .vrx-header');
						header.empty();

						var locks = 0;
						if (i in devices_by_node) {
							for (j in devices_by_node[i]) {
								var device_id = devices_by_node[i][j];
								var device = msg.devices[device_id];
								if (device.video_lock) {
									locks++;
								}
							}

							if (locks == devices_by_node[i].length) {
								header.removeClass('has-unlocked')
							} else {
								header.addClass('has-unlocked')
							}

							header.append(__('VRx locks') + ': ' + locks + '/' + devices_by_node[i].length);
						} else {
							header.removeClass('has-unlocked')
							header.append(__('VRx locks') + ': 0/0');
						}
					}

					// VRx Control Panel
					$('#vrx-control-setup').empty();

					vrx_header = '<h3>' + __('Connected Devices') + '</h3>';

					var vrx_list = $('<ul class="vrx-list">')
					for (var device_id in msg.devices) {
						var device = msg.devices[device_id]
						var li = $('<li>')
						var table = $('<table>');

						table_items = {};

						table_items['ID'] = device_id;
						table_items['Name'] = device.name;
						table_items['Type'] = device.type;

						if (device.connected) {
							if (device.ready) {
								table_items['Status'] = __("Ready");

								if ('map' in device) {
									var selectbox = '<select class="vrx-node" data-vrx-id="' + device_id + '">'
									for (var i = 0; i < {{ num_nodes }}; i++) {
										var opt = '<option value="' + i + '"';
										if (i == device.map.seat) {
											opt += 'selected="selected"';
										}
										opt += '>' + (parseInt(i)+1) + '</option>';
										selectbox += opt;
									}
									table_items['Seat'] = selectbox;
								} else {
									console.warn("No seat number available")
								}

								// CV2-specific items. TODO: Abstract to generic
								if ('cam_forced_or_auto' in device.extended_properties
									&& 'chosen_camera_type' in device.extended_properties) {
									var cam_labels = {
										"A": __("Auto"),
										"F": __("Forced")
									}
									var cam_types = {
										"N": __("NTSC"),
										"P": __("PAL")
									}

									table_items['Format'] = cam_labels[device.extended_properties.cam_forced_or_auto] + ": " + cam_types[device.extended_properties.chosen_camera_type];
								}

								if ('video_lock' in device) {
									if (device.video_lock) {
										table_items['Lock'] = __('Locked');
									} else {
										table_items['Lock'] = __('Unlocked');
									}
								}

							} else {
								table_items['Status'] = __("Not Ready");
							}
						} else {
							table_items['Status'] = __("Unreachable");
						}

						for (var item in table_items) {
							if (item == 'ID' && device.ip) {
								table.append('<tr><th>' + __(item) + '</th><td><a href="http://' + device.ip + '">' + table_items[item] + '</a></td></tr>');
							} else {
								table.append('<tr><th>' + __(item) + '</th><td>' + table_items[item] + '</td></tr>');
							}
						}

						li.append(table)
						vrx_list.append(li);
					}

					$('#vrx-control-setup').append(vrx_header)
					$('#vrx-control-setup').append(vrx_list)
				} else {
					$('.vrx-warning').empty();

					if (!Object.keys(msg.controllers).length) {
						$('#vrx-control-setup').html('<p class="form-note">' + __("No connection to VRx communications server (MQTT)") + '</p>');
					}
				}
			} else {
				$('.vrx-warning').empty();
			}
		});

		$(document).on('change', '.vrx-node', function (msg) {
			var vrx_id = $(this).data('vrx-id');
			var node = parseInt($(this).val());
			socket.emit('set_vrx_node', {
				'vrx_id': vrx_id,
				'node': node
			});
		});

		/* Nodes */
		socket.on('node_data', function (msg) {
			for (var i = 0; i < msg.node_peak_rssi.length; i++) {
				$('.node_peak_rssi_' + i).html(msg.node_peak_rssi[i]);
				$('.node_nadir_rssi_' + i).html(msg.node_nadir_rssi[i]);
				$('.pass_peak_rssi_' + i).html(msg.pass_peak_rssi[i]);
				$('.pass_nadir_rssi_' + i).html(msg.pass_nadir_rssi[i]);
				$('.debug_pass_count_' + i).html(msg.debug_pass_count[i]);

				rotorhazard.nodes[i].node_peak_rssi = msg.node_peak_rssi[i];
				rotorhazard.nodes[i].node_nadir_rssi = msg.node_nadir_rssi[i];
				rotorhazard.nodes[i].pass_peak_rssi = msg.pass_peak_rssi[i];
				rotorhazard.nodes[i].pass_nadir_rssi = msg.pass_nadir_rssi[i];

				$('#node_notice_' + i).html(rotorhazard.nodes[i].checkValues());
				rotorhazard.nodes[i].updateThresholds();
			}
		});

		$('.frequency_table').change(function (event) {
			node = parseInt($(this).data('node'));
			var fstring = $(this).val();
			if (fstring != "n/a") {
				// parse frequency string
				fObj = freq.getFObjbyFString(fstring);

				// update server
				var data = {
					node: node,
					band: fObj.band,
					channel: fObj.channel,
					frequency: fObj.frequency
				};
				socket.emit('set_frequency', data);

				// update local view
				$('#s_channel_' + node).val(fObj.frequency);
			}
		});

		socket.on('enter_and_exit_at_levels', function (msg) {
			for (var i = 0; i < msg.enter_at_levels.length; i++) {
				$('#set_enter_at_level_' + i).val(msg.enter_at_levels[i]);
				rotorhazard.nodes[i].enter_at_level = msg.enter_at_levels[i];
				$('#set_exit_at_level_' + i).val(msg.exit_at_levels[i]);
				rotorhazard.nodes[i].exit_at_level = msg.exit_at_levels[i];

				$('#node_notice_' + i).html(rotorhazard.nodes[i].checkValues());
				rotorhazard.nodes[i].updateThresholds();
			}
		});

		socket.on('node_enter_at_level', function (msg) {
			$('#set_enter_at_level_' + msg.node_index).val(msg.level);
			rotorhazard.nodes[msg.node_index].enter_at_level = msg.level;

			$('#node_notice_' + i).html(rotorhazard.nodes[msg.node_index].checkValues());
			rotorhazard.nodes[msg.node_index].updateThresholds();
		});

		socket.on('node_exit_at_level', function (msg) {
			$('#set_exit_at_level_' + msg.node_index).val(msg.level);
			rotorhazard.nodes[msg.node_index].exit_at_level = msg.level;

			$('#node_notice_' + i).html(rotorhazard.nodes[msg.node_index].checkValues());
			rotorhazard.nodes[msg.node_index].updateThresholds();
		});

		$('button.pause_graph').click(function (event) {
			var btn = $(this);
			var node = rotorhazard.nodes[parseInt($(this).data('node'))]
			if (node.graphPaused) {
				node.graph.options.scaleSmoothing = 0.125;
				node.graph.removeTimeSeries(node.pauseSeries)
				node.graph.addTimeSeries(node.series, {lineWidth:1.7,
					strokeStyle:'hsl(214, 53%, 60%)',
					fillStyle:'hsla(214, 53%, 60%, 0.4)'
				});
				node.graph.start();
				btn.html(svg_asset.pause);
			} else {
				node.graph.stop();
				node.graphPausedTime = new Date().getTime();
				node.pauseSeries = node.series;
				node.graph.options.scaleSmoothing = 1;
				node.graph.removeTimeSeries(node.series)
				node.graph.addTimeSeries(node.pauseSeries, {lineWidth:1.7,
					strokeStyle:'hsl(214, 53%, 60%)',
					fillStyle:'hsla(214, 53%, 60%, 0.4)'
				});
				node.graph.render(node.canvas, node.graphPausedTime);
				btn.html(svg_asset.play);
			}
			node.graphPaused = !node.graphPaused;
		});

		$('.set_frequency').change(function (event) {
			show_imd_rating_dashes();

			var fObj = freq.findByFreq($(this).val());
			$('#f_table_' + $(this).data('node')).val(fObj.fString);

			var data = {
				node: parseInt($(this).data('node')),
				band: fObj.band,
				channel: fObj.channel,
				frequency: fObj.frequency,
			};
			socket.emit('set_frequency', data);
		});

		$('.set_enter_at_level').change(function (event) {
			var data = {
				node: parseInt($(this).data('node')),
				enter_at_level: parseInt($(this).val()),
			};
			if (!Number.isNaN(data.enter_at_level)) {
				socket.emit('set_enter_at_level', data);
				rotorhazard.nodes[data.node].enter_at_level = data.enter_at_level;
				rotorhazard.nodes[data.node].updateThresholds();
			}
		});

		$('.set_exit_at_level').change(function (event) {
			var data = {
				node: parseInt($(this).data('node')),
				exit_at_level: parseInt($(this).val()),
			};
			if (!Number.isNaN(data.exit_at_level)) {
				socket.emit('set_exit_at_level', data);
				rotorhazard.nodes[data.node].exit_at_level = data.exit_at_level;
				rotorhazard.nodes[data.node].updateThresholds();
			}
		});

		$('button.cap_enter_at_btn').click(function (event) {
			var data = {
				node_index: parseInt($(this).data('node_index')),
			};
			$('#set_enter_at_level_' + data.node_index).val('');
			socket.emit('cap_enter_at_btn', data);
		});

		$('button.cap_exit_at_btn').click(function (event) {
			var data = {
				node_index: parseInt($(this).data('node_index')),
			};
			$('#set_exit_at_level_' + data.node_index).val('');
			socket.emit('cap_exit_at_btn', data);
		});

		socket.on('start_thresh_lower_amount', function (msg) {
			$('#set_start_thresh_lower_amount').val(msg.start_thresh_lower_amount);
		});

		$('#set_start_thresh_lower_amount').change(function (event) {
			var start_thresh_lower_amount_val = parseIntDefault($(this).val());
			var data = {
				start_thresh_lower_amount: start_thresh_lower_amount_val
			};
			socket.emit('set_start_thresh_lower_amount', data);
		})

		socket.on('start_thresh_lower_duration', function (msg) {
			$('#set_start_thresh_lower_duration').val(msg.start_thresh_lower_duration);
		});

		$('#set_start_thresh_lower_duration').change(function (event) {
			var start_thresh_lower_duration_val = parseIntDefault($(this).val());
			var data = {
				start_thresh_lower_duration: start_thresh_lower_duration_val
			};
			socket.emit('set_start_thresh_lower_duration', data);
		})

		$(document).on("click", '.retry_secondary', function (event) {
			var data = {
				secondary_id: parseInt($(this).data('secondary_id'))
			};
			socket.emit('retry_secondary', data);
		});

		/* Voice */
		$('#beep_on_first_pass_button').prop('disabled', rotorhazard.beep_crossing_exited);

		$(document).on('change', '#set_voice_language', function (event) {
			rotorhazard.voice_language = $(this).val();
			rotorhazard.saveData();
		});

		// construct language selection
		$('#voice_select').after('<select id="set_voice_language">');
		var voices = $().articulate('getVoices');

		for (var i in voices) {
			$('#set_voice_language').append('<option>'+ voices[i].name + '</option>');
		}
		$('#set_voice_language').val(rotorhazard.voice_language);
		if (!($('#set_voice_language').val())) {  // if no match then select first English voice
			rotorhazard.voice_language = get_default_articulate_voice();
			rotorhazard.saveData();
			$('#set_voice_language').val(rotorhazard.voice_language);
		}

		$('#set_voice_string_language').change(function (event) {
			rotorhazard.voice_string_language = $(this).val();
			rotorhazard.saveData();
		});

		$('#voice_callsign').change(function (event) {
			rotorhazard.voice_callsign = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_lap_count').change(function (event) {
			rotorhazard.voice_lap_count = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_team_lap_count').change(function (event) {
			rotorhazard.voice_team_lap_count = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_lap_time').change(function (event) {
			rotorhazard.voice_lap_time = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_race_timer').change(function (event) {
			rotorhazard.voice_race_timer = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_race_winner').change(function (event) {
			rotorhazard.voice_race_winner = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_if_node_finished').change(function (event) {
			rotorhazard.voice_if_node_finished = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_split_timer').change(function (event) {
			rotorhazard.voice_split_timer = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#voice_race_leader').change(function (event) {
			rotorhazard.voice_race_leader = parseInt($(this).val());
			rotorhazard.saveData();
		});

		$('#set_voice_volume').on('input', function (event) {
			var val = volume_logsl.value($(this).val());
			$().articulate('volume', val);
			$('#voice_volume_value').html($(this).val());
		});

		$('#set_voice_volume').change(function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.voice_volume = val;
			rotorhazard.saveData();
		});

		$('#set_voice_rate').on('input', function (event) {
			val = parseFloat($(this).val())
			$().articulate('rate', val);
			$('#voice_rate_value').html(val.toFixed(2));
		});

		$('#set_voice_rate').on('change', function (event) {
			rotorhazard.voice_rate = parseFloat($(this).val());
			rotorhazard.saveData();
		});

		$('#set_voice_pitch').on('input', function (event) {
			val = parseFloat($(this).val())
			$().articulate('pitch', val);
			$('#voice_pitch_value').html(val.toFixed(2));
		});

		$('#set_voice_pitch').on('change', function (event) {
			rotorhazard.voice_pitch = parseFloat($(this).val());
			rotorhazard.saveData();
		});

		$('#set_tone_volume').on('input', function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.tone_volume = val;
			$('#tone_volume_value').html($(this).val());
		});

		$('#set_tone_volume').change(function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.tone_volume = val;
			rotorhazard.saveData();
		});

		$('#beep_crossing_entered').change(function (event) {
			rotorhazard.beep_crossing_entered = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_crossing_exited').change(function (event) {
			rotorhazard.beep_crossing_exited = $(this).prop('checked');
			$('#beep_on_first_pass_button').prop('disabled', rotorhazard.beep_crossing_exited);
			rotorhazard.saveData();
		});

		$('#beep_manual_lap_button').change(function (event) {
			rotorhazard.beep_manual_lap_button = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_race_leader_lap').change(function (event) {
			rotorhazard.beep_race_leader_lap = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_race_winner_declared').change(function (event) {
			rotorhazard.beep_race_winner_declared = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_cluster_connect').change(function (event) {
			rotorhazard.beep_cluster_connect = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#use_mp3_tones').change(function (event) {
			rotorhazard.use_mp3_tones = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#beep_on_first_pass_button').change(function (event) {
			rotorhazard.beep_on_first_pass_button = $(this).prop('checked');
			rotorhazard.saveData();
		});

		$('#set_indicator_volume').on('input', function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.indicator_beep_volume = val;
			$('#indicator_volume_value').html($(this).val());
		});

		$('#set_indicator_volume').change(function (event) {
			var val = volume_logsl.value($(this).val());
			rotorhazard.indicator_beep_volume = val;
			rotorhazard.saveData();
		});

		$('#play_voice_test').click(function (event) {
			doSpeak('<div class="speech">' + $('#voice_test_text').val() + '</div>');
		});

		$("#voice_test_text").keyup(function(event) {
			if (event.keyCode === 13) {  // make 'Enter' key on input field trigger button
				$("#play_voice_test").click();
			}
		});

		$('button#export_audio_settings').click(function (event) {
			var date = new Date();
			var outData = rotorhazard.getAudioSettingsStr(date);
			saveAs(new Blob([outData], {type: "text/plain;charset=utf-8"}),
					"rhAudioSettings_" + rotorhazard.getCurDateTimeNumStr(date) + ".cfg");
		});

		$('button#default_audio_settings').click(function (event) {
			$.magnificPopup.close();
			if (rotorhazard.loadDefaultAudioSettings()) {
				populate_audio_settings();
			}
		});

		$('#select_audio_import_file').change(function(){
			if ($(this).prop('files')[0]) {
				$('#import_audio_settings').prop('disabled', false);
			}
		});

		$('button#import_audio_settings').click(function (event) {
			if ($('#select_audio_import_file').prop('files')[0]) {
				$('#import_audio_settings').prop('disabled', true);
				rotorhazard.importAudioSettingsFile(
							$('#select_audio_import_file').prop('files')[0], populate_audio_settings);
				$('#select_audio_import_file').val('');
			}
		});

		/* Event Actions */

		function updateActionList() {
			if (rotorhazard.actions?.effects && rotorhazard.actions?.events && rotorhazard.actions?.list) {
				$('button#add_action').prop('disabled', false);
				var actionListObj = $('<ul>');
				for (var idx in rotorhazard.actions.list) {
					var action = rotorhazard.actions.list[idx]
					actionListObj.append(buildActionItem(action['event'], action['effect'], idx));
				}
				$('#actions').html(actionListObj);
			}
		}

		function buildActionItem(event, effect, action_idx) {
			if (rotorhazard.actions?.events && rotorhazard.actions?.effects && rotorhazard.actions?.list) {
				var item = $('<li class="action">')
				var eventLabel = $('<label>')
					.text(__('Event'))
					.addClass('screen-reader-text')
					.attr('for', 'action_event_' + action_idx);
				var eventSelect = $('<select class="actionfield">')
					.addClass('actionfield')
					.data('idx', action_idx)
					.data('field', 'event')
					.attr('id', 'action_event_' + action_idx);
				for (const [key, value] of Object.entries(rotorhazard.actions.events)) {
					var opt = $('<option>')
						.attr('value', key)
						.text(value);
					eventSelect.append(opt);
				}
				if (event) {
					eventSelect.val(event);
				} else {
					event = eventSelect.val();
					rotorhazard.actions.list[action_idx].event = event;
				}
				item.append(eventLabel);
				item.append(eventSelect);

				var effectLabel = $('<label>')
					.text(__('Effect'))
					.addClass('screen-reader-text')
					.attr('for', 'action_effect_' + action_idx);
				var effectSelect = $('<select>')
					.addClass('actionfield')
					.data('idx', action_idx)
					.data('field', 'effect')
					.attr('id', 'action_effect_' + action_idx);
				for (const [key, value] of Object.entries(rotorhazard.actions.effects)) {
					var opt = $('<option>')
						.attr('value', key)
						.text(value.name);
					effectSelect.append(opt);
				}
				if (effect) {
					effectSelect.val(effect);
				} else {
					effect = effectSelect.val()
					rotorhazard.actions.list[action_idx].effect = effect;
				}

				item.append(effectLabel);
				item.append(effectSelect);

				var deleteBtn = $('<button>')
					.text('\u00D7')
					.addClass('delete-action')
					.addClass('btn-danger')
					.data('id', action_idx)
					.attr('title', __("Delete Action"));

				item.append(deleteBtn);
				item.append(buildActionFields(effect, action_idx));

				return item;
			}
		}

		function buildActionFields(effect, action_idx) {
			if (rotorhazard.actions?.list && rotorhazard.actions?.effects) {
				var fieldset = $('<fieldset>');

				for (idx in rotorhazard.actions.effects[effect]?.fields) {
					var settings = { ...rotorhazard.actions.effects[effect].fields[idx] };

					settings.wrapperEl = 'div';
					settings.data = {
						idx: action_idx,
						field: settings.name
					}
					if (rotorhazard.actions.list[action_idx][settings.name]) {
						settings.value = rotorhazard.actions.list[action_idx][settings.name];
					}

					settings.id = 'action_' + action_idx + '_' + idx;
					settings.fieldClass = 'actionfield';

					var field = rhui.buildField(settings);

					fieldset.append(field);
				}
				return fieldset;
			}
		}

		socket.on('action_setup', function (msg) {
			rotorhazard.actions ??= {}
			rotorhazard.actions.effects = msg.effects;
			rotorhazard.actions.events = msg.events;
			updateActionList();
		});

		socket.on('event_actions', function (msg) {
			rotorhazard.actions ??= {}
			rotorhazard.actions.list = JSON.parse(msg.actions);
			if (!Array.isArray(rotorhazard.actions.list)) {
				rotorhazard.actions.list = [];
			}
			updateActionList();
		});

		$('button#add_action').click(function (event) {
			if (rotorhazard.actions?.list) {
				rotorhazard.actions.list.push({});
				updateActionList();
			}
		});

		$(document).on('click', 'button.delete-action', function (event) {
			var idx = $(event.target).data('id');
			rotorhazard.actions.list.splice(idx, 1);
			updateActionList();
			socket.emit('set_config', {
				section: 'USER',
				key: 'actions',
				value: JSON.stringify(rotorhazard.actions.list)
			});
		});

		$(document).on('change', '.actionfield', function(evt){
			var target = $(evt.target);
			var action = target.data('idx');
			var field = target.data('field');
			var value = rhui.getFieldVal(evt.target);

			rotorhazard.actions.list[action][field] = value;

			if (field == "effect") {
				updateActionList();
			}

			socket.emit('set_config', {
				section: 'USER',
				key: 'actions',
				value: JSON.stringify(rotorhazard.actions.list)
			});
		});

		/* System */
		$('button#shutdown_pi').click(function (event) {
			socket.emit('shutdown_pi');
		});

		$('button#reboot_pi').click(function (event) {
			socket.emit('reboot_pi');
		});

		$('button#kill_server').click(function (event) {
			socket.emit('kill_server');
		});

		$('button#download_logs').click(function (event) {
			var audioSettingsData = rotorhazard.getAudioSettingsStr(new Date());
			var outData = { 'emit_fn_name': 'settings_save_logs',
							'audioSettingsData' : audioSettingsData,
							'audioSettingsFName' : "rhAudioSettings.cfg" };
			socket.emit('download_logs', outData);
		});

		socket.on('settings_save_logs', function (msg) {
			msgArray = atob(msg.file_data);  // decode Base64 string
			// convert decoded data to byte array
			var byteNumbers = new Array(msgArray.length);
			for (var i = 0; i < msgArray.length; i++) {
				byteNumbers[i] = msgArray.charCodeAt(i);
			}
			var byteArray = new Uint8Array(byteNumbers);
			// construct blob from byte array and initiate browser save-as
			saveAs(new Blob([byteArray], {type: "application/octet-stream"}), msg.file_name);
		});

		$('button#backup_settings').click(function (event) {
			socket.emit('backup_settings');
		});

		$('button#download_settings').click(function (event) {
			socket.emit('download_settings');
		});

		socket.on('send_config_file', function (msg) {
			msgArray = atob(msg.file_data);  // decode Base64 string
			// convert decoded data to byte array
			var byteNumbers = new Array(msgArray.length);
			for (var i = 0; i < msgArray.length; i++) {
				byteNumbers[i] = msgArray.charCodeAt(i);
			}
			var byteArray = new Uint8Array(byteNumbers);
			// construct blob from byte array and initiate browser save-as
			saveAs(new Blob([byteArray], {type: "application/octet-stream"}), msg.file_name);
		});

		socket.on('upd_cfg_files_list', function (msg) {
			$('#cfg_files_list').empty();
			if ('cfg_files' in msg && msg.cfg_files && msg.cfg_files.length) {
				for (file in msg.cfg_files) {
					cfgfile = msg.cfg_files[file];
					$('#cfg_files_list').append('<option value="' + cfgfile + '">' + cfgfile + '</option>');
				}
				$('#cfg_files_list').prop('disabled', false);
				var select_file = msg.select_file;
				if (select_file) {
					$('#cfg_files_list').val(select_file);
				} else {
					$('#cfg_files_list').val($('#cfg_files_list option').last().val());
				}
				$('button[data-mfp-src="#settings_restore_confirm"]').prop('disabled', false);
				$('#rename_settings_btn').prop('disabled', false);
				$('button[data-mfp-src="#settings_delete_confirm"]').prop('disabled', false);
			} else {
				$('#cfg_files_list').append('<option value="-">' + __('No Saved Settings Files') + '</option>');
				$('#cfg_files_list').prop('disabled', true);
				$('button[data-mfp-src="#settings_restore_confirm"]').prop('disabled', true);
				$('#rename_settings_btn').prop('disabled', true);
				$('button[data-mfp-src="#settings_delete_confirm"]').prop('disabled', true);
			}
		});

		$('button#reset_cfg_file_to_defaults').click(function (event) {
			$.magnificPopup.close();
			socket.emit('reset_settings_to_defaults');
		});

		$('button#restore_cfg_file').click(function (event) {
			$.magnificPopup.close();
			var data = {
				cfg_file: $('#cfg_files_list').val()
			};
			socket.emit('restore_cfg_file', data);
		});

		$('#rename_settings_btn').click(function (event) {
			$('#new_cfg_file_name').val($('#cfg_files_list').val());  // default to current filename
			$.magnificPopup.open({
				items: {
					src: '#settings_rename_popup'
				},
				type: 'inline'
			});
			// set focus and select text on 'input' field on popup window
			setTimeout("document.getElementById('new_cfg_file_name').focus()", 100);
			setTimeout("document.getElementById('new_cfg_file_name').select()", 110);
		});

		$('#rename_cfg_file').click(function (event) {
			$.magnificPopup.close();
			var data = {
				cfg_file: $('#cfg_files_list').val(),
				new_name: $('#new_cfg_file_name').val()
			};
			socket.emit('rename_cfg_file', data);
		});

		$("#new_cfg_file_name").keyup(function(event) {
			if (event.keyCode === 13) {  // make 'Enter' key on input field trigger button
				$("#rename_cfg_file").click();
			}
		});

		$('button#delete_cfg_file').click(function (event) {
			$.magnificPopup.close();
			var data = {
				cfg_file: $('#cfg_files_list').val()
			};
			socket.emit('delete_cfg_file', data);
		});

		$('#select_load_settings_file').change(function(){
			if ($(this).prop('files')[0]) {
				$('button[data-mfp-src="#settings_load_confirm"]').prop('disabled', false);
			}
		});

		$('button#load_cfg_file').click(function (event) {
			$.magnificPopup.close();
			file_obj = $('#select_load_settings_file').prop('files')[0]
			if (file_obj) {
				try {
					var data = {
						file_data: file_obj,
						file_name: file_obj.name
					};
					socket.emit('load_cfg_file', data);
					$('#select_load_settings_file').val('');
				} catch(ex) {
					console.error("Error loading settings file: " + ex)
				}
			}
		});

		socket.on('set_option', function (msg) {
			$('.set_option[data-option="' + msg.label +'"]').val(msg.value);
		});

		$(document).on('change', '.set-option', function (event) {
			var data = {
				option: $(this).data('option'),
				value: $(this).val()
			};
			socket.emit('set_option', data);
		});

		socket.on('config_update', function (msg) {
			for (var section in msg.config) {
				if (section == 'SENSORS') {
					display_sensors_ui(msg.config[section]);
				} else {
					for (var key in msg.config[section]) {
						var value = msg.config[section][key];

						if (section == 'GENERAL' && key == 'SECONDARIES') {
							display_secondary_ui(value);
						} else {
							$('.set_config[data-section="' + section +'"][data-key="' + key +'"]').val(value);
						}
					}
				}
			}
		});

		socket.on('set_config', function (msg) {
			if (msg.section == 'GENERAL' && msg.key == 'SECONDARIES') {
				display_secondary_ui(msg);
			} else if (msg.section == 'SENSORS') {
				display_sensors_ui(msg);
			} else {
				$('.set_config[data-section="' + msg.section +'"][data-key="' + msg.key +'"]').val(msg.value);
			}
		});

		$(document).on('change', '.set-config', function (event) {
			value = $(this).val();
			if ($(this).data('type') == 'boolean' ) {
				if (value == 'true') {
					value = true;
				} else {
					value = false;
				}
			} else if ($(this).data('type') == 'int' || $(this).attr('type') == 'number') {
				value = Number(value);
			}

			var data = {
				section: $(this).data('section'),
				key: $(this).data('key'),
				value: value
			};
			socket.emit('set_config', data);
		});

		$('#set_language').change(function (event) {
			var data = {
				language: $(this).val()
			};
			socket.emit('set_language', data);
			location.reload(true);
		});

		socket.on('node_crossing_change', function (msg) {
			if (msg.crossing_flag) {
				if (rotorhazard.beep_crossing_entered) {
					if (rotorhazard.use_mp3_tones) {
						play_mp3_beep(sound_enter, rotorhazard.indicator_beep_volume);
					}
					else {
						play_beep(25, node_tone[msg.node_index], rotorhazard.indicator_beep_volume, 'square');
					}
				}
			}
			else {
				if (rotorhazard.beep_crossing_exited) {
					if (rotorhazard.use_mp3_tones) {
						play_mp3_beep(sound_exit, rotorhazard.indicator_beep_volume);
					}
					else {
						play_beep(35, node_tone[msg.node_index], rotorhazard.indicator_beep_volume, 'sawtooth', 0.02);
						setTimeout(function(tone){
							play_beep(35, node_tone[tone], rotorhazard.indicator_beep_volume, 'sawtooth');
						}, 70, msg.node_index);
					}
				}
			}
		});

		socket.on('cluster_connect_change', function (msg) {
			if (rotorhazard.beep_cluster_connect) {
				if (msg.connect_flag) {
					if (rotorhazard.use_mp3_tones) {
						play_mp3_beep(sound_cconnect, rotorhazard.indicator_beep_volume);
					}
					else {
						play_beep(120, 225, rotorhazard.indicator_beep_volume, 'square');
						setTimeout(function(tone){
							play_beep(110, 250, rotorhazard.indicator_beep_volume, 'square');
						}, 120, 0);
					}
				}
				else {
					if (rotorhazard.use_mp3_tones) {
						play_mp3_beep(sound_cdisconnect, rotorhazard.indicator_beep_volume);
					}
					else {
						play_beep(80, 200, rotorhazard.indicator_beep_volume, 'square');
						setTimeout(function(tone){
							play_beep(220, 100, rotorhazard.indicator_beep_volume, 'square');
						}, 80, 0);
					}
				}
			}
		});

		function calcContrasts(option_index) {
			var hue = $('html').css('--hue_' + option_index);
			var sat = $('html').css('--sat_' + option_index);
			var lum_low = $('html').css('--lum_' + option_index + '_low');
			var lum_high = $('html').css('--lum_' + option_index + '_high');

			var hex_low = hslToHex(hue, sat, lum_low);
			var contrast_low = contrastColor(hex_low);
			$('html').css('--contrast_' + option_index + '_low', contrast_low);

			var hex_high = hslToHex(hue, sat, lum_high);
			var contrast_high = contrastColor(hex_high);
			$('html').css('--contrast_' + option_index + '_high', contrast_high);

			return {
				'low': contrast_low,
				'high': contrast_high
			}
		}

		$.cssNumber.hue_0 = true;
		$.cssNumber.hue_1 = true;
		$.cssNumber.sat_0 = true;
		$.cssNumber.sat_1 = true;

		$('.hue-control').on('input', function (event) {
			var key = $(this).data('key');
			var value = $(this).val();
			$('html').css('--' + key, value);
			var key_index = key.split('_')[1];
			calcContrasts(key_index);
		});

		$('.hue-control').on('change', function (event) {
			var section = $(this).data('section');
			var key = $(this).data('key');
			var value = $(this).val();

			$('html').css('--' + key, value);
			var key_index = key.split('_')[1];
			var contrasts = calcContrasts(key_index);

			var data = {
				section: section,
				key: key,
				value: value
			};
			socket.emit('set_config', data);

			var data = {
				section: section,
				key: 'contrast_' + key_index + '_low',
				value: contrasts.low
			};
			socket.emit('set_config', data);

			var data = {
				section: section,
				key: 'contrast_' + key_index + '_high',
				value: contrasts.high
			};
			socket.emit('set_config', data);
		});

		$('.sat-control').on('input', function (event) {
			var key = $(this).data('key');
			var value = $(this).val();
			$('html').css('--' + key, value + '%');
			var key_index = key.split('_')[1];
			calcContrasts(key_index);
		});

		$('.sat-control').on('change ', function (event) {
			var section = $(this).data('section');
			var key = $(this).data('key');
			var value = $(this).val();

			$('html').css('--' + key, value + '%');
			var key_index = key.split('_')[1];
			var contrasts = calcContrasts(key_index);

			var data = {
				section: section,
				key: key,
				value: value
			};
			socket.emit('set_config', data);

			var data = {
				section: section,
				key: 'contrast_' + key_index + '_low',
				value: contrasts.low
			};
			socket.emit('set_config', data);

			var data = {
				section: section,
				key: 'contrast_' + key_index + '_high',
				value: contrasts.high
			};
			socket.emit('set_config', data);
		});

		/* LED Controls */
		socket.on('led_effects', function (msg) {
			var led_html = $('<div class="control-set">');

			var led_select = $('<select id="led-effects-select"></select>');

			const effects = msg.effects.slice().sort((a, b) => (a.label > b.label) ? 1 : -1);

			for (var i in effects) {
				var effect = effects[i];

				var led_select_option = $('<option value="' + effect.name + '">' + effect.label + '</option>')

				led_select.append(led_select_option);
			}

			led_html.append($('<label for="led-effects">' + __('Effect') + '</label>'));
			led_html.append(' ');
			led_html.append(led_select);
			led_html.append(' ');
			led_html.append('<label for="set_led_color" class="screen-reader-text">' + __('LED Color') + '</label>');
			led_html.append('<button id="set_led_color" class="color-picker" style="background-color: #ff6a00"/>');
			led_html.append(' ');
			led_html.append($('<button id="use-led-effect">' + __('Go') + '</button>'));

			$('#LED-effects').html(led_html);
		});

		$(document).on('click', '#use-led-effect', function (event) {
			var data = {
				effect: $('#led-effects-select').val(),
				color: rgbtoHex($('#set_led_color').css('background-color'))
			};
			socket.emit('use_led_effect', data);
		});

		$('button.LED-color').click(function (event) {
				var colors = convertColor($(this).data('rgb'));
				var data = {
					red: colors.r,
					green: colors.g,
					blue: colors.b,
				};
				socket.emit('LED_solid', data);
		});

		$('button.LED-off').click(function (event) {
				var data = {
					off: true
				};
				socket.emit('LED_solid', data);
		});

		$(document).on("click", '#set_led_color', function (event) {
			src_hexcolor = rgbtoHex($(event.target).css('background-color'));

			color_picker(src_hexcolor, function(hexcolor){
				$(event.target).css('background-color', hexcolor);
			})
		})

		socket.on('led_effect_setup_data', function (msg) {
			var led_html = $('<ol class="form">');

			for (var i in msg.events) {
				var led_event = msg.events[i];
				var valid_selection = false;

				var led_select = $('<select id="led-event-' + led_event.event + '" data-event="' + led_event.event + '" class="led-event-select"></select>');

				const effects = led_event.effects.slice().sort((a, b) => (a.label > b.label) ? 1 : -1);
				for (var opt in effects) {
					var effect = effects[opt];

					var led_select_option = $('<option value="' + effect.name + '">' + effect.label + '</option>')

					led_select.append(led_select_option);

					if (effect.name == led_event.selected)
						valid_selection = true;
				}

				var led_event_block = $('<li>');
				led_event_block.append($('<div class="label-block"><label for="led-event-' + led_event.event + '">' + __(led_event.label) + '</label></div>'));
				led_event_block.append(led_select);

				if (valid_selection) {
					led_select.val(led_event.selected);
				}

				led_html.append(led_event_block);
			}

			$('#LED-effect-setup').html(led_html);
		});

		$(document).on('change', '.led-event-select', function(event) {
			var data = {
				event: $(this).data('event'),
				effect: $(this).val()
			};
			socket.emit('set_led_event_effect', data);
		});

		$('#set_led_brightness').on('input', function (event) {
			var val = brightness_logsl.value($(this).val());
			$('#led_brightness_value').html($(this).val());
		});

		$('#set_led_brightness').change(function (event) {
			var val = brightness_logsl.value($(this).val());
			// emit data
			var data = {
				brightness: Math.round(val),
			};
			socket.emit('LED_brightness', data);
		});

		/* positional RSSI adjustment */
		var canDrag = false;
		var isDragging = false;
		var startingEnter = false;
		var startingExit = false;
		var startingY = false;
		var adjustEnter = true;
		var isTouchEvent = false;

		function mapRange(val, start, end){
			return val * (end - start) / 1 + start;
		}

		function handleGraphInteractionStart(evt, node) {
			var offset = $(evt.target).offset()
			if (evt.targetTouches) {
				var y = (evt.targetTouches[0].pageY - offset.top) / evt.target.offsetHeight;
			} else {
				var y = (evt.pageY - offset.top) / evt.target.offsetHeight;
			}

			var rssi = parseInt(mapRange(y, rotorhazard.nodes[node].graph.options.maxValue, rotorhazard.nodes[node].graph.options.minValue));

			startingEnter = parseInt($('#set_enter_at_level_' + node).val());
			startingExit = parseInt($('#set_exit_at_level_' + node).val());
			startingY = y;

			var midPoint = (startingEnter + startingExit) >> 1;
			adjustEnter = (rssi >= midPoint);
		}

		function handleGraphInteractionMove(evt, node) {
			// user drags on graph
			var offset = $(evt.target).offset()
			if (evt.targetTouches) {
				var y = (evt.targetTouches[0].pageY - offset.top) / evt.target.offsetHeight;
			} else {
				var y = (evt.pageY - offset.top) / evt.target.offsetHeight;
			}

			if (Math.abs(y - startingY) > 0.01 || isDragging) { // prevent accidental drag
				isDragging = true;

				var rssi = parseInt(mapRange(y, rotorhazard.nodes[node].graph.options.maxValue, rotorhazard.nodes[node].graph.options.minValue));

				var enter_control = $('#set_enter_at_level_' + node);
				var exit_control = $('#set_exit_at_level_' + node);

				if (adjustEnter) {
					enter_control.val(rssi);
					enter_control.trigger('change');
					if (rssi < parseInt(exit_control.val()) + 2)  {
						exit_control.val(rssi - 2);
						exit_control.trigger('change');
					}
				} else {
					exit_control.val(rssi);
					exit_control.trigger('change');
					if (rssi > parseInt(enter_control.val()) - 2)  {
						enter_control.val(rssi + 2);
						enter_control.trigger('change');
					}
				}
			}
		}

		// mouse handlers
		$('.rssi-graph').on('mousedown', function(evt){
			node = $(this).data('node')
			if (!isTouchEvent) {
				canDrag = true;
				handleGraphInteractionStart(evt, node);
			}
		})
		$('.rssi-graph').on('mousemove', function(evt){
			node = $(this).data('node')
			if (!isTouchEvent) {
				if (canDrag) {
					handleGraphInteractionMove(evt, node);
					$('#recalc').trigger('click');
				}
			}
		})
		$('.rssi-graph').on('mouseup', function(evt){
			node = $(this).data('node')
			if (!isTouchEvent) {
				canDrag = false;
				isDragging = false;
			}
			isTouchEvent = false;
		})
		$('.rssi-graph').on('mouseout', function(evt){
			node = $(this).data('node')
			if (!isTouchEvent) {
				if (isDragging) {
					$('#set_enter_at_level_' + node).val(startingEnter);
					$('#set_enter_at_level_' + node).trigger('change');
					$('#set_exit_at_level_' + node).val(startingExit);
					$('#set_exit_at_level_' + node).trigger('change');
				}
			}
			isTouchEvent = false;
		});
		$(document).on('mouseup', function(){
			if (!isTouchEvent) {
				canDrag = false;
				isDragging = false;
			}
			isTouchEvent = false;
		});

		// touch handlers
		$('.rssi-graph').on('touchstart', function(evt) {
			evt.preventDefault();
			node = $(this).data('node')
			if (evt.targetTouches.length == 1) { // pause if multi-touch detected
				handleGraphInteractionStart(evt, node);
				handleGraphInteractionMove(evt, node);
			}
			isTouchEvent = true;
		})
		$('.rssi-graph').on('touchmove', function(evt) {
			evt.preventDefault();
			node = $(this).data('node')
			if (evt.targetTouches.length == 1) { // pause if multi-touch detected
				handleGraphInteractionMove(evt, node);
			}
		})
		$('.rssi-graph').on('touchend', function(evt){
			evt.preventDefault();
			node = $(this).data('node')
			if (evt.targetTouches && evt.targetTouches.length == 0) { // end only when all touches end
			}
		})
		$('.rssi-graph').on('touchCancel', function(evt) {
			evt.preventDefault();
			$('#set_enter_at_level_' + node).val(startingEnter);
			$('#set_enter_at_level_' + node).trigger('change');
			$('#set_exit_at_level_' + node).val(startingExit);
			$('#set_exit_at_level_' + node).trigger('change');
			isTouchEvent = true;
		});

		// Plugins
		socket.on('plugin_list', function (msg) {
			// msg.plugins.sort((a, b) => a.name.localeCompare(b.name, undefined, {sensitivity: 'base'}));

			var wrap_el = $('#plugin-list');
			wrap_el.empty();

			if (msg.plugins.length) {
				var list_el = $('<ul class="plugin-list">');
				for (var idx in msg.plugins) {
					var plugin = msg.plugins[idx];
					var plug_el = $('<li>');

					var main_info_el = $('<div class="main-info">');
					var details_el = $('<div class="details">');
					var status_el = $('<div class="status">');

					main_info_el.append('<h3 class="name">' + plugin.name + '</h3>');

					if (plugin.author) {
						if (plugin.author_uri) {
							main_info_el.append('<div class="author"><a href="' + plugin.author_uri + '">' + plugin.author + '</a></div>');
						} else {
							main_info_el.append('<div class="author">' + plugin.author + '</div>');
						}
					}

					if (plugin.version) {
						main_info_el.append('<div class="version">' + plugin.version + '</div>');
					}

					if (plugin.description) {
						details_el.append('<div class="description">' + plugin.description + '</div>');
					} else {
						details_el.append('<div class="description"><em>(' + __('not provided') + ')</em></div>');
					}

					if (plugin.documentation_uri) {
						details_el.append('<div class="documentation"><a href="' + plugin.documentation_uri + '">' + __('documentation') + '</a></div>');
					}

					if (plugin.info_uri) {
						details_el.append('<div class="website"><a href="' + plugin.info_uri + '">' + __('website') + '</a></div>');
					}

					if (plugin.license_uri) {
						details_el.append('<div class="license"><a href="' + plugin.license_uri + '">' + __('license') + '</a></div>');
					} else if (plugin.license) {
						details_el.append('<div class="license">' + plugin.license + '</div>');
					}


					if (plugin.loaded) {
						status_el.append('<div class="">' + __('Loaded') + '</div>');
					} else {
						plug_el.addClass('load-fail');
						status_el.append('<div class="">' + __('Not loaded') + ': ' + __(plugin.load_issue) + '</div>');
					}

					if (plugin.update_status != null) {
						var install_btn = $(document.createElement('button'))
								.addClass('install_plugin')
								.data('domain', plugin.id)
								.prop('hidden', true)
								.text(__('Update'))
								.appendTo(status_el);

						if (plugin.update_status == 5) {
							install_btn.prop('hidden', false);
							install_btn.text(__('Reinstall'))
						} else if ([3, 4].includes(plugin.update_status)) {
							install_btn.prop('hidden', false);
						}
					}

					status_el.append('<button class="delete-plugin" data-id="' + plugin.id + '">' + __('Delete') + '</button>');

					/*
					if (plugin.enabled) {
						status_el.append('<button class="disable">' + __('Disable') + '</button>');
					} else {
						status_el.append('<button class="enable">' + __('Enable') + '</button>');
					}
					*/

					plug_el.append(main_info_el);
					plug_el.append(details_el);
					plug_el.append(status_el);

					list_el.append(plug_el);
				}
			} else {
				var list_el = $('<p>').text(__('No external plugins loaded.'));
			}
			wrap_el.append(list_el);
		});

		$(document).on('click', '.install_plugin', function (event) {
			var data = {
				method: 'domain',
				domain: $(this).data('domain'),
			};
			socket.emit('plugin_install', data);
		});

		$(document).on("click", '.delete-plugin', function (event) {
			plugin_to_delete = $(this).data('id');
			$.magnificPopup.open({
				items: {
					src: '#plugin-delete-confirm'
				},
				type: 'inline'
			});
		});

		$(document).on("click", '#delete-plugin', function (event) {
			$.magnificPopup.close();
			var data = {
				domain: plugin_to_delete,
			};
			socket.emit('plugin_delete', data);
		});

		$('#import_plugin_file').change(function(){
			if ($(this).prop('files')[0]) {
				$('#upload_plugin').prop('disabled', false);
			}
		});

		$(document).on('click', '#upload_plugin', function (event) {
			$.magnificPopup.close();
			var data = {
				method: 'upload',
				source_data: $('#import_plugin_file').prop('files')[0]
			};
			socket.emit('plugin_install', data);
			$('#import_plugin_file').val("");
			$('#upload_plugin').prop('disabled', true);
		});

		// Secondaries
		var secondary_options = [
			['callout', __('Callout'), [
				['time', __('Time')],
				['speed', __('Speed')],
				['both', __('Time & Speed')],
				['nameOnly', __('Name')],
				['none', __('None')]
			], 'none'],
			['distance', __('Distance'), 'numeric', 0],
			['queryInterval', __('Query Interval'), 'numeric', 0],
			['recEventsFlag', __('Receives Events'), 'boolean', false],
			['timeout', __('Timeout (seconds)'), 'numeric', 0],
			['event', __('Event'), 'text', ''],
			['effect', __('Effect'), 'text', ''],
			['text', __('Text'), 'text', ''],
			['toneDuration', __('Tone Duration'), 'numeric', 0],
			['toneFrequency', __('Tone Frequency'), 'numeric', 0],
			['toneVolume', __('Tone Volume'), 'numeric', 0],
			['toneType', __('Tone Type'), [
				['square', __('Square')],
				['sine', __('Sine')],
				['sawtooth', __('Sawtooth')],
				['triangle', __('Triangle')]
			], 'square'],
			['minRepeatSecs', __('Minimum Repeat (secs)'), 'numeric', 0]
		]
		secondary_options.sort((a, b) => a[1].localeCompare(b[1]));

		function display_secondary_ui(secondaries) {
			if ($('#secondary-ui').length) {
				var secondary_ui = $('#secondary-ui');
			} else {
				$('#secondary-setup').empty();
				var secondary_ui = $(document.createElement('ul'))
					.prop('id', 'secondary-ui')
					.addClass('settings-list')
					.appendTo('#secondary-setup');
			}

			if ($(`#secondary--new`).length) {
				$(`#secondary--new input`).val('');
			} else {
				var item_el = $(document.createElement('li'))
					.prop('id', `secondary--new`)
					.appendTo(secondary_ui);
				$(document.createElement('h4'))
					.text( __('New Secondary') )
					.appendTo(item_el);
				var fields = $(document.createElement('ol'))
					.addClass('form')
					.appendTo(item_el);
				var field = $(document.createElement('li'))
					.appendTo(fields);
				$(document.createElement('label'))
					.addClass('label-block')
					.text( __('Address') )
					.appendTo(field);
				$(document.createElement('input'))
					.prop('type', 'text')
					.addClass('set-secondary-config')
					.data('property', 'address')
					.appendTo(field);
			}

			secondary_ui.children('li').not('#secondary--new').addClass('flagged');

			for (var i in secondaries) {
				var secondary = secondaries[i];

				if ($(`#secondary--${i}`).length) {
					var item_el = $(`#secondary--${i}`)
						.removeClass('flagged');
					var address_field = item_el.find('.set-secondary-address');
					var mode_field = item_el.find('.set-secondary-mode');
					var new_field = item_el.find('.set-secondary-dynamic-new-key');
					var fields = item_el.children('ol');
				} else {
					var item_el = $(document.createElement('li'))
						.prop('id', `secondary--${i}`)
						.appendTo(secondary_ui);
					$(document.createElement('h4'))
						.text( `${__('Secondary')} ${parseInt(i)+1}` )
						.appendTo(item_el);
					var fields = $(document.createElement('ol'))
						.addClass('form')
						.appendTo(item_el);

					var field = $(document.createElement('li'))
						.appendTo(fields);
					$(document.createElement('label'))
						.addClass('label-block')
						.text( __('Address') )
						.appendTo(field);
					var address_field = $(document.createElement('input'))
						.prop('type', 'text')
						.addClass('set-secondary-config')
						.addClass('set-secondary-address')
						.appendTo(field);

					var field = $(document.createElement('li'))
						.appendTo(fields);
					$(document.createElement('label'))
						.addClass('label-block')
						.text( __('Mode') )
						.appendTo(field);
					var mode_field = $(document.createElement('select'))
						.addClass('set-secondary-config')
						.addClass('set-secondary-mode')
						.appendTo(field);
					$(document.createElement('option'))
						.prop('value', 'split')
						.text( __('Split') )
						.appendTo(mode_field);
					$(document.createElement('option'))
						.prop('value', 'mirror')
						.text( __('Mirror') )
						.appendTo(mode_field);
					$(document.createElement('option'))
						.prop('value', 'action')
						.text( __('Action') )
						.appendTo(mode_field);

					var new_field = $(document.createElement('li'))
						.appendTo(fields);
					$(document.createElement('label'))
						.addClass('label-block')
						.text( __('New Key') )
						.appendTo(new_field);
					var select_el = $(document.createElement('select'))
						.addClass('set-secondary-config')
						.addClass('set-secondary-dynamic-new-key')
						.appendTo(new_field);
					secondary_options_els(select_el);
				}
				address_field.val(secondary.address);
				if (secondary.mode) {
					mode_field.val(secondary.mode);
				} else {
					mode_field.val('split');
				}
				new_field.val();

				display_secondary_dynamic_field_ui(secondary, fields);
			}
			secondary_ui.find('li.flagged').remove();
		}

		function secondary_options_els (select_el) {
			$(document.createElement('option'))
				.text( `- ${__('Select Key')} -` )
				.prop('value', '')
				.appendTo(select_el);

			for (var idx in secondary_options) {
				$(document.createElement('option'))
					.text( secondary_options[idx][1] )
					.prop('value', secondary_options[idx][0])
					.appendTo(select_el);
			}
		}

		function display_secondary_dynamic_field_ui(fields, el) {
			els = el.children('.dynamic');

			els.addClass('flagged');

			var index = 0;
			for (var i in fields) {
				if (i != 'address' && i != 'mode') {
					var field = fields[i];

					if (els.length > index) {
						var field_el = $(els[index]);
						var key_el = field_el.children('.set-secondary-dynamic-key');
						var value_el = field_el.children('.set-secondary-dynamic-input');
						var value_select_el = field_el.children('.set-secondary-dynamic-select');
					} else {
						var field_el = $(document.createElement('li'))
							.addClass('dynamic')
							.appendTo(el);
						var key_el = $(document.createElement('label'))
							.addClass('label-block')
							.addClass('set-secondary-dynamic-key')
							.appendTo(field_el);

						$(document.createElement('button'))
							.addClass('delete-secondary-dynamic-key')
							.addClass('btn-danger')
							.html('&#215;')
							.appendTo(field_el);
						var value_el = $(document.createElement('input'))
							.prop('type', 'number')
							.prop('step', 'any')
							.addClass('set-secondary-config')
							.addClass('set-secondary-dynamic-value')
							.addClass('set-secondary-dynamic-input')
							.appendTo(field_el);
						var value_select_el = $(document.createElement('select'))
							.addClass('set-secondary-config')
							.addClass('set-secondary-dynamic-value')
							.addClass('set-secondary-dynamic-select')
							.appendTo(field_el);
					}

					field_el.removeClass('flagged');

					opt = secondary_options.find(obj => {return obj[0] == i});
					if (opt) {
						key_el.text( opt[1] );
						if (opt[2] == 'numeric') {
							value_el
								.prop('hidden', false)
								.prop('type', 'number')
								.data('key', i)
								.val(field);
							value_select_el
								.prop('hidden', true)
								.data('key', null)
								.val(null);
						} else if ( opt[2] == 'boolean' ){
							value_select_el.empty();
							$(document.createElement('option'))
								.prop('value', 1)
								.text(__('True'))
								.appendTo(value_select_el)
							$(document.createElement('option'))
								.prop('value', 0)
								.text(__('False'))
								.appendTo(value_select_el)
							value_el
								.prop('hidden', true)
								.data('key', null)
								.val(null);
							value_select_el
								.prop('hidden', false)
								.data('key', i);
							if (field === true) {
								value_select_el.val(1);
							} else if (field === false) {
								value_select_el.val(0);
							} else {
								value_select_el.val(null);
							}
						} else if ( Array.isArray(opt[2]) ){
							value_select_el.empty();
							for (var o in opt[2]) {
								$(document.createElement('option'))
									.prop('value', opt[2][o][0])
									.text( opt[2][o][1] )
									.appendTo(value_select_el);
							}
							value_el
								.prop('hidden', true)
								.data('key', null)
								.val(null);
							value_select_el
								.prop('hidden', false)
								.data('key', i)
								.val(field);
						} else {
							// text
							value_el
								.prop('hidden', false)
								.prop('type', 'text')
								.data('key', i)
								.val(field);
							value_select_el
								.prop('hidden', true)
								.data('key', null)
								.val(null);
						}
					} else {
						// text
						key_el.text( i );
						value_el
							.prop('hidden', false)
							.prop('type', 'text')
							.data('key', i)
							.val(field);
						value_select_el
							.prop('hidden', true)
							.data('key', null)
							.val(null);
					}
					index++;
				}
			}
			els.children('.flagged').remove();
		}

		$(document).on('change', '.set-secondary-config', function (event) {
			set_secondary_config();
		});

		$(document).on('click', '.delete-secondary-dynamic-key', function (event) {
			$(this).siblings('.set-secondary-dynamic-value').data('key', null);
			set_secondary_config();
		});

		function set_secondary_config() {
			var secondaries = [];
			$('#secondary--new').find('input').each(function(){
				if ($(this).val()) {
					secondaries.push({
						address: $(this).val()
					});
					$(this).empty();
				}
			});

			$('#secondary-ui').children().each(function(){
				var values = {};
				secondary_el = $(this);

				var addr = secondary_el.find('.set-secondary-address')
				if (addr) {
					values.address = addr.val();
				}

				var mode = secondary_el.find('.set-secondary-mode')
				if (mode) {
					values.mode = mode.val();
				}

				secondary_el.find('.set-secondary-dynamic-new-key').each(function(){
					key_el = $(this);
					key = key_el.val();
					if (key) {
						opt = secondary_options.find(obj => {return obj[0] == key});
						if (opt) {
							values[key] = opt[3];
						} else {
							values[key] = null;
						}
						key_el.val('');
					}
				});

				secondary_el.find('.set-secondary-dynamic-value').each(function(){
					key = $(this).data('key');
					if (key) {
						opt = secondary_options.find(obj => {return obj[0] == key});
						if (opt) {
							if (opt[2] == 'numeric') {
								value = Number($(this).val());
							} else if ( opt[2] == 'boolean' ){
								if ($(this).val() == '1') {
									value = true;
								} else if ($(this).val() == '0') {
									value = false;
								} else {
									value = null;
								}
							} else if ( Array.isArray(opt[2]) ){
								value = $(this).val();
							} else {
								value = $(this).val();
							}
						} else {
							value = $(this).val();
						}
						values[key] = value;
					}
				})

				if (values?.address) {
					secondaries.push(values);
				}
			});

			var data = {
				section: 'GENERAL',
				key: 'SECONDARIES',
				value: secondaries
			};
			socket.emit('set_config', data);

			socket.emit('load_data', {
				'load_types': [{
					'type': 'config',
					'value': {
						'GENERAL': ['SECONDARIES']
					}
				}]
			});
		};

		// Sensors
		function display_sensors_ui(sensors) {
			if ($('#sensor-ui').length) {
				var sensor_ui = $('#sensor-ui');
			} else {
				$('#sensor-setup').empty();
				var sensor_ui = $(document.createElement('ul'))
					.prop('id', 'sensor-ui')
					.addClass('settings-list')
					.appendTo('#sensor-setup');
			}

			if ($(`#sensor--new`).length) {
				$(`#sensor--new input`).val('');
			} else {
				var item_el = $(document.createElement('li'))
					.prop('id', `sensor--new`)
					.appendTo(sensor_ui);
				$(document.createElement('h4'))
					.text( __('New Sensor') )
					.appendTo(item_el);
				var fields = $(document.createElement('ol'))
					.addClass('form')
					.appendTo(item_el);
				var field = $(document.createElement('li'))
					.appendTo(fields);
				$(document.createElement('label'))
					.addClass('label-block')
					.text( __('Address') )
					.appendTo(field);
				$(document.createElement('input'))
					.prop('type', 'text')
					.addClass('set-sensor-config')
					.data('property', 'address')
					.appendTo(field);
			}

			sensor_ui.children('li').not('#sensor--new').addClass('flagged');

			var index = 1;
			for (var key in sensors) {
				var sensor = sensors[key];

				if ($(`#sensor--${index}`).length) {
					var item_el = $(`#sensor--${index}`)
						.removeClass('flagged');
					var address_field = item_el.find('.set-sensor-address');
					var new_field = item_el.find('.set-sensor-dynamic-new-key');
					var fields = item_el.children('ol');
				} else {
					var item_el = $(document.createElement('li'))
						.prop('id', `sensor--${index}`)
						.appendTo(sensor_ui);
					$(document.createElement('h4'))
						.text( `${__('Sensor')} ${index}` )
						.appendTo(item_el);
					var fields = $(document.createElement('ol'))
						.addClass('form')
						.appendTo(item_el);

					var field = $(document.createElement('li'))
						.appendTo(fields);
					$(document.createElement('label'))
						.addClass('label-block')
						.text( __('Address') )
						.appendTo(field);
					var address_field = $(document.createElement('input'))
						.prop('type', 'text')
						.addClass('set-sensor-config')
						.addClass('set-sensor-address')
						.appendTo(field);

					var new_field = $(document.createElement('li'))
						.appendTo(fields);
					$(document.createElement('label'))
						.addClass('label-block')
						.text( __('New Key') )
						.appendTo(new_field);
					$(document.createElement('input'))
						.prop('type', 'text')
						.prop('placeholder', __('key') )
						.addClass('set-sensor-config')
						.addClass('set-sensor-dynamic-key')
						.addClass('set-sensor-dynamic-new-key')
						.appendTo(new_field);
				}
				address_field.val(key);
				new_field.val();

				display_sensor_dynamic_field_ui(sensor, fields);
				index++;
			}
			sensor_ui.find('li.flagged').remove();

		}

		function display_sensor_dynamic_field_ui(fields, el) {
			els = el.children('.dynamic');

			els.addClass('flagged');

			var index = 0;
			for (var key in fields) {
				var value = fields[key];

				if (els.length > index) {
					var field_el = $(els[index]);
					var key_el = field_el.children('.set-sensor-dynamic-key');
					var value_el = field_el.children('.set-sensor-dynamic-value');
				} else {
					var field_el = $(document.createElement('li'))
						.addClass('dynamic')
						.appendTo(el);
					var key_el = $(document.createElement('input'))
						.prop('type', 'text')
						.addClass('label-block')
						.addClass('set-sensor-config')
						.addClass('set-sensor-dynamic-key')
						.appendTo(field_el);
					var value_el = $(document.createElement('input'))
						.prop('type', 'text')
						.addClass('set-sensor-config')
						.addClass('set-sensor-dynamic-value')
						.appendTo(field_el);
				}
				field_el.removeClass('flagged');
				key_el.val(key)
				value_el.val(value)
				index++;
			}
			els.children('.flagged').remove();
		}

		$(document).on('change', '.set-sensor-config', function (event) {
			var sensors = {};
			$('#sensor--new').find('input').each(function(){
				if ($(this).val()) {
					sensors[$(this).val()] = {};
					$(this).empty();
				}
			});

			$('#sensor-ui').children().not('#sensor--new').each(function(){
				var values = {};
				sensor_el = $(this);

				var addr = sensor_el.find('.set-sensor-address')?.val();
				if (addr) {
					sensor_el.find('.set-sensor-dynamic-key').each(function(){
						key_el = $(this);
						value_el = key_el.siblings('.set-sensor-dynamic-value')
						if (key_el.val()) {
							if (value_el.length) {
								values[key_el.val()] = (value_el.val());
							} else {
								values[key_el.val()] = null;
								key_el.val('');
							}
						}
					})

					sensors[addr] = values;
				}
			});

			var data = {
				section: 'SENSORS',
				value: sensors
			};
			socket.emit('set_config_section', data);

			socket.emit('load_data', {
				'load_types': [{
					'type': 'config',
					'value': {
						'SENSORS': []
					}
				}]
			});
		});

		$(document).on('click', '.datadir-handler', function (event) {
			socket.emit('datadir_handler', {'method': $(this).data('method')});
		});
	});

</script>
{% endblock %} {% block content %}
<main class="page-settings">

<div class="server-messages" id="server_messages">
	{% if server_messages %}
		{{ server_messages | safe }}
	{% endif %}
</div>

<div id="migrate_confirm" class="priority-message-interrupt mfp-hide popup">
	<h2>{{ __('Alert') }}</h2>
	<div class="popup-content">
		<p>{{ __('User data will be migrated and the server will restart. Are you sure?') }}</p>
		<p><button class="datadir-handler" data-method="migrate">{{ __('Migrate Data') }}</button>
			<button class="cancel">{{ __('Cancel') }}</button></p>
	</div>
</div>

<!--Frequency Setup-->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Frequency Setup') }}</h2>
	</div>
	<div class="panel-content full-width">
		<div class="control-set">
			<label for="set_profile">{{ __('Profile') }}:</label>
			<select id="set_profile">
				<option>{{ __('Loading...') }}</option>
			</select>
			<button id="add_profile">+ {{ __('Add Profile') }}</button>
			<button class="btn-danger" id="delete_profile">&#215; {{ __('Remove') }}</button>
		</div>

		<ol class="form">
			<li>
				<div class="label-block">
					<label for="set_profile_name">{{ __('Name') }}</label>
				</div>
				<input type="text" id="set_profile_name">
			</li>
		</ol>
		<p class="form-note">{{ __('Stores frequency settings and sensor tuning values.') }}</p>

		<!--Apply preset-->
		<div class="control-set">
			{{ __('Preset') }}:
			<button class="set_frequency_preset" data-preset="All-N1">{{ __('Apply Node 1') }}</button>
			<button class="set_frequency_preset" data-preset="RB-4">{{ __('R1367') }}</button>
			<button class="set_frequency_preset" data-preset="IMD5C">{{ __('IMD5C') }}</button>
			<button class="set_frequency_preset" data-preset="IMD6C">{{ __('IMD6C') }}</button>
			<button class="set_frequency_preset" data-preset="RB-8">{{ __('Raceband 8') }}</button>
		</div>

		<div class="node-list">
			{% for node in range(num_nodes) %}
				<div class="node" data-node="{{ node }}">
					{% if vrx_enabled %}
						<div class="vrx-header"></div>
					{% endif %}
					<h3><label for="set_freq_node_{{ node }}">{{ __('Node') }} {{ node + 1 }}</label></h3>
					<select class="frequency_table" id="f_table_{{ node }}" data-node="{{ node }}"></select>
					<label for="s_channel_{{ node }}" class="screen-reader-text">Frequency</label>
					<input type="number" id="s_channel_{{ node }}" class="set_frequency" data-node="{{ node }}" min="5000" max="6001">
				</div>
			{% endfor %}
		</div>
		<div class="control-set" id="imd_rating_label"></div>
		<div class="control-set vrx-warning"></div>
	</div>
</div>

<!--Sensor Tuning-->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Sensor Tuning') }}</h2>
	</div>
	<div class="panel-content full-width">
		<ul class="graph-key">
			<li><span style="background-color: hsl(214, 53%, 60%)"></span> {{ __('RSSI') }}</li>
			<li><span style="background-color: hsl(8.2, 86.5%, 53.7%)"></span> {{ __('EnterAt') }}</li>
			<li><span style="background-color: hsl(25, 85%, 55%)"></span> {{ __('ExitAt') }}</li>
		</ul>
		<div class="node-list">
			{% for node in range(num_nodes) %}
			<div class="node" data-node="{{ node }}">
				<h3>{{ __('Node') }} {{ node + 1 }}</h3>
				<div class="channel-block" data-node="{{ node }}"><span class="ch"></span> <span class="fr"></span></div>
				<div class="rssi-graph" data-node="{{ node }}">
					<button class="pause_graph" data-node="{{ node }}"><svg height="1em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><title>Pause</title><circle cx="8" cy="8" r="7.6" opacity=".8"/><path fill="#fff" d="M3.7 3.7H7v8.7H3.7z"/><path fill="#fff" d="M9 3.7h3.3v8.7H9z"/></svg></button>
					<canvas id="rssi-graph-{{ node }}">
					</canvas>
				</div>
				<div class="crossing crossing_flag_{{ node }}">{{ __('Clear') }}</div>
				<div class="node-controls">
					<div class="enter-exit-control">
						<label for="set_enter_at_level_{{ node }}">{{ __('EnterAt') }}</label>
						<input type="number" id="set_enter_at_level_{{ node }}" class="set_enter_at_level" data-node="{{ node }}" min="0" max="999">
						<button class="cap_enter_at_btn" data-node_index="{{ node }}" title="{{ __('Capture current RSSI') }}"><svg height="1em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill="currentColor" d="M0 14h16v2H0zM10 6V0H6v6H3l5 7 5-7z"/></svg></button>
					</div>

					<div class="enter-exit-control">
						<label for="set_exit_at_level_{{ node }}">{{ __('ExitAt') }}</label>
						<input type="number" id="set_exit_at_level_{{ node }}" class="set_exit_at_level" data-node="{{ node }}" min="0" max="999">
						<button class="cap_exit_at_btn" data-node_index="{{ node }}" title="{{ __('Capture current RSSI') }}"><svg height="1em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill="currentColor" d="M0 14h16v2H0zM10 6V0H6v6H3l5 7 5-7z"/></svg></button>
					</div>
				</div>
				<table>
					<tr class="datarow">
						<td>{{ __('RSSI') }}</td>
						<td>
							<span class="current_rssi_{{ node }}"></span>
						</td>
					</tr>
					<tr class="datarow">
						<td>{{ __('NodePeak') }}</td>
						<td>
							<span class="node_peak_rssi_{{ node }}"></span>
						</td>
					</tr>
					<tr class="datarow">
						<td>{{ __('NodeNadir') }}</td>
						<td>
							<span class="node_nadir_rssi_{{ node }}"></span>
						</td>
					</tr>
					<tr class="datarow">
						<td>{{ __('PassPeak') }}</td>
						<td>
							<span class="pass_peak_rssi_{{ node }}"></span>
						</td>
					</tr>
					<tr class="datarow">
						<td>{{ __('PassNadir') }}</td>
						<td>
							<span class="pass_nadir_rssi_{{ node }}"></span>
						</td>
					</tr>
					<tr class="datarow">
						<td>{{ __('PassCount') }}</td>
						<td>
							<span class="debug_pass_count_{{ node }}"></span>
						</td>
					</tr>
				</table>
				<div id="node_notice_{{ node }}"></div>
			</div>
			{% endfor %}
		</div>

		<!--Edit system tuning values-->
		<ol class="form">
			<li>
				<div class="label-block">
					<label for="set_calibrationMode">{{ __('Calibration Mode') }}</label>
				</div>
				<select id="set_calibrationMode" class="set-config" data-section="TIMING" data-key="calibrationMode">
					<option value="0">{{ __('Manual') }}</option>
					<option value="1">{{ __('Adaptive') }}</option>
				</select>
			</li>
			<li>
				<div class="label-block">
					<label for="set_start_thresh_lower_amount">{{ __('Start of race EnterAt/ExitAt lowering amount (percent)') }}</label>
				</div>
				<input type="number" id="set_start_thresh_lower_amount" min="0" max="200" value="{{ getOption('start_thresh_lower_amount') }}">
			</li>
			<li>
				<div class="label-block">
					<label for="set_start_thresh_lower_duration">{{ __('Start of race EnterAt/ExitAt lowering duration (seconds)') }}</label>
				</div>
				<input type="number" id="set_start_thresh_lower_duration" min="0" max="999" value="{{ getOption('start_thresh_lower_duration') }}">
			</li>
		</ol>

		<p class="form-note"><a href="/docs?d=Tuning%20Parameters.md">{{ __("View Calibration and Tuning Guide") }}</a></p>
	</div>
</div>

<!--Voice Settings-->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Audio Control') }}</h2>
	</div>
	<div class="panel-content">
		<p class="form-note">{{ __('Voice settings apply to this device only.') }}</p>
		<ol class="form">
			<li>
				<div class="label-block">
					<label for="set_voice_language">{{ __('Voice Select') }}</label>
				</div>
				<div id="voice_select"></div>
			</li>
			<li>
				<div class="label-block">
					<label for="set_voice_string_language">{{ __('Voice Language') }}</label>
				</div>
				<select id="set_voice_string_language">
					<option>{{ __('Loading...') }}</option>
				</select>
			</li>
			<li>
				<div class="label-block">
					{{ __('Voice Test') }}
				</div>
				<input type="text" id="voice_test_text" value="{{ getConfig('UI', 'timerName') }}">
				<button class="button" id="play_voice_test">&#9658;&#65038; <span class="screen-reader-text">{{ __('Play') }}</span></button>
			</li>
			<li>
				<div class="label-block">
					{{ __('Announcements') }}
				</div>
				<li>
					<div class="label-block">
						<label for="voice_callsign">{{ __('Pilot Callsign') }}</label>
					</div>
					<select id="voice_callsign">
						<option value="0">{{ __('Never') }}</option>
						<option value="2">{{ __('Only on Non-Team/Non-Co-op Races') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_lap_count">{{ __('Pilot Lap Number') }}</label>
					</div>
					<select id="voice_lap_count">
						<option value="0">{{ __('Never') }}</option>
						<option value="2">{{ __('Only on Non-Team/Non-Co-op Races') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_lap_time">{{ __('Pilot Lap Time') }}</label>
					</div>
					<select id="voice_lap_time">
						<option value="0">{{ __('Never') }}</option>
						<option value="2">{{ __('Only on Non-Team/Non-Co-op Races') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_race_timer">{{ __('Race Clock') }}</label>
					</div>
					<select id="voice_race_timer">
						<option value="0">{{ __('Never') }}</option>
						<option value="2">{{ __('Only on Fixed-time Races') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_team_lap_count">{{ __('Team/Co-op Lap Total') }}</label>
					</div>
					<select id="voice_team_lap_count">
						<option value="0">{{ __('Never') }}</option>
						<option value="1">{{ __('On Team/Co-op Races') }}</option>
						<option value="2">{{ __('On Team/Co-op Races (short call)') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_race_winner">{{ __('Race Winner') }}</label>
					</div>
					<select id="voice_race_winner">
						<option value="0">{{ __('Never') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				<li>
					<div class="label-block">
						<label for="voice_if_node_finished">{{ __('Laps After Pilot Done') }}</label>
					</div>
					<select id="voice_if_node_finished">
						<option value="0">{{ __('Never') }}</option>
						<option value="1">{{ __('Always') }}</option>
					</select>
				</li>
				{% if cluster_has_secondaries %}
				<li>
					<!--
					Split Timer:
					Pilot Name, Split ID, Split Time
					    0          0         0   ~>  000 = 0  :  None
					    1          0         0   ~>  001 = 1  :  Pilot Name
					    1          1         0   ~>  011 = 3  :  Pilot Name, Split ID
					    1          0         1   ~>  101 = 5  :  Pilot Name, Split Time
					    1          1         1   ~>  111 = 7  :  Pilot Name, Split ID, Split Time
					    0          1         0   ~>  010 = 2  :  Split ID
					    0          0         1   ~>  100 = 4  :  Split Time
					    0          1         1   ~>  110 = 6  :  Split ID, Split Time

					SPLMSK_PILOT_NAME = 0x01
					SPLMSK_SPLIT_ID = 0x02
					SPLMSK_SPLIT_TIME = 0x04
					-->
					<div class="label-block">
						<label for="voice_split_timer">{{ __('Secondary/Split Timer') }}</label>
					</div>
					<select id="voice_split_timer">
						<option value="0">{{ __('None') }}</option>
						<option value="1">{{ __('Pilot Name') }}</option>
						<option value="5">{{ __('Pilot Name, Split Value') }}</option>
						<option value="3">{{ __('Pilot Name, Split ID') }}</option>
						<option value="7">{{ __('Pilot Name, Split ID, Split Value') }}</option>
						<option value="2">{{ __('Split ID') }}</option>
						<option value="4">{{ __('Split Time') }}</option>
						<option value="6">{{ __('Split ID, Split Time') }}</option>
					</select>
				</li>
				{% endif %}
				<li>
					<div class="label-block">
						<label for="voice_race_leader">{{ __('Race Leader Pilot') }}</label>
					</div>
					<select id="voice_race_leader">
						<option value="0">{{ __('None') }}</option>
						<option value="1">{{ __('After 1 Second') }}</option>
						<option value="2">{{ __('After 2 Seconds') }}</option>
						<option value="3">{{ __('After 3 Seconds') }}</option>
						<option value="4">{{ __('After 4 Seconds') }}</option>
						<option value="5">{{ __('After 5 Seconds') }}</option>
						<option value="6">{{ __('After 6 Seconds') }}</option>
						<option value="7">{{ __('After 7 Seconds') }}</option>
						<option value="8">{{ __('After 8 Seconds') }}</option>
						<option value="9">{{ __('After 9 Seconds') }}</option>
						<option value="10">{{ __('After 10 Seconds') }}</option>
						<option value="11">{{ __('After 11 Seconds') }}</option>
						<option value="12">{{ __('After 12 Seconds') }}</option>
						<option value="13">{{ __('After 13 Seconds') }}</option>
						<option value="14">{{ __('After 14 Seconds') }}</option>
						<option value="15">{{ __('After 15 Seconds') }}</option>
						<option value="16">{{ __('After 16 Seconds') }}</option>
						<option value="17">{{ __('After 17 Seconds') }}</option>
						<option value="18">{{ __('After 18 Seconds') }}</option>
						<option value="19">{{ __('After 19 Seconds') }}</option>
					</select>
				</li>
			</li>
			<li>
				<div class="label-block">
					<label for="set_voice_volume">{{ __('Voice Volume') }}</label>
					<p class="desc">{{ __('Volume') }}: <span id="voice_volume_value"></span></p>
				</div>
				<input type="range" id="set_voice_volume" min="0" max="100">
			</li>
			<li>
				<div class="label-block">
					<label for="set_voice_rate">{{ __('Voice Rate') }}</label>
					<p class="desc">{{ __('Rate') }}: <span id="voice_rate_value"></span></p>
				</div>
				<input type="range" id="set_voice_rate" min="0" max="2.0" step="0.01">
			</li>
			<li>
				<div class="label-block">
					<label for="set_voice_pitch">{{ __('Voice Pitch') }}</label>
					<p class="desc">{{ __('Pitch') }}: <span id="voice_pitch_value"></span></p>
				</div>
				<input type="range" id="set_voice_pitch" min="0" max="2.0" step="0.01">
			</li>
			<li>
				<div class="label-block">
					<label for="set_tone_volume">{{ __('Tone Volume') }}</label>
					<p class="desc">{{ __('Volume') }}: <span id="tone_volume_value"></span></p>
				</div>
				<input type="range" id="set_tone_volume" min="0" max="100">
			</li>
			<li>
				<div class="label-block">
					{{ __('Indicator Beeps') }}
				</div>
				<ul>
					<li><label><input type="checkbox" id="beep_on_first_pass_button"> {{ __('On First Pass') }}</label></li>
					<li><label><input type="checkbox" id="beep_crossing_entered"> {{ __('Crossing Entered') }}</label></li>
					<li><label><input type="checkbox" id="beep_crossing_exited"> {{ __('Crossing Exited') }}</label></li>
					<li><label><input type="checkbox" id="beep_manual_lap_button"> {{ __('Manual Lap Button') }}</label></li>
					<li><label><input type="checkbox" id="beep_race_leader_lap"> {{ __('Race Leader Lap') }}</label></li>
					<li><label><input type="checkbox" id="beep_race_winner_declared"> {{ __('Race Winner Declared') }}</label></li>
					{% if cluster_has_secondaries %}
					<li><label><input type="checkbox" id="beep_cluster_connect"> {{ __('Secondary Timer Connect / Disconnect') }}</label></li>
					{% endif %}
					<li><label><input type="checkbox" id="use_mp3_tones"> {{ __('Use MP3 Tones instead of synthetic tones') }}</label></li>
				</ul>
			</li>
			<li>
				<div class="label-block">
					<label for="set_indicator_volume">{{ __('Indicator Beeps Volume') }}</label>
					<p class="desc">{{ __('Volume') }}: <span id="indicator_volume_value"></span></p>
				</div>
				<input type="range" id="set_indicator_volume" min="0" max="100">
			</li>
		</ol>
		<br>
		<div class="control-set">
			<div>
				<button class="button" id="export_audio_settings">{{ __('Export Audio Settings') }}</button> &nbsp;
				<button data-mfp-src="#audio_settings_defaults_confirm" class="open-mfp-popup">{{ __('Set Audio Settings to Defaults') }}</button>
			</div>
			<div>
				<label for="select_audio_import_file"><span style="font-weight:bold">{{ __('Select File to Import') }}: </span></label>
				<input type="file" id="select_audio_import_file" accept=".cfg" />
				<button id="import_audio_settings" class="btn-danger" disabled="disabled">{{ __('Import Audio Settings') }}</button>
			</div>
		</div>
		<div id="audio_settings_defaults_confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Confirm') }}</h2>
			<div class="popup-content">
				<p>{{ __('This will overwrite all audio settings. Are you sure?') }}</p>
				<p><button class="btn-danger" id="default_audio_settings">{{ __('Set Defaults') }}</button>
					<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>
	</div>
</div>

<!--Event Actions-->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Event Actions') }}</h2>
	</div>
	<div class="panel-content">
		<div id="actions" class="form">
		</div>

		<div class="control-set">
			<button class="button" id="add_action" disabled="disabled">{{ __('Add Action') }}</button>
		</div>
	</div>
</div>

<!--LED controls-->
{% if led_events_enabled %}
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('LED Events') }}</h2>
	</div>
	<div class="panel-content">
		<div id="LED-effect-setup"></div>
	</div>
</div>
{% endif %}

{% if led_enabled %}
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('LED Control') }}</h2>
	</div>
	<div class="panel-content">
		<div class="control-set">
			<button class="LED-off">{{ __('Turn Off') }}</button>
		</div>

		<div class="control-set">
			<button class="LED-color color-picker" data-rgb="#0022ff" style="background-color:#0022ff"></button>
			<button class="LED-color color-picker" data-rgb="#ff5500" style="background-color:#ff5500"></button>
			<button class="LED-color color-picker" data-rgb="#00ff22" style="background-color:#00ff22"></button>
			<button class="LED-color color-picker" data-rgb="#ff0055" style="background-color:#ff0055"></button>
			<button class="LED-color color-picker" data-rgb="#ddff00" style="background-color:#ddff00"></button>
			<button class="LED-color color-picker" data-rgb="#7700ff" style="background-color:#7700ff"></button>
			<button class="LED-color color-picker" data-rgb="#00ffdd" style="background-color:#00ffdd"></button>
			<button class="LED-color color-picker" data-rgb="#aaaaaa" style="background-color:#aaaaaa"></button>
		</div>

		<ol class="form">
			<li>
				<div class="label-block">
					<label for="set_led_brightness">{{ __('LED Brightness') }}</label>
					<p class="desc">{{ __('Level') }}: <span id="led_brightness_value"></span></p>
				</div>
				<input type="range" id="set_led_brightness" min="1" max="25">
			</li>
		</ol>

		<div id="LED-effects"></div>
	</div>
</div>
{% endif %}

<!--VRx Control-->
{% if vrx_enabled %}
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('VRx Control') }}</h2>
	</div>
	<div class="panel-content">
		<div id="vrx-control-setup"></div>

		<div class="control-set vrx-warning"></div>
	</div>
</div>
{% endif %}

<!-- Plugins -->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Plugins') }}</h2>
	</div>
	<div class="panel-content">
		<div class="control-set">
			<a href="#plugin-uploader" class="button-like open-mfp-popup">{{ __('Upload') }}</a>
			<a href="/plugins" class="button-like" disabled>{{ __('Browse Community Plugins (online only)') }}</a>
		</div>

		<div id="plugin-list">
			<p>{{ __('Loading...') }}</p>
		</div>

		<div id="plugin-uploader" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Upload Plugin') }}</h2>
			<div class="popup-content">
				<p><label for="import_plugin_file">{{ __('Plugin Zipfile') }} {{ __('Max 50MB') }}</label><br />
				<input type="file" id="import_plugin_file" /></p>

				<p><button id="upload_plugin" disabled="disabled">{{ __('Import Plugin') }}</button>
				<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>

		<div id="plugin-delete-confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Alert') }}</h2>
			<div class="popup-content">
				<p>{{ __('There is no undo available for this action. Restart is required.') }}</p>
				<p><button class="btn-danger" id="delete-plugin">{{ __('Delete') }}</button>
				<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>
	</div>
</div>

<!-- System -->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('System') }}</h2>
	</div>
	<div class="panel-content">
		<div class="control-set">
			{% if is_raspberry_pi %}
			<button data-mfp-src="#shutdown_confirm" class="btn-danger open-mfp-popup">{{ __('Shut Down') }}</button>
			<button data-mfp-src="#reboot_confirm" class="btn-danger open-mfp-popup">{{ __('Reboot') }}</button>
			{% endif %}
			<a href="#restart_confirm" class="btn-danger button-like open-mfp-popup">{{ __('Restart') }}</a>
			{% if Debug %}
			<button data-mfp-src="#kill_server_confirm" class="btn-danger open-mfp-popup">{{ __('Kill Server') }}</button>
			{% endif %}
			<a href="/hardwarelog" class="debug button-like">{{ __('Server Log') }}</a>
			<button id="download_logs">{{ __('Download Logs') }}</button>
			{% if node_fw_updatable %}
			<a href="/updatenodes" class="debug button-like">{{ __('Update Nodes') }}</a>
			{% endif %}
		</div>

		<div id="shutdown_confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Alert') }}</h2>
			<div class="popup-content">
				<p>{{ __('Shut down server hardware?') }}</p>
				<p><button class="btn-danger" id="shutdown_pi">{{ __('Shut Down') }}</button>
				<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>

		<div id="reboot_confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Alert') }}</h2>
			<div class="popup-content">
				<p>{{ __('Reboot server hardware?') }}</p>
				<p><button class="btn-danger" id="reboot_pi">{{ __('Reboot') }}</button>
				<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>

		<div id="kill_server_confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Alert') }}</h2>
			<div class="popup-content">
				<p>{{ __('Terminate RotorHazard server?') }}</p>
				<p><button class="btn-danger" id="kill_server">{{ __('Kill Server') }}</button>
				<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>

		<ol class="form">
			<li>
				<div class="label-block">
					<label for="set_admin_user">{{ __('Username') }}</label>
				</div>
				<input type="text" id="set_admin_user" class="set-config" data-section="SECRETS" data-key="ADMIN_USERNAME" value="{{ getConfig('SECRETS', 'ADMIN_USERNAME') }}">
			</li>
			<li>
				<div class="label-block">
					<label for="set_admin_password">{{ __('Password') }}</label>
					<p class="desc">{{ __('Default') }}: rotorhazard</p>
				</div>
				<input type="password" id="set_admin_password" class="set-config" data-section="SECRETS" data-key="ADMIN_PASSWORD" value="**********">
			</li>
			<li>
				<div class="label-block">
					<label for="set_language">{{ __('Language') }}</label>
				</div>
				<select id="set_language">
					<option>{{ __('Loading...') }}</option>
				</select>
			</li>
			<li>
				<div class="label-block">
					<label for="set_time_format">{{ __('Time Format') }}</label>
				</div>
				<input type="text" id="set_time_format" class="set-config" data-section="UI" data-key="timeFormat" value="{{ getConfig('UI', 'timeFormat') }}">
			</li>
			<li>
				<div class="label-block">
					<label for="set_time_format_phonetic">{{ __('Phonetic Time Format') }}</label>
				</div>
				<input type="text" id="set_time_format_phonetic" class="set-config" data-section="UI" data-key="timeFormatPhonetic" value="{{ getConfig('UI', 'timeFormatPhonetic') }}">
			</li>
			<li>
				<div class="label-block">
					<label for="set_timer_name">{{ __('Timer Name') }}</label>
				</div>
				<input type="text" id="set_timer_name" class="set-config" data-section="UI" data-key="timerName" value="{{ getConfig('UI', 'timerName') }}">
			</li>
			<li>
				<div class="label-block">
					<label for="set_timer_logo">{{ __('Timer Logo') }}</label>
					<p class="desc">{{ __('File path relative to <data>/shared/') }}</p>
				</div>
				<input type="text" id="set_timer_logo" class="set-config" data-section="UI" data-key="timerLogo" value="{{ getConfig('UI', 'timerLogo') }}" placeholder="group-logo.png">
			</li>
			<li>
				<div class="label-block">
					<label for="set_hue_primary">{{ __('Primary Hue') }}</label>
				</div>
				<input type="range" id="set_hue_primary" class="hue-control" data-section="UI" data-key="hue_0" value="{{ getConfig('UI', 'hue_0') }}" min="0" max="359">
			</li>
			<li>
				<div class="label-block">
					<label for="set_sat_primary">{{ __('Primary Saturation') }}</label>
				</div>
				<input type="range" id="set_sat_primary" class="sat-control" data-section="UI" data-key="sat_0" value="{{ getConfig('UI', 'sat_0') }}" min="0" max="100">
			</li>
			<li>
				<div class="label-block">
					<label for="set_hue_secondary">{{ __('Secondary Hue') }}</label>
				</div>
				<input type="range" id="set_hue_secondary" class="hue-control" data-section="UI" data-key="hue_1" value="{{ getConfig('UI', 'hue_1') }}" min="0" max="359">
			</li>
			<li>
				<div class="label-block">
					<label for="set_sat_secondary">{{ __('Secondary Saturation') }}</label>
				</div>
				<input type="range" id="set_sat_secondary" class="sat-control" data-section="UI" data-key="sat_1" value="{{ getConfig('UI', 'sat_1') }}" min="0" max="100">
			</li>
		</ol>

		<div class="control-set">
			<div class="swatch primary-color">{{ __('Primary Color') }}</div>
			<div class="swatch secondary-color">{{ __('Secondary Color') }}</div>
		</div>
	</div>
</div>

<!-- Cluster -->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Secondary Timers') }}</h2>
	</div>
	<div class="panel-content">
		<h3>{{ __('Cluster Status') }}</h3>
		<div id="cluster-status" class="control-set">
			<p>No cluster status available.</p>
		</div>

		<h3>{{ __('Settings') }}</h3>
		<div id="secondary-setup">
			{{ __('Loading...') }}
		</div>
	</div>
</div>

<!-- Sensors -->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Environment Sensors') }}</h2>
	</div>
	<div class="panel-content">
		<h3>{{ __('Environment Status') }}</h3>
		<div id="env-data-table" class="control-set">
			<p>No environment status available.</p>
		</div>
		<h3>{{ __('Settings') }}</h3>
		<div id="sensor-setup">
			{{ __('Loading...') }}
		</div>
	</div>
</div>

<!-- Save/Load Settings -->
<div class="panel collapsing">
	<div class="panel-header">
		<h2>{{ __('Backup/Restore Settings') }}</h2>
	</div>
	<div class="panel-content">
		<h3>{{ __('Current Server Settings') }}</h3>
		<div class="control-set">
			<button class="button" id="backup_settings">{{ __('Backup Settings') }}</button> &nbsp;
			<button class="button" id="download_settings">{{ __('Download Settings') }}</button> &nbsp;
			<button data-mfp-src="#reset_settings_to_defaults_confirm" class="open-mfp-popup">{{ __('Reset All Settings to Defaults') }}</button>
		</div>

		<h3>{{ __('Manage Files') }}</h3>
		<ol class="form">
			<li>
				<div class="label-block">
					<label for="cfg_files_list">{{ __('Saved Settings Files:') }}</label>
				</div>
				<select id="cfg_files_list" disabled="disabled">
					<option value="-">{{ __('No Saved Settings Files') }}</option>
				</select>
			</li>
		</ol>
		<div class="control-set">
			<button data-mfp-src="#settings_restore_confirm" class="open-mfp-popup" disabled="disabled">{{ __('Restore Settings File') }}</button> &nbsp;
			<button id="rename_settings_btn" disabled="disabled">{{ __('Rename Settings File') }}</button> &nbsp;
			<button data-mfp-src="#settings_delete_confirm" class="open-mfp-popup" disabled="disabled">{{ __('Delete Settings File') }}</button>
		</div>

		<div id="reset_settings_to_defaults_confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Alert') }}</h2>
			<div class="popup-content">
				<p>{{ __('All settings will be reset to default values and the server will restart. Are you sure?') }}</p>
				<p><button class="btn-danger" id="reset_cfg_file_to_defaults">{{ __('Reset Settings to Defaults') }}</button>
					<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>
		<div id="settings_restore_confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Alert') }}</h2>
			<div class="popup-content">
				<p>{{ __('All settings will be overwritten and the server will restart. Are you sure?') }}</p>
				<p><button class="btn-danger" id="restore_cfg_file">{{ __('Restore Settings') }}</button>
					<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>
		<div id="settings_rename_popup" class="mfp-hide popup">
			<h2>{{ __('Rename Settings File') }}</h2>
			<div class="popup-content">
				<p>
					<div class="label-block">
						<label for="new_cfg_file_name">{{ __('Enter New File Name:') }}</label>
					</div>
					<input type="text" id="new_cfg_file_name">
				</p>
				<p><button class="button" id="rename_cfg_file">{{ __('Rename File') }}</button>
					<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>
		<div id="settings_delete_confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Alert') }}</h2>
			<div class="popup-content">
				<p>{{ __('Deleted settings files are not recoverable. Are you sure?') }}</p>
				<p><button class="btn-danger" id="delete_cfg_file">{{ __('Delete File') }}</button>
					<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>
		<div id="settings_load_confirm" class="priority-message-interrupt mfp-hide popup">
			<h2>{{ __('Alert') }}</h2>
			<div class="popup-content">
				<p>{{ __('All settings will be overwritten and the server will restart. Are you sure?') }}</p>
				<p><button class="btn-danger" id="load_cfg_file">{{ __('Load Settings') }}</button>
					<button class="cancel">{{ __('Cancel') }}</button></p>
			</div>
		</div>

		<h3>{{ __('Import File') }}</h3>
		<ol class="form">
			<li>
				<div class="label-block">
					<label for="select_load_settings_file">{{ __('Select Settings File to Load') }}: </label>
				</div>
				<input type="file" id="select_load_settings_file" accept=".json" />
			</li>
		</ol>
		<div class="control-set">
			<button data-mfp-src="#settings_load_confirm" class="open-mfp-popup" disabled="disabled">{{ __('Load Settings') }}</button>
		</div>
	</div>
</div>

<!-- Custom UI -->
<div id="custom-ui"></div>

<p><a href="/advanced-settings">{{ __('Advanced Settings') }}</a>
</main>
{% endblock %}
